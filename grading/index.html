<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>ì±„ì  ê´€ë¦¬</title>
	<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script defer src="https://unpkg.com/mathlive"></script>
	<style>
		:root {
			--bg: #0f172a; --bg-card: #1e293b; --bg-elevated: #334155;
			--text: #f1f5f9; --text-sec: #94a3b8; --gray: #64748b;
			--primary: #818cf8; --green: #22c55e; --red: #ef4444;
			--yellow: #eab308; --teal: #14b8a6; --border: #334155;
			--radius: 14px;
		}
		* { margin:0; padding:0; box-sizing:border-box; }
		body { font-family:'Pretendard',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
		
		/* í—¤ë” */
		.top-bar { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:var(--bg-card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
		.top-bar h1 { font-size:17px; font-weight:700; }
		.top-bar-btn { background:none; border:none; color:var(--text-sec); font-size:18px; cursor:pointer; padding:6px; }

		/* íƒ­ */
		.tabs { display:flex; padding:8px 12px; gap:6px; background:var(--bg-card); border-bottom:1px solid var(--border); overflow-x:auto; }
		.tab-btn { padding:8px 16px; border:none; border-radius:20px; background:transparent; color:var(--text-sec); font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
		.tab-btn.active { background:var(--primary); color:#fff; }

		/* ì¹´ë“œ */
		.card { background:var(--bg-card); border-radius:var(--radius); padding:16px; margin:8px 12px; border:1px solid var(--border); }
		.card-title { font-size:14px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
		.card-title i { color:var(--primary); }

		/* ë²„íŠ¼ */
		.btn { padding:10px 20px; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; }
		.btn-primary { background:var(--primary); color:#fff; }
		.btn-primary:hover { opacity:0.9; }
		.btn-danger { background:var(--red); color:#fff; }
		.btn-sm { padding:6px 12px; font-size:12px; }
		.btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-sec); }

		/* ì…ë ¥ */
		.input { width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:var(--bg-elevated); color:var(--text); font-size:14px; outline:none; }
		.input:focus { border-color:var(--primary); }
		.form-label { font-size:12px; font-weight:600; color:var(--text-sec); margin-bottom:6px; display:block; }
		.form-group { margin-bottom:14px; }

		/* ë¦¬ìŠ¤íŠ¸ */
		.list-item { display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-elevated); border-radius:var(--radius); margin-bottom:8px; cursor:pointer; transition:all 0.2s; border:1px solid transparent; }
		.list-item:hover { border-color:var(--primary); }
		.list-item-icon { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
		.list-item-info { flex:1; min-width:0; }
		.list-item-title { font-size:14px; font-weight:600; }
		.list-item-sub { font-size:12px; color:var(--text-sec); margin-top:2px; }
		.list-item-badge { padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700; }

		/* ìƒíƒœ ë±ƒì§€ */
		.badge-confirmed { background:rgba(34,197,94,0.15); color:var(--green); }
		.badge-review { background:rgba(234,179,8,0.15); color:var(--yellow); }
		.badge-grading { background:rgba(129,140,248,0.15); color:var(--primary); }
		.badge-failed { background:rgba(239,68,68,0.15); color:var(--red); }
		.badge-regrading { background:rgba(129,140,248,0.15); color:var(--primary); }

		/* ìƒì„¸ ìƒíƒœ ë°°ë„ˆ */
		.detail-status-banner { display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:var(--radius); margin-bottom:10px; font-size:13px; line-height:1.5; }
		.detail-status-banner.status-grading { background:rgba(129,140,248,0.1); border:1px solid rgba(129,140,248,0.3); color:var(--primary); }
		.detail-status-banner.status-failed { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:var(--red); }
		.detail-status-banner.status-review { background:rgba(234,179,8,0.1); border:1px solid rgba(234,179,8,0.3); color:var(--yellow); }
		.detail-status-banner .status-icon { font-size:20px; flex-shrink:0; }
		.detail-status-banner .status-text { flex:1; }
		.detail-status-banner .status-text strong { display:block; margin-bottom:2px; }
		.detail-progress-bar { width:100%; height:6px; background:rgba(129,140,248,0.15); border-radius:3px; margin-top:8px; overflow:hidden; }
		.detail-progress-fill { height:100%; background:var(--primary); border-radius:3px; transition:width 0.3s ease; }
		@keyframes pulse-opacity { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
		.status-pulse { animation: pulse-opacity 1.5s ease-in-out infinite; }

		/* ì ìˆ˜ ì¹´ë“œ */
		.score-card { text-align:center; padding:20px; background:var(--bg-elevated); border-radius:var(--radius); }
		.score-big { font-size:36px; font-weight:800; color:var(--primary); }
		.score-sub { font-size:13px; color:var(--text-sec); margin-top:4px; }

		/* ë¬¸í•­ ê·¸ë¦¬ë“œ */
		.question-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(50px,1fr)); gap:6px; }
		.q-cell { width:100%; aspect-ratio:1; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; cursor:pointer; transition:all 0.2s; }
		.q-correct { background:rgba(34,197,94,0.2); color:var(--green); border:2px solid var(--green); }
		.q-wrong { background:rgba(239,68,68,0.2); color:var(--red); border:2px solid var(--red); }
		.q-uncertain { background:rgba(234,179,8,0.2); color:var(--yellow); border:2px solid var(--yellow); }
		.q-unanswered { background:rgba(100,116,139,0.15); color:var(--gray); border:2px dashed var(--gray); }

		/* ìº”ë²„ìŠ¤ ë„êµ¬ ë°” */
		.canvas-toolbar { display:flex; flex-wrap:wrap; gap:6px; padding:10px 12px; background:var(--bg-card); border-top:1px solid var(--border); position:sticky; bottom:0; z-index:50; }
		.tool-btn { width:38px; height:38px; border-radius:10px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; }
		.tool-btn.active { border-color:var(--primary); color:var(--primary); background:rgba(129,140,248,0.15); }
		.color-dot { width:20px; height:20px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
		.color-dot.active { border-color:#fff; box-shadow:0 0 0 2px var(--primary); }
		.size-slider { width:80px; accent-color:var(--primary); }

		/* ëª¨ë‹¬ */
		.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; display:none; align-items:center; justify-content:center; }
		.modal-overlay.show { display:flex; }
		.modal-box { background:var(--bg-card); border-radius:var(--radius); padding:20px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; }
		.modal-title { font-size:16px; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; }

		/* í†µê³„ */
		.stat-row { display:flex; gap:8px; margin-bottom:8px; }
		.stat-item { flex:1; text-align:center; padding:12px; background:var(--bg-elevated); border-radius:var(--radius); }
		.stat-num { font-size:20px; font-weight:800; }
		.stat-label { font-size:11px; color:var(--text-sec); margin-top:4px; }

		/* ë¡œë”© */
		.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; margin:20px auto; }
		@keyframes spin { to { transform:rotate(360deg); } }

		/* ë¹ˆ ìƒíƒœ */
		.empty-state { text-align:center; padding:40px 20px; color:var(--text-sec); }
		.empty-state i { font-size:40px; margin-bottom:12px; opacity:0.4; }
		.empty-state p { font-size:14px; }

		/* ë°˜ì‘í˜• */
		@media (max-width: 480px) {
			.tabs { padding:6px 8px; }
			.tab-btn { padding:6px 12px; font-size:12px; }
			.card { margin:6px 8px; padding:12px; }
		}

		/* í† ìŠ¤íŠ¸ */
		.g-toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:12px 24px; border-radius:12px; font-size:14px; font-weight:600; z-index:9999; animation:fadeSlide 0.3s ease; }
		.g-toast.success { background:var(--green); color:#fff; }
		.g-toast.error { background:var(--red); color:#fff; }
		.g-toast.info { background:var(--primary); color:#fff; }
		@keyframes fadeSlide { from { opacity:0; transform:translateX(-50%) translateY(-10px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }

	/* ì´ë¯¸ì§€ ë·°ì–´ */
	.image-viewer { position:relative; width:100%; overflow:auto; background:#000; border-radius:var(--radius); min-height:200px; max-height:70vh; }
	.image-viewer img { display:block; transform-origin:0 0; transition:transform 0.15s ease; }
	.image-viewer canvas { position:absolute; top:0; left:0; transform-origin:0 0; cursor:crosshair; }
	.image-viewer .empty-image { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:200px; color:var(--text-sec); gap:8px; }
	.image-viewer .empty-image i { font-size:32px; opacity:0.3; }
	.image-viewer .empty-image p { font-size:13px; }

	/* êµì¬ ìƒì„¸ - ë¬¸ì œ í…Œì´ë¸” (gridë¡œ í—¤ë”-í–‰ ì •ë ¬ ë³´ì¥) */
	.kd-table-header, .kd-row {
		display:grid;
		grid-template-columns: 64px 56px 1fr 36px;
		gap:8px;
		align-items:center;
		padding:6px 10px;
	}
	.kd-table-header { background:var(--bg); border-radius:8px; margin-bottom:6px; font-size:11px; font-weight:700; color:var(--text-sec); padding:8px 10px; }
	.kd-col-num, .kd-col-type, .kd-col-answer { text-align:center; }
	.kd-col-answer { text-align:left; }
	.kd-row { border-bottom:1px solid var(--border); transition:background 0.1s; }
	.kd-row:hover { background:rgba(129,140,248,0.04); }
	.kd-row .kd-num-input { width:100%; box-sizing:border-box; text-align:center; font-weight:700; padding:7px 6px; border:1px solid var(--border); border-radius:8px; background:var(--bg-elevated); color:var(--text); font-size:13px; outline:none; }
	.kd-row .kd-num-input:focus { border-color:var(--primary); }
	.kd-type-badge { display:inline-flex; align-items:center; justify-content:center; min-width:40px; padding:4px 6px; border-radius:6px; font-size:10px; font-weight:700; cursor:pointer; user-select:none; transition:all 0.15s; border:1px solid transparent; line-height:1; }
	.kd-type-badge:hover { filter:brightness(1.15); transform:scale(1.05); }
	.kd-type-badge.type-mc { background:rgba(100,116,139,0.15); color:var(--text-sec); }
	.kd-type-badge.type-short { background:rgba(20,184,166,0.15); color:#14b8a6; border-color:rgba(20,184,166,0.3); }
	.kd-type-badge.type-essay { background:rgba(129,140,248,0.15); color:var(--primary); border-color:rgba(129,140,248,0.3); }
	.kd-row .kd-answer-display { font-size:15px; }
	.kd-row .kd-del-btn { width:36px; height:36px; border:none; background:none; color:var(--gray); cursor:pointer; font-size:14px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
	.kd-row .kd-del-btn:hover { color:var(--red); background:rgba(239,68,68,0.1); }
	.kd-row.kd-type-short { background:rgba(20,184,166,0.04); border-left:3px solid #14b8a6; }
	.kd-row.kd-type-essay { background:rgba(129,140,248,0.06); border-left:3px solid var(--primary); }

	/* ìˆ˜ì‹ í¸ì§‘ê¸° íŒì—… (MathLive) */
	.math-editor-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1200; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.15s; }
	.math-editor-overlay.show { opacity:1; }
	.math-editor { background:var(--bg-elevated); border-radius:16px; width:min(560px,94vw); max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.4); }
	.math-editor-header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px 10px; border-bottom:1px solid var(--border); }
	.math-editor-header h3 { font-size:15px; font-weight:700; margin:0; }
	.math-editor-body { padding:16px 18px; }
	#math-editor-field { width:100%; box-sizing:border-box; font-size:22px; padding:12px 14px; border-radius:10px; border:1px solid var(--border); --hue:230; --caret-color:var(--primary); --keyboard-zindex:1300; background:var(--bg); color:var(--text); }
	#math-editor-field:focus-within { border-color:var(--primary); box-shadow:0 0 0 3px rgba(129,140,248,0.15); }
	.math-nav-bar { margin-top:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
	.math-nav-btns { display:flex; gap:4px; align-items:center; }
	.math-nav-btn { padding:4px 8px; font-size:12px; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text-sec); cursor:pointer; transition:all 0.12s; display:flex; align-items:center; gap:3px; }
	.math-nav-btn:hover { border-color:var(--primary); color:var(--primary); background:rgba(129,140,248,0.08); }
	math-virtual-keyboard { z-index:1300 !important; }
	.ML__popover, .ML__menu-container, .ML__menu, .ML__context-menu { z-index:1300 !important; }
	.kd-answer-display { min-height:36px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--border); transition:border-color 0.15s; overflow:hidden; font-size:15px; }
	.kd-answer-display:hover { border-color:var(--primary); }
	math-field.kd-math-ro { display:inline-block; width:auto !important; min-height:auto !important; border:none !important; background:transparent !important; padding:0 !important; box-shadow:none !important; font-size:16px; pointer-events:none; --hue:230; }

	/* êµì¬ ìƒì„¸ - 2ë‹¨ ë ˆì´ì•„ì›ƒ */
	.kd-split { display:flex; gap:12px; align-items:flex-start; }
	.kd-split-left { flex:1; min-width:0; position:sticky; top:60px; max-height:calc(100vh - 80px); overflow:hidden; }
	.kd-split-right { flex:1; min-width:0; max-height:calc(100vh - 80px); overflow-y:auto; }
	.kd-split-right::-webkit-scrollbar { width:6px; }
	.kd-split-right::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
	@media (max-width:768px) {
		.kd-split { flex-direction:column; }
		.kd-split-left { position:static; max-height:50vh; }
		.kd-split-right { max-height:none; }
	}

	/* êµì¬ ìƒì„¸ - í˜ì´ì§€ ì´ë¯¸ì§€ */
	.kd-pages-wrap { overflow:hidden; max-height:calc(100vh - 220px); border-radius:8px; position:relative; cursor:grab; background:var(--bg); }
	.kd-pages-wrap:active { cursor:grabbing; }
	.kd-page-img { width:100%; border-radius:8px; border:1px solid var(--border); display:block; transform-origin:0 0; will-change:transform; user-select:none; -webkit-user-drag:none; }

	/* íŒŒì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ */
	.file-drop-zone { border:2px dashed var(--border); border-radius:12px; padding:24px 16px; text-align:center; cursor:pointer; transition:all 0.2s; background:var(--bg); }
	.file-drop-zone:hover { border-color:var(--primary); background:rgba(129,140,248,0.04); }
	.file-drop-zone.drag-over { border-color:var(--primary); background:rgba(129,140,248,0.1); transform:scale(1.01); }
	.file-drop-zone.has-file { border-style:solid; border-color:var(--primary); background:rgba(129,140,248,0.06); }

	/* í•™ìƒ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ */
	.stu-drop-item { padding:10px 14px; cursor:pointer; font-size:13px; border-bottom:1px solid var(--border); transition:background 0.1s; }
	.stu-drop-item:last-child { border-bottom:none; }
	.stu-drop-item:hover { background:rgba(129,140,248,0.15); }
	.stu-drop-item .stu-grade { font-size:11px; color:var(--text-sec); margin-left:6px; }
	.stu-tag { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:16px; background:rgba(129,140,248,0.15); color:var(--primary); font-size:12px; font-weight:600; }
	.stu-tag button { background:none; border:none; color:var(--text-sec); cursor:pointer; font-size:11px; padding:0 2px; line-height:1; }
	.stu-tag button:hover { color:var(--red); }

	/* ë‹¬ë ¥ */
	.cal-container { display:flex; flex-direction:column; gap:12px; padding:8px 12px; min-height:0; }
	.cal-left { background:var(--bg-card); border-radius:var(--radius); padding:16px; border:1px solid var(--border); }
	.cal-header { display:flex; align-items:center; gap:8px; margin-bottom:14px; }
	.cal-title { font-size:16px; font-weight:800; flex-shrink:0; }
	.cal-nav-btn { width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; transition:all 0.15s; }
	.cal-nav-btn:hover { border-color:var(--primary); color:var(--primary); }
	.cal-weekdays { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:11px; font-weight:700; color:var(--text-sec); margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid var(--border); }
	.cal-weekdays .cal-sat { color:#6898fa; }
	.cal-weekdays .cal-sun { color:var(--red); }
	.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
	.cal-cell { min-height:64px; border-radius:10px; padding:6px; cursor:pointer; transition:all 0.15s; display:flex; flex-direction:column; align-items:center; position:relative; }
	.cal-cell:hover { background:rgba(129,140,248,0.08); }
	.cal-cell.cal-today .cal-date { background:var(--primary); color:#fff; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; }
	.cal-cell.cal-selected { background:rgba(129,140,248,0.15); border:1px solid rgba(129,140,248,0.4); }
	.cal-cell.cal-other { opacity:0.3; }
	.cal-date { font-size:13px; font-weight:600; margin-bottom:4px; }
	.cal-cell.cal-sun .cal-date { color:var(--red); }
	.cal-cell.cal-sat .cal-date { color:#6898fa; }
	.cal-dots { display:flex; gap:3px; flex-wrap:wrap; justify-content:center; }
	.cal-dot { width:6px; height:6px; border-radius:50%; }
	.cal-dot.dot-assign { background:#818cf8; }
	.cal-dot.dot-confirmed { background:#22c55e; }
	.cal-dot.dot-review { background:#eab308; }
	.cal-dot.dot-failed { background:#ef4444; }
	.cal-dot.dot-grading { background:#818cf8; opacity:0.6; }
	.cal-count { font-size:9px; color:var(--text-sec); margin-top:2px; }

	.cal-side { background:var(--bg-card); border-radius:var(--radius); padding:0; border:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
	.cal-side-header { padding:14px 16px 8px; font-size:15px; font-weight:700; border-bottom:1px solid var(--border); flex-shrink:0; }
	.cal-side-tabs { display:flex; gap:4px; padding:8px 12px; flex-shrink:0; }
	.cal-side-tab { flex:1; padding:7px 0; border:none; border-radius:8px; background:transparent; color:var(--text-sec); font-size:12px; font-weight:700; cursor:pointer; transition:all 0.15s; }
	.cal-side-tab.active { background:rgba(129,140,248,0.15); color:var(--primary); }
	.cal-side-content { flex:1; overflow-y:auto; padding:8px 12px 12px; }
	.cal-side-content::-webkit-scrollbar { width:5px; }
	.cal-side-content::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

	.cal-result-item { display:flex; align-items:center; gap:10px; padding:10px; background:var(--bg-elevated); border-radius:10px; margin-bottom:6px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; }
	.cal-result-item:hover { border-color:var(--primary); }
	.cal-result-icon { width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
	.cal-result-info { flex:1; min-width:0; }
	.cal-result-title { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
	.cal-result-sub { font-size:11px; color:var(--text-sec); margin-top:2px; }
	.cal-result-badge { padding:3px 8px; border-radius:12px; font-size:10px; font-weight:700; flex-shrink:0; }
	.cal-result-del { background:none; border:none; color:var(--gray); cursor:pointer; padding:4px; font-size:12px; opacity:0.4; transition:opacity 0.15s; flex-shrink:0; }
	.cal-result-del:hover { opacity:1; color:var(--red); }

	.cal-assign-item { padding:10px; background:var(--bg-elevated); border-radius:10px; margin-bottom:6px; border:1px solid transparent; transition:all 0.15s; position:relative; }
	.cal-assign-item:hover { border-color:var(--border); }
	.cal-assign-title { font-size:13px; font-weight:600; margin-bottom:3px; padding-right:28px; }
	.cal-assign-sub { font-size:11px; color:var(--text-sec); }
	.cal-assign-students { display:flex; flex-wrap:wrap; gap:3px; margin-top:5px; }
	.cal-assign-tag { padding:2px 7px; border-radius:10px; font-size:10px; background:rgba(129,140,248,0.12); color:var(--primary); font-weight:600; }
	.cal-assign-del { position:absolute; top:8px; right:8px; background:none; border:none; color:var(--text-sec); cursor:pointer; font-size:12px; padding:3px 5px; border-radius:6px; opacity:0; transition:all 0.15s; }
	.cal-assign-item:hover .cal-assign-del { opacity:1; }
	.cal-assign-del:hover { color:#ef4444; background:rgba(239,68,68,0.1); }

	.cal-side-filter { display:flex; gap:4px; padding:0 0 8px; flex-wrap:wrap; }
	.cal-side-filter button { padding:4px 10px; border:1px solid var(--border); border-radius:14px; background:transparent; color:var(--text-sec); font-size:11px; font-weight:600; cursor:pointer; transition:all 0.15s; }
	.cal-side-filter button.active { background:rgba(129,140,248,0.15); color:var(--primary); border-color:rgba(129,140,248,0.3); }

	@media (max-width:480px) {
		.cal-cell { min-height:48px; padding:4px 2px; }
		.cal-date { font-size:11px; }
		.cal-container { padding:6px 8px; gap:8px; }
	}

	/* ì´ë¯¸ì§€ ë„¤ë¹„ê²Œì´ì…˜ */
	.image-nav { display:flex; align-items:center; justify-content:center; gap:10px; margin-top:8px; }
	.image-nav button { width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); cursor:pointer; font-size:13px; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
	.image-nav button:hover:not(:disabled) { border-color:var(--primary); color:var(--primary); }
	.image-nav button:disabled { opacity:0.3; cursor:default; }
	.image-nav .page-indicator { font-size:12px; color:var(--text-sec); min-width:60px; text-align:center; cursor:pointer; user-select:none; }
	.image-nav .page-indicator:hover { color:var(--primary); }
	.image-nav .page-jump-input { width:48px; padding:3px 4px; font-size:13px; text-align:center; border:1px solid var(--primary); border-radius:6px; background:var(--bg-elevated); color:var(--text); outline:none; }
	.kd-bookmarks { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; justify-content:center; }
	.kd-bookmark-btn { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; font-size:11px; border-radius:14px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
	.kd-bookmark-btn:hover { border-color:var(--primary); color:var(--primary); background:rgba(129,140,248,0.08); }
	.kd-bookmark-btn.active { border-color:var(--primary); color:#fff; background:var(--primary); }
	.kd-bookmark-btn i { font-size:9px; }
	.kd-bookmark-add { border-style:dashed; }

		/* Split View (ì´ë¯¸ì§€ + ì •ë‹µ íŒ¨ë„) */
		.split-view { display:flex; gap:8px; margin:8px 12px; }
		.split-left { flex:2; min-width:0; }
		.split-right { flex:1; min-width:260px; max-width:360px; }
		@media (max-width:768px) {
			.split-view { flex-direction:column; }
			.split-right { max-width:100%; }
		}

		/* ì •ë‹µ íŒ¨ë„ */
		.answer-panel { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; max-height:70vh; overflow-y:auto; }
		.answer-panel .ap-title { font-size:14px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
		.answer-panel .ap-title i { color:var(--teal); }
		.ap-item { padding:10px; border-radius:10px; margin-bottom:6px; border:2px solid transparent; cursor:pointer; transition:all 0.15s; background:var(--bg-elevated); }
		.ap-item:hover { border-color:var(--primary); }
		.ap-item.ap-selected { border-color:var(--primary); background:rgba(129,140,248,0.1); box-shadow:0 0 0 1px var(--primary); }
		.ap-item .ap-num { font-weight:700; font-size:13px; }
		.ap-item .ap-row { display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-top:4px; }
		.ap-item .ap-label { color:var(--text-sec); }
		.ap-item .ap-val { font-weight:600; }

		/* ë¹ ë¥¸ ì±„ì  ë²„íŠ¼ (ì •ë‹µ íŒ¨ë„ ë‚´) */
		.quick-grade { display:flex; gap:4px; margin-top:6px; }
		.quick-grade button { flex:1; padding:6px; border:none; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; transition:all 0.15s; }
		.qg-correct { background:rgba(34,197,94,0.2); color:var(--green); }
		.qg-correct:hover,.qg-correct.active { background:var(--green); color:#fff; }
		.qg-wrong { background:rgba(239,68,68,0.2); color:var(--red); }
		.qg-wrong:hover,.qg-wrong.active { background:var(--red); color:#fff; }
		.qg-uncertain { background:rgba(234,179,8,0.2); color:var(--yellow); }
		.qg-uncertain:hover,.qg-uncertain.active { background:var(--yellow); color:#fff; }

		/* ë¬¸í•­ ì„ íƒ í•˜ì´ë¼ì´íŠ¸ */
		.q-cell.q-selected { box-shadow:0 0 0 3px var(--primary); transform:scale(1.1); z-index:2; position:relative; }

		/* ë‹¨ì¶•í‚¤ íŒíŠ¸ ë°” */
		.shortcut-bar { display:flex; gap:8px; padding:6px 12px; background:rgba(129,140,248,0.08); border-radius:10px; margin:8px 12px; align-items:center; flex-wrap:wrap; }
		.shortcut-bar .sk { display:inline-flex; align-items:center; gap:3px; font-size:11px; color:var(--text-sec); }
		.shortcut-bar .sk kbd { padding:2px 6px; border-radius:4px; background:var(--bg-elevated); border:1px solid var(--border); font-size:10px; font-weight:700; color:var(--text); font-family:monospace; }

		/* ì¤Œ ì»¨íŠ¸ë¡¤ */
		.zoom-controls { display:flex; gap:4px; align-items:center; margin-top:6px; }
		.zoom-controls button { width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; }
		.zoom-controls button:hover { border-color:var(--primary); color:var(--primary); }
		.zoom-controls .zoom-level { font-size:11px; color:var(--text-sec); min-width:40px; text-align:center; }

		/* ì§„í–‰ë¥  ë°” */
		.progress-card { background:var(--bg-card); border:1px solid var(--primary); border-radius:var(--radius); padding:12px 14px; margin-bottom:8px; animation:progressPulse 2s ease-in-out infinite; }
		.progress-card .pc-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
		.progress-card .pc-header .pc-icon { font-size:18px; }
		.progress-card .pc-header .pc-title { font-size:13px; font-weight:700; flex:1; }
		.progress-card .pc-header .pc-percent { font-size:14px; font-weight:800; color:var(--primary); }
		.progress-track { width:100%; height:8px; background:var(--bg-elevated); border-radius:4px; overflow:hidden; }
		.progress-fill { height:100%; background:linear-gradient(90deg, var(--primary), var(--teal)); border-radius:4px; transition:width 0.5s ease; }
		.progress-card .pc-detail { font-size:11px; color:var(--text-sec); margin-top:6px; }
		@keyframes progressPulse { 0%,100%{border-color:rgba(129,140,248,0.4)} 50%{border-color:var(--primary)} }

		/* í•™ìƒ ëª©ë¡ íƒ­ â€” 2-column drag & drop */
		.stu-layout { display:grid; grid-template-columns:260px 1fr; gap:0; min-height:calc(100vh - 120px); }
		.stu-sidebar { background:var(--bg-card); border-right:1px solid var(--border); padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
		.stu-sidebar-title { font-size:13px; font-weight:700; color:var(--text-sec); margin-bottom:4px; display:flex; align-items:center; gap:6px; }
		.stu-drag-item { display:flex; align-items:center; gap:8px; padding:9px 11px; background:var(--bg-elevated); border-radius:10px; cursor:grab; border:1px solid transparent; transition:all 0.15s; font-size:12px; user-select:none; }
		.stu-drag-item:hover { border-color:var(--primary); background:rgba(129,140,248,0.08); }
		.stu-drag-item:active { cursor:grabbing; }
		.stu-drag-item.dragging { opacity:0.5; }
		.stu-drag-icon { color:var(--text-sec); font-size:10px; flex-shrink:0; }
		.stu-drag-title { flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
		.stu-drag-sub { font-size:10px; color:var(--text-sec); flex-shrink:0; }

		.stu-main { padding:12px; overflow-y:auto; }
		.stu-search-bar { display:flex; align-items:center; gap:8px; background:var(--bg-elevated); border-radius:10px; padding:4px 12px; margin-bottom:12px; }
		.stu-grade-group { margin-bottom:16px; }
		.stu-grade-header { font-size:13px; font-weight:700; color:var(--text-sec); padding:4px 4px 8px; display:flex; align-items:center; gap:6px; border-bottom:1px solid var(--border); margin-bottom:8px; }
		.stu-grade-header .stu-grade-count { font-size:11px; font-weight:600; color:var(--gray); }

		.stu-card { background:var(--bg-card); border-radius:var(--radius); border:2px solid var(--border); margin-bottom:8px; overflow:hidden; transition:all 0.2s; }
		.stu-card:hover { border-color:rgba(129,140,248,0.3); }
		.stu-card.drop-over { border-color:var(--primary); background:rgba(129,140,248,0.06); box-shadow:0 0 0 3px rgba(129,140,248,0.15); }
		.stu-card-header { display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; }
		.stu-card-avatar { width:34px; height:34px; border-radius:50%; background:rgba(129,140,248,0.15); display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; color:var(--primary); flex-shrink:0; }
		.stu-card-info { flex:1; min-width:0; }
		.stu-card-name { font-size:13px; font-weight:700; }
		.stu-card-meta { font-size:11px; color:var(--text-sec); margin-top:1px; }
		.stu-card-books-preview { display:flex; flex-wrap:wrap; gap:4px; margin-left:auto; }
		.stu-book-tag { padding:2px 7px; border-radius:8px; font-size:10px; font-weight:600; background:rgba(129,140,248,0.12); color:var(--primary); max-width:100px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
		.stu-card-toggle { color:var(--text-sec); font-size:11px; transition:transform 0.2s; padding:3px 5px; flex-shrink:0; }
		.stu-card.open .stu-card-toggle { transform:rotate(180deg); }
		.stu-card-body { display:none; padding:0 12px 10px; border-top:1px solid var(--border); }
		.stu-card.open .stu-card-body { display:block; padding-top:8px; }
		.stu-book-list { display:flex; flex-direction:column; gap:5px; }
		.stu-book-item { display:flex; align-items:center; gap:8px; padding:6px 10px; background:var(--bg-elevated); border-radius:8px; font-size:12px; }
		.stu-book-item .stu-book-title { flex:1; font-weight:600; }
		.stu-book-item .stu-book-subject { color:var(--text-sec); font-size:11px; }
		.stu-book-del { background:none; border:none; color:var(--text-sec); cursor:pointer; font-size:11px; padding:3px 5px; border-radius:6px; transition:all 0.15s; }
		.stu-book-del:hover { color:#ef4444; background:rgba(239,68,68,0.1); }
		.stu-empty-books { font-size:11px; color:var(--text-sec); text-align:center; padding:8px 0; }
		@media (max-width:700px) {
			.stu-layout { grid-template-columns:1fr; }
			.stu-sidebar { border-right:none; border-bottom:1px solid var(--border); max-height:200px; }
		}
	</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div id="page-login" style="display:none; min-height:100vh; align-items:center; justify-content:center; padding:20px;">
	<div style="max-width:380px; width:100%; text-align:center;">
		<div style="font-size:48px; margin-bottom:16px;">ğŸ“</div>
		<h1 style="font-size:22px; font-weight:800; margin-bottom:4px;">ì±„ì  ê´€ë¦¬</h1>
		<p style="color:var(--text-sec); font-size:13px; margin-bottom:28px;">ì„ ìƒë‹˜ì„ ì„ íƒí•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
		<div style="text-align:left;">
			<div class="form-group">
				<label class="form-label">ì„ ìƒë‹˜ ì„ íƒ</label>
				<select class="input" id="login-teacher-select" onchange="onLoginTeacherSelected()">
					<option value="">ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
				</select>
			</div>
			<div class="form-group" id="login-password-section" style="display:none;">
				<label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
				<input class="input" id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter') handleLogin()">
			</div>
			<button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;margin-top:4px;" onclick="handleLogin()">
				<i class="fas fa-sign-in-alt" style="margin-right:6px;"></i> ì…ì¥
			</button>
		</div>
		<p id="login-error" style="color:var(--red);font-size:12px;margin-top:12px;display:none;"></p>
	</div>
</div>

<!-- ë©”ì¸ í˜ì´ì§€ -->
<div id="page-main" style="display:none;">
	<div class="top-bar">
		<h1><i class="fas fa-pen-to-square" style="color:var(--primary);margin-right:6px;"></i>ì±„ì  ê´€ë¦¬</h1>
		<div style="display:flex;gap:8px;">
			<button class="top-bar-btn" onclick="showPage('main')" title="í™ˆ"><i class="fas fa-home"></i></button>
			<button class="top-bar-btn" onclick="handleLogout()" title="ë¡œê·¸ì•„ì›ƒ"><i class="fas fa-sign-out-alt"></i></button>
		</div>
	</div>

	<div class="tabs" id="main-tabs">
		<button class="tab-btn active" onclick="switchMainTab('results', event)">ğŸ“… ë‹¬ë ¥</button>
		<button class="tab-btn" onclick="switchMainTab('students', event)">ğŸ‘¨â€ğŸ“ í•™ìƒ</button>
		<button class="tab-btn" onclick="switchMainTab('keys', event)">ğŸ“š êµì¬ ê´€ë¦¬</button>
		<button class="tab-btn" onclick="switchMainTab('stats', event)">ğŸ“ˆ í†µê³„</button>
	</div>

	<!-- ì±„ì  ê²°ê³¼ íƒ­ (ë‹¬ë ¥ ë·°) -->
	<div id="tab-results" class="tab-content">
		<!-- ì‹¤ì‹œê°„ ì±„ì  ì§„í–‰ë¥  -->
		<div id="grading-progress-container" style="display:none;padding:8px 12px;"></div>
		<div class="cal-container">
			<div class="cal-left">
				<div class="cal-header">
					<button class="cal-nav-btn" onclick="navigateMonth(-1)"><i class="fas fa-chevron-left"></i></button>
					<span class="cal-title" id="cal-title"></span>
					<button class="cal-nav-btn" onclick="navigateMonth(1)"><i class="fas fa-chevron-right"></i></button>
					<button class="btn btn-sm btn-outline" onclick="goToday()" style="margin-left:auto;font-size:11px;">ì˜¤ëŠ˜</button>
				</div>
				<div class="cal-weekdays">
					<span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span class="cal-sat">í† </span><span class="cal-sun">ì¼</span>
				</div>
				<div class="cal-grid" id="cal-grid"></div>
			</div>
			<div class="cal-side">
				<div class="cal-side-header" id="cal-side-header">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
				<div class="cal-side-tabs">
					<button class="cal-side-tab active" onclick="switchSideTab('assign', event)" id="side-tab-assign">ğŸ“‹ ë°°ì •</button>
					<button class="cal-side-tab" onclick="switchSideTab('results', event)" id="side-tab-results">ğŸ“Š ê²°ê³¼</button>
				</div>
				<div class="cal-side-content" id="cal-side-content">
					<div class="empty-state"><i class="fas fa-calendar-day"></i><p>ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ì¼ì˜<br>ê³¼ì œì™€ ì±„ì  ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p></div>
				</div>
			</div>
		</div>
	</div>

	<!-- í•™ìƒ ëª©ë¡ íƒ­ -->
	<div id="tab-students" class="tab-content" style="display:none;">
		<div class="stu-layout">
			<div class="stu-sidebar" id="stu-sidebar">
				<div class="stu-sidebar-title"><i class="fas fa-book"></i> ë“±ë¡ êµì¬</div>
				<div id="stu-book-drag-list"></div>
			</div>
			<div class="stu-main">
				<div class="stu-search-bar">
					<i class="fas fa-search" style="color:var(--text-sec);font-size:13px;"></i>
					<input class="input" id="stu-tab-search" placeholder="í•™ìƒ ê²€ìƒ‰..." oninput="filterStudentList()" style="flex:1;background:transparent;border:none;padding:6px 0;">
				</div>
				<div id="stu-list-container"></div>
			</div>
		</div>
	</div>

	<!-- êµì¬ ê´€ë¦¬ íƒ­ -->
	<div id="tab-keys" class="tab-content" style="display:none;">
		<div style="padding:8px 12px;display:flex;gap:6px;">
			<button class="btn btn-primary btn-sm" onclick="showAddKeyModal()"><i class="fas fa-plus"></i> êµì¬ ë“±ë¡</button>
			<button class="btn btn-sm btn-outline" onclick="scanDrivePDFs()"><i class="fas fa-cloud"></i> ë“œë¼ì´ë¸Œ ìŠ¤ìº”</button>
		</div>
		<div id="keys-list"></div>
	</div>

	<!-- í†µê³„ íƒ­ -->
	<div id="tab-stats" class="tab-content" style="display:none;">
		<div id="stats-content"></div>
	</div>
</div>

<!-- ì±„ì  ìƒì„¸ í˜ì´ì§€ -->
<div id="page-detail" style="display:none;">
	<div class="top-bar">
		<button class="top-bar-btn" onclick="showPage('main')"><i class="fas fa-arrow-left"></i></button>
		<h1 id="detail-title">ì±„ì  ìƒì„¸</h1>
		<div style="display:flex;gap:8px;">
			<button class="btn btn-sm btn-primary" id="detail-confirm-btn" onclick="confirmResult()">âœ… í™•ì •</button>
		</div>
	</div>

	<div style="padding:0 0 120px;">
		<!-- ìƒíƒœ ë°°ë„ˆ (ì±„ì ì¤‘/ì‹¤íŒ¨/ê²€í† í•„ìš” ì‹œ í‘œì‹œ) -->
		<div id="detail-status-banner" style="display:none;" class="detail-status-banner"></div>

		<!-- ì ìˆ˜ ìš”ì•½ -->
		<div class="card">
			<div style="display:flex;gap:12px;">
				<div class="score-card" style="flex:1;">
					<div class="score-big" id="detail-score">-</div>
					<div class="score-sub">ì´ì </div>
				</div>
				<div style="flex:1;">
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--green);" id="detail-correct">0</div><div class="stat-label">ì •ë‹µ</div></div>
						<div class="stat-item"><div class="stat-num" style="color:var(--red);" id="detail-wrong">0</div><div class="stat-label">ì˜¤ë‹µ</div></div>
					</div>
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--yellow);" id="detail-uncertain">0</div><div class="stat-label">í™•ì¸í•„ìš”</div></div>
						<div class="stat-item"><div class="stat-num" style="color:var(--text-sec);" id="detail-total">0</div><div class="stat-label">ì´ë¬¸í•­</div></div>
					</div>
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--gray);" id="detail-unanswered">0</div><div class="stat-label">ë¯¸í’€ì´</div></div>
						<div class="stat-item"></div>
					</div>
				</div>
			</div>
			<div id="detail-page-info" style="display:none;font-size:12px;color:var(--teal);margin-top:8px;padding:8px 12px;background:rgba(20,184,166,0.08);border-radius:8px;">
			</div>
			<!-- êµì¬ ë³€ê²½ + ì¬ì±„ì  -->
			<div style="display:flex;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap;">
				<span style="font-size:12px;color:var(--text-sec);white-space:nowrap;"><i class="fas fa-book" style="margin-right:4px;"></i>êµì¬:</span>
				<select class="input" id="detail-key-select" style="flex:1;min-width:120px;font-size:12px;padding:6px 8px;">
					<option value="">êµì¬ ì—†ìŒ</option>
				</select>
				<button class="btn btn-sm btn-outline" id="detail-regrade-btn" onclick="regradeWithKey()" style="white-space:nowrap;font-size:12px;">
					<i class="fas fa-sync-alt" style="margin-right:4px;"></i>ì¬ì±„ì 
				</button>
			</div>
		</div>

		<!-- ë¬¸í•­ ê·¸ë¦¬ë“œ -->
		<div class="card">
			<div class="card-title"><i class="fas fa-th"></i> ë¬¸í•­ë³„ ê²°ê³¼ <span style="font-size:11px;color:var(--text-sec);font-weight:400;margin-left:auto;">í´ë¦­ ë˜ëŠ” W/Sí‚¤ë¡œ ì´ë™</span></div>
			<div class="question-grid" id="detail-grid"></div>
		</div>

		<!-- ë‹¨ì¶•í‚¤ íŒíŠ¸ -->
		<div class="shortcut-bar" id="shortcut-bar">
			<span class="sk"><kbd>W</kbd><kbd>S</kbd> ë¬¸í•­ì´ë™</span>
			<span class="sk"><kbd>1</kbd> ì •ë‹µ</span>
			<span class="sk"><kbd>2</kbd> ì˜¤ë‹µ</span>
			<span class="sk"><kbd>3</kbd> í™•ì¸í•„ìš”</span>
			<span class="sk"><kbd>Enter</kbd> ì €ì¥</span>
		<span class="sk"><kbd>+</kbd><kbd>-</kbd> ì¤Œ</span>
		<span class="sk"><kbd>â†</kbd><kbd>â†’</kbd> ì´ë¯¸ì§€</span>
	</div>

		<!-- Split View: ì´ë¯¸ì§€(ì¢Œ) + ì •ë‹µ íŒ¨ë„(ìš°) -->
		<div class="split-view">
			<div class="split-left">
				<div class="card" style="margin:0;">
					<div class="card-title" style="margin-bottom:8px;">
						<i class="fas fa-image"></i> ì±„ì  ì´ë¯¸ì§€
						<div class="zoom-controls" style="margin-left:auto;">
							<button onclick="zoomImage(-0.25)" title="ì¶•ì†Œ"><i class="fas fa-minus"></i></button>
							<span class="zoom-level" id="zoom-level">100%</span>
							<button onclick="zoomImage(0.25)" title="í™•ëŒ€"><i class="fas fa-plus"></i></button>
							<button onclick="zoomImage(0, true)" title="ì›ë³¸"><i class="fas fa-expand"></i></button>
						</div>
					</div>
				<div class="image-viewer" id="image-viewer">
					<div class="empty-image" id="image-empty-state">
						<i class="fas fa-image"></i>
						<p>ì±„ì  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
					</div>
					<img id="graded-image" src="" alt="ì±„ì  ì´ë¯¸ì§€" onload="initCanvas()" style="display:none;">
					<canvas id="annotation-canvas"></canvas>
				</div>
				<div class="image-nav" id="image-nav" style="display:none;">
					<button onclick="prevImage()" id="btn-prev-img" disabled><i class="fas fa-chevron-left"></i></button>
					<span class="page-indicator" id="image-page-indicator">1 / 1</span>
					<button onclick="nextImage()" id="btn-next-img" disabled><i class="fas fa-chevron-right"></i></button>
				</div>
				</div>
			</div>
			<div class="split-right">
				<div class="answer-panel" id="answer-panel">
					<div class="ap-title"><i class="fas fa-list-check"></i> ë¬¸í•­ ì •ë‹µ ë¹„êµ</div>
					<div id="answer-panel-list">
						<div style="text-align:center;color:var(--text-sec);font-size:13px;padding:20px;">ë¬¸í•­ì„ ì„ íƒí•˜ë©´ ì •ë‹µ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
					</div>
				</div>
			</div>
		</div>

		<!-- ì„ ìƒë‹˜ ë©”ëª¨ -->
		<div class="card">
			<div class="card-title"><i class="fas fa-comment"></i> ë©”ëª¨</div>
			<textarea class="input" id="detail-memo" rows="3" placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  ë©”ëª¨..."></textarea>
		</div>
	</div>

	<!-- í•„ê¸° ë„êµ¬ ë°” -->
	<div class="canvas-toolbar" id="canvas-toolbar">
		<button class="tool-btn active" data-tool="pen" onclick="setTool('pen')"><i class="fas fa-pen"></i></button>
		<button class="tool-btn" data-tool="highlighter" onclick="setTool('highlighter')"><i class="fas fa-highlighter"></i></button>
		<button class="tool-btn" data-tool="text" onclick="setTool('text')"><i class="fas fa-font"></i></button>
		<button class="tool-btn" data-tool="circle" onclick="setTool('circle')"><i class="fas fa-circle" style="font-size:11px;"></i></button>
		<button class="tool-btn" data-tool="check" onclick="setTool('check')"><i class="fas fa-check"></i></button>
		<button class="tool-btn" data-tool="xmark" onclick="setTool('xmark')"><i class="fas fa-xmark"></i></button>
		<button class="tool-btn" data-tool="eraser" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
		<div style="display:flex;gap:4px;align-items:center;margin-left:4px;">
			<div class="color-dot active" style="background:#ef4444;" onclick="setColor('#ef4444')"></div>
			<div class="color-dot" style="background:#3b82f6;" onclick="setColor('#3b82f6')"></div>
			<div class="color-dot" style="background:#22c55e;" onclick="setColor('#22c55e')"></div>
			<div class="color-dot" style="background:#1e293b;" onclick="setColor('#1e293b')"></div>
		</div>
		<input type="range" class="size-slider" min="1" max="20" value="3" oninput="setPenSize(this.value)">
		<button class="tool-btn" onclick="undoCanvas()"><i class="fas fa-undo"></i></button>
		<button class="tool-btn" onclick="redoCanvas()"><i class="fas fa-redo"></i></button>
		<button class="tool-btn" onclick="saveAnnotations()" style="color:var(--green);"><i class="fas fa-save"></i></button>
	</div>
</div>

<!-- êµì¬ ìƒì„¸ í¸ì§‘ í˜ì´ì§€ -->
<div id="page-key-detail" style="display:none;">
	<div class="top-bar">
		<button class="top-bar-btn" onclick="showPage('main')"><i class="fas fa-arrow-left"></i></button>
		<h1 id="key-detail-title">êµì¬ ìƒì„¸</h1>
		<button class="btn btn-sm btn-primary" onclick="saveKeyDetail()"><i class="fas fa-save" style="margin-right:4px;"></i>ì €ì¥</button>
	</div>

	<div style="padding:12px 12px 40px;">
		<!-- êµì¬ ê¸°ë³¸ ì •ë³´ -->
		<div class="card">
			<div style="display:flex;gap:8px;">
				<div class="form-group" style="flex:2;margin-bottom:0;">
					<label class="form-label">êµì¬ëª…</label>
					<input class="input" id="kd-title" placeholder="êµì¬ëª…" oninput="markKdDirty()">
				</div>
				<div class="form-group" style="flex:1;margin-bottom:0;">
					<label class="form-label">ê³¼ëª©</label>
					<input class="input" id="kd-subject" placeholder="ê³¼ëª©" oninput="markKdDirty()">
				</div>
			</div>
		</div>

		<!-- 2ë‹¨ ë ˆì´ì•„ì›ƒ: ì™¼ìª½ ë¯¸ë¦¬ë³´ê¸° / ì˜¤ë¥¸ìª½ ë¬¸ì œëª©ë¡ -->
		<div class="kd-split">
			<!-- ì™¼ìª½: í˜ì´ì§€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
			<div class="kd-split-left">
				<div class="card" id="kd-pages-section" style="margin-bottom:0;">
					<div class="card-title" style="justify-content:space-between;">
						<span><i class="fas fa-images"></i> í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
						<button class="btn btn-sm btn-outline" onclick="refreshKeyPageImages()" title="ìƒˆë¡œê³ ì¹¨" style="padding:4px 10px;font-size:12px;">
							<i class="fas fa-sync-alt"></i>
						</button>
					</div>
					<div class="kd-pages-wrap" id="kd-pages-wrap">
						<div id="kd-pages-container">
							<div class="empty-state" style="padding:20px;"><i class="fas fa-file-image"></i><p>íŒŒì‹±ëœ í˜ì´ì§€ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
						</div>
					</div>
					<div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:6px;" id="kd-zoom-bar">
						<button class="math-nav-btn" onclick="kdZoom(-0.1)" title="ì¶•ì†Œ"><i class="fas fa-minus"></i></button>
						<span id="kd-zoom-label" style="font-size:11px;color:var(--text-sec);min-width:42px;text-align:center;">100%</span>
						<button class="math-nav-btn" onclick="kdZoom(0.1)" title="í™•ëŒ€"><i class="fas fa-plus"></i></button>
						<button class="math-nav-btn" onclick="kdZoomReset()" title="ì´ˆê¸°í™”" style="margin-left:4px;">ì´ˆê¸°í™”</button>
					</div>
					<div class="image-nav" id="kd-page-nav" style="display:none;">
						<button onclick="kdPrevPage()" id="kd-btn-prev" disabled><i class="fas fa-chevron-left"></i></button>
						<span class="page-indicator" id="kd-page-indicator" onclick="kdStartPageJump()">1 / 1</span>
						<button onclick="kdNextPage()" id="kd-btn-next" disabled><i class="fas fa-chevron-right"></i></button>
					</div>
					<div class="kd-bookmarks" id="kd-bookmarks"></div>
					<div id="kd-pages-hint" style="display:none;font-size:11px;color:var(--text-sec);text-align:center;margin-top:6px;"></div>
				</div>
			</div>

			<!-- ì˜¤ë¥¸ìª½: ë¬¸ì œ ëª©ë¡ -->
			<div class="kd-split-right">
				<div class="card" style="margin-bottom:0;">
					<div class="card-title" style="justify-content:space-between;">
						<span><i class="fas fa-list-ol"></i> ë¬¸ì œ ëª©ë¡</span>
						<span style="font-size:12px;color:var(--text-sec);font-weight:400;" id="kd-question-count">0ë¬¸ì œ</span>
					</div>

					<div class="kd-table-header">
						<span class="kd-col-num">ë²ˆí˜¸</span>
						<span class="kd-col-type">ìœ í˜•</span>
						<span class="kd-col-answer">ì •ë‹µ</span>
						<span class="kd-col-del"></span>
					</div>

					<div id="kd-questions-list"></div>

					<button class="btn btn-sm btn-outline" style="width:100%;margin-top:10px;" onclick="addQuestion()">
						<i class="fas fa-plus" style="margin-right:4px;"></i> ë¬¸ì œ ì¶”ê°€
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- ìˆ˜ì‹ í¸ì§‘ê¸° (MathLive) -->
<div class="math-editor-overlay" id="math-editor-overlay" onclick="if(event.target===this)closeMathEditor(false)">
	<div class="math-editor">
		<div class="math-editor-header">
			<h3><i class="fas fa-square-root-alt" style="margin-right:6px;"></i>ìˆ˜ì‹ í¸ì§‘ê¸° <span id="math-editor-qnum" style="font-weight:400;color:var(--text-sec);font-size:12px;"></span></h3>
			<div style="display:flex;gap:6px;">
				<button class="btn btn-primary btn-sm" onclick="closeMathEditor(true)" style="padding:5px 14px;font-size:12px;"><i class="fas fa-check"></i> í™•ì¸</button>
				<button class="btn btn-outline btn-sm" onclick="closeMathEditor(false)" style="padding:5px 14px;font-size:12px;">ì·¨ì†Œ</button>
			</div>
		</div>
		<div class="math-editor-body">
			<math-field id="math-editor-field" virtual-keyboard-mode="onfocus"></math-field>
			<div class="math-nav-bar">
				<div class="math-nav-btns">
					<button type="button" class="math-nav-btn" onclick="mathCmd('moveToPreviousPlaceholder')" title="ì´ì „ ë¹ˆì¹¸ìœ¼ë¡œ"><i class="fas fa-angle-double-left"></i></button>
					<button type="button" class="math-nav-btn" onclick="mathCmd('moveToPreviousChar')" title="â† ì´ì „"><i class="fas fa-angle-left"></i></button>
					<button type="button" class="math-nav-btn" onclick="mathCmd('moveToNextChar')" title="ë‹¤ìŒ â†’"><i class="fas fa-angle-right"></i></button>
					<button type="button" class="math-nav-btn" onclick="mathCmd('moveToNextPlaceholder')" title="ë‹¤ìŒ ë¹ˆì¹¸ìœ¼ë¡œ"><i class="fas fa-angle-double-right"></i></button>
					<span style="width:1px;height:16px;background:var(--border);margin:0 4px;"></span>
					<button type="button" class="math-nav-btn" onclick="mathCmd('moveToMathfieldEnd')" title="ë§¨ ëìœ¼ë¡œ">ëâ‡¥</button>
					<button type="button" class="math-nav-btn" onclick="mathCmd('deleteBackward')" title="ì§€ìš°ê¸°"><i class="fas fa-backspace"></i></button>
				</div>
				<label style="font-size:11px;color:var(--text-sec);cursor:pointer;display:flex;align-items:center;gap:4px;">
					<input type="checkbox" id="math-editor-raw" onchange="toggleMathRaw()" style="width:14px;height:14px;">LaTeX
				</label>
			</div>
			<div style="margin-top:4px;font-size:10px;color:var(--text-sec);line-height:1.5;">
				ìˆ˜ì‹ êµ¬ì¡°ë¥¼ ì¶”ê°€í•œ ë’¤ <kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:3px;font-size:9px;">â†’</kbd> ë˜ëŠ” <strong>ë‹¤ìŒ â†’</strong> ë²„íŠ¼ìœ¼ë¡œ ì»¤ì„œë¥¼ ë¹ˆì¹¸ ë°–ìœ¼ë¡œ ì´ë™í•œ í›„ ë‹¤ìŒ ìˆ˜ì‹ì„ ì¶”ê°€í•˜ì„¸ìš”
			</div>
			<textarea id="math-editor-raw-input" style="display:none;width:100%;box-sizing:border-box;padding:8px 12px;margin-top:6px;font-size:13px;font-family:monospace;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);resize:vertical;min-height:40px;outline:none;" placeholder="LaTeX ì§ì ‘ ì…ë ¥ (ì˜ˆ: \int_0^1 x^2 dx)"></textarea>
		</div>
	</div>
</div>

<!-- ë¬¸í•­ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="item-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-edit" style="color:var(--primary);"></i> <span id="item-modal-title">ë¬¸í•­ ìˆ˜ì •</span></div>
		<div class="form-group">
			<label class="form-label">í•™ìƒ ë‹µ</label>
			<div class="input" id="item-student-answer" style="background:var(--bg);"></div>
		</div>
		<div class="form-group">
			<label class="form-label">ì •ë‹µ</label>
			<div class="input" id="item-correct-answer" style="background:var(--bg);"></div>
		</div>
		<div class="form-group" id="item-ai-section" style="display:none;">
			<label class="form-label">AI í”¼ë“œë°±</label>
			<div class="input" id="item-ai-feedback" style="background:var(--bg);font-size:13px;"></div>
		</div>
		<div class="form-group">
			<label class="form-label">ì ìˆ˜ ìˆ˜ì •</label>
			<input class="input" id="item-teacher-score" type="number" step="0.5" placeholder="ìˆ˜ì •í•  ì ìˆ˜">
		</div>
		<div class="form-group">
			<label class="form-label">í”¼ë“œë°±</label>
			<input class="input" id="item-teacher-feedback" type="text" placeholder="í”¼ë“œë°± ì…ë ¥">
		</div>
		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="saveItemEdit()">ì €ì¥</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('item-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<!-- ê³¼ì œ ë°°ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="assign-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-clipboard-list" style="color:var(--primary);"></i> <span id="assign-modal-title">ê³¼ì œ ë°°ì •</span></div>
		<div class="form-group">
			<label class="form-label">ê³¼ì œ ì œëª©</label>
			<input class="input" id="assign-title" placeholder="ì˜ˆ: ìˆ˜í•™ 42~45ìª½">
		</div>
		<div class="form-group">
			<label class="form-label">êµì¬ ì„ íƒ</label>
			<select class="input" id="assign-key">
				<option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
			</select>
		</div>
		<div class="form-group">
			<label class="form-label">í•™ìƒ ì„ íƒ</label>
			<div style="position:relative;">
				<input class="input" id="assign-student-search" placeholder="ì´ë¦„ ê²€ìƒ‰..." autocomplete="off"
					oninput="filterStudentDropdown()" onfocus="showStudentDropdown()">
				<div id="assign-student-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:10;background:var(--bg-elevated);border:1px solid var(--border);border-radius:0 0 10px 10px;max-height:160px;overflow-y:auto;"></div>
			</div>
			<div id="assign-selected-students" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
		</div>
		<div class="form-group">
			<label class="form-label">í˜ì´ì§€ ë²”ìœ„</label>
			<input class="input" id="assign-pages" placeholder="ì˜ˆ: 42-45">
		</div>
		<div class="form-group">
			<label class="form-label">ë§ˆê°ì¼</label>
			<input class="input" id="assign-due" type="date">
		</div>
		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="createAssignment()" id="assign-modal-btn">ë°°ì •</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('assign-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<!-- êµì¬ ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal-overlay" id="key-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-book" style="color:var(--primary);"></i> êµì¬ ë“±ë¡</div>

		<!-- êµì¬ ìœ í˜• ì„ íƒ -->
		<div class="form-group">
			<label class="form-label">êµì¬ ìœ í˜•</label>
			<div style="display:flex;gap:8px;">
				<button class="btn btn-sm" id="key-type-print" onclick="selectKeyType('print')"
					style="flex:1;padding:10px;border:2px solid var(--primary);background:var(--primary);color:#fff;border-radius:10px;font-size:13px;">
					<i class="fas fa-print"></i> í”„ë¦°íŠ¸ ê³¼ì œ
				</button>
				<button class="btn btn-sm" id="key-type-book" onclick="selectKeyType('book')"
					style="flex:1;padding:10px;border:2px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;font-size:13px;">
					<i class="fas fa-book-open"></i> ì‹œì¤‘ êµì¬
				</button>
			</div>
		</div>

		<div class="form-group">
			<label class="form-label">êµì¬ëª…</label>
			<input class="input" id="key-title" placeholder="ì˜ˆ: ìˆ˜í•™ ë¬¸ì œì§‘ A">
		</div>
		<div class="form-group">
			<label class="form-label">ê³¼ëª©</label>
			<input class="input" id="key-subject" placeholder="ì˜ˆ: ìˆ˜í•™">
		</div>
		<div class="form-group">
			<label class="form-label">êµì¬ íŒŒì¼</label>
			<input type="file" id="key-pdf" accept=".pdf,.hml" style="display:none;" onchange="onKeyFileSelected(this)">
			<div class="file-drop-zone" id="key-file-drop" onclick="document.getElementById('key-pdf').click()">
				<div id="key-file-drop-content">
					<i class="fas fa-cloud-upload-alt" style="font-size:28px;color:var(--primary);margin-bottom:8px;"></i>
					<p style="margin:0;font-size:13px;font-weight:600;">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
					<p style="margin:4px 0 0;font-size:11px;color:var(--text-sec);">PDF ë˜ëŠ” í•œê¸€(HML) íŒŒì¼ ì§€ì›</p>
				</div>
			</div>
		</div>

		<!-- í”„ë¦°íŠ¸ ì•ˆë‚´ (ê¸°ë³¸ í‘œì‹œ) -->
		<div id="key-print-info" style="background:#f0f9ff;border-radius:10px;padding:12px;margin-bottom:12px;">
			<p style="font-size:12px;color:#0369a1;margin:0;">
				<i class="fas fa-magic" style="margin-right:4px;"></i>
				<b>í”„ë¦°íŠ¸ ê³¼ì œ</b>: ì •ë‹µì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.<br>
				<span style="font-size:11px;color:#64748b;">HML(ìˆ˜í•™ë¹„ì„œ) â†’ ë¯¸ì£¼ì—ì„œ ì •ë‹µ 100% ì •í™• ì¶”ì¶œ<br>PDF â†’ AIê°€ ì •ë‹µ/í•´ì„¤ í˜ì´ì§€ì—ì„œ ì¶”ì¶œ</span>
			</p>
		</div>

		<!-- ì‹œì¤‘ êµì¬ ì„¤ì • (ìˆ¨ê¹€) -->
		<div id="key-book-info" style="display:none;">
			<div style="background:#fefce8;border-radius:10px;padding:12px;margin-bottom:12px;">
				<p style="font-size:12px;color:#854d0e;margin:0 0 8px 0;">
					<i class="fas fa-lightbulb" style="margin-right:4px;"></i>
					<b>ì‹œì¤‘ êµì¬</b>ëŠ” ì •ë‹µ/í•´ì„¤ í˜ì´ì§€ë¥¼ ì§€ì •í•˜ë©´ ë¹ ë¥´ê³  ì •í™•í•©ë‹ˆë‹¤.<br>
					<span style="font-size:11px;color:#64748b;">ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ì •ë‹µ í˜ì´ì§€ë¥¼ ì°¾ìŠµë‹ˆë‹¤.</span>
				</p>
			</div>
			<div class="form-group">
				<label class="form-label">ì •ë‹µ/í•´ì„¤ ì‹œì‘ í˜ì´ì§€ <span style="color:var(--text-sec);font-weight:400;">(ì„ íƒ)</span></label>
				<div style="display:flex;gap:8px;align-items:center;">
					<input class="input" id="key-page-start" type="number" placeholder="ì˜ˆ: 180" style="flex:1;">
					<span style="color:var(--text-sec);">~</span>
					<input class="input" id="key-page-end" type="number" placeholder="ì˜ˆ: 210" style="flex:1;">
					<span style="font-size:12px;color:var(--text-sec);">í˜ì´ì§€</span>
				</div>
			</div>
		</div>

		<div class="form-group">
			<label class="form-label">ì˜ˆìƒ ë¬¸ì œ ìˆ˜ <span style="color:var(--text-sec);font-weight:400;">(ì„ íƒ)</span></label>
			<input class="input" id="key-total-hint" type="number" placeholder="ì˜ˆ: 30">
		</div>

		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="registerAnswerKey()">
				<i class="fas fa-upload" style="margin-right:4px;"></i> ë“±ë¡ ë° ì •ë‹µ ì¶”ì¶œ
			</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('key-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<script>
// ============================================================
// ì„¤ì •
// ============================================================
const SUPABASE_URL = 'https://jzcrpdeomjmytfekcgqu.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_6X3mtsIpdMkLWgo9aUbZTg_ihtAA3cu';
const GRADING_SERVER_URL = localStorage.getItem('grading_server_url') || 'https://academymanager-production.up.railway.app';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
	realtime: { params: { eventsPerSecond: 0 } },
	auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false }
});

let currentTeacher = null;
let teacherList = [];
let currentResults = [];
let currentItems = [];
let currentResultId = null;
let currentFilter = 'all';
let currentAssignments = [];

// ë‹¬ë ¥ ìƒíƒœ
const _now = new Date();
let calYear = _now.getFullYear();
let calMonth = _now.getMonth();
let calSelectedDate = '';
let calSideTab = 'assign';

// ìº”ë²„ìŠ¤ ê´€ë ¨
let canvasTool = 'pen';
let canvasColor = '#ef4444';
let canvasPenSize = 3;
let canvasHistory = [];
let canvasRedoStack = [];
let isDrawing = false;

// Split View / ë‹¨ì¶•í‚¤ ê´€ë ¨
let selectedItemIdx = -1;  // í˜„ì¬ ì„ íƒëœ ë¬¸í•­ ì¸ë±ìŠ¤
let imageZoom = 1;          // ì´ë¯¸ì§€ ì¤Œ ë ˆë²¨
let currentImageUrls = [];  // ì±„ì  ì´ë¯¸ì§€ URL ëª©ë¡
let currentImageIdx = 0;    // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì´ë¯¸ì§€ ì¸ë±ìŠ¤

// ============================================================
// ì¸ì¦ (ì„ ìƒë‹˜ ì„ íƒ + ë¹„ë°€ë²ˆí˜¸)
// ============================================================
async function hashPin(pin) {
	const enc = new TextEncoder().encode(pin);
	const hash = await crypto.subtle.digest('SHA-256', enc);
	return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function loadTeacherList() {
	// 1ì°¨: ì±„ì  ì„œë²„ì—ì„œ ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ
	try {
		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 5000);
		const res = await fetch(`${GRADING_SERVER_URL}/api/teachers`, { signal: controller.signal });
		clearTimeout(timeoutId);
		if (res.ok) {
			const result = await res.json();
			teacherList = result.data || [];
			console.log('[ì±„ì ê´€ë¦¬] ì±„ì  ì„œë²„ì—ì„œ ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', teacherList.length, 'ëª…');
		}
	} catch (e) {
		console.warn('[ì±„ì ê´€ë¦¬] ì±„ì  ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', e.message);
	}

	// 2ì°¨ fallback: Supabase JS í´ë¼ì´ì–¸íŠ¸ë¡œ ì¡°íšŒ
	if (!teacherList || teacherList.length === 0) {
		try {
			const { data, error } = await db.from('teachers').select('*').order('created_at');
			if (!error && data && data.length > 0) {
				teacherList = data;
				console.log('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„ ìƒë‹˜ ë¡œë“œ ì„±ê³µ:', data.length, 'ëª…');
			} else {
				console.warn('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨ (RLS ê°€ëŠ¥ì„±):', error?.message);
			}
		} catch (e2) {
			console.warn('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ ì‹¤íŒ¨:', e2.message);
		}
	}

	// 3ì°¨ fallback: Supabase REST API ì§ì ‘ í˜¸ì¶œ (RLS ìš°íšŒ ì‹œë„)
	if (!teacherList || teacherList.length === 0) {
		try {
			const res = await fetch(`${SUPABASE_URL}/rest/v1/teachers?select=*&order=created_at.asc`, {
				headers: {
					'apikey': SUPABASE_ANON_KEY,
					'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
					'Content-Type': 'application/json',
				}
			});
			if (res.ok) {
				const data = await res.json();
				if (data && data.length > 0) {
					teacherList = data;
					console.log('[ì±„ì ê´€ë¦¬] Supabase REST APIì—ì„œ ì„ ìƒë‹˜ ë¡œë“œ ì„±ê³µ:', data.length, 'ëª…');
				}
			}
		} catch (e3) {
			console.warn('[ì±„ì ê´€ë¦¬] Supabase REST API ì‹¤íŒ¨:', e3.message);
		}
	}

	// ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
	if (!teacherList || teacherList.length === 0) {
		console.error('[ì±„ì ê´€ë¦¬] ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ì±„ì  ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”');
		console.error('[ì±„ì ê´€ë¦¬] ë¡œì»¬ ì‹¤í–‰: localStorage.setItem("grading_server_url", "http://localhost:8000")');
	}

	const sel = document.getElementById('login-teacher-select');
	sel.innerHTML = '<option value="">ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
		teacherList.map(t => `<option value="${t.id}">${escapeHtml(t.name)}${t.phone ? ' (' + t.phone.slice(-4) + ')' : ''}</option>`).join('');
}

function onLoginTeacherSelected() {
	const tid = document.getElementById('login-teacher-select').value;
	document.getElementById('login-password-section').style.display = tid ? 'block' : 'none';
	document.getElementById('login-error').style.display = 'none';
	if (tid) document.getElementById('login-password').value = '';
}

async function handleLogin() {
	const tid = document.getElementById('login-teacher-select').value;
	if (!tid) { showToast('ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }

	const teacher = teacherList.find(t => String(t.id) === String(tid));
	if (!teacher) { showToast('ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

	const password = document.getElementById('login-password').value.trim();
	if (!password) { showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

	const inputHash = await hashPin(password);
	if (inputHash !== teacher.pin_hash) {
		const errEl = document.getElementById('login-error');
		errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
		errEl.style.display = 'block';
		return;
	}

	currentTeacher = teacher;
	sessionStorage.setItem('grading_teacher', JSON.stringify(teacher));
	document.getElementById('login-error').style.display = 'none';
	showPage('main');
	loadAllData();
}

function handleLogout() {
	kdDirty = false;
	sessionStorage.removeItem('grading_teacher');
	sessionStorage.removeItem('grading_nav');
	currentTeacher = null;
	currentResults = [];
	currentItems = [];
	currentResultId = null;
	stopProgressPolling();
	showPage('login');
}

// ============================================================
// í˜ì´ì§€/íƒ­ ì „í™˜
// ============================================================
let currentPage = 'login';
function showPage(page) {
	if (currentPage === 'key-detail' && page !== 'key-detail' && kdDirty) {
		if (!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
		kdDirty = false;
	}
	currentPage = page;
	document.getElementById('page-login').style.display = page === 'login' ? 'flex' : 'none';
	document.getElementById('page-main').style.display = page === 'main' ? 'block' : 'none';
	document.getElementById('page-detail').style.display = page === 'detail' ? 'block' : 'none';
	document.getElementById('page-key-detail').style.display = page === 'key-detail' ? 'block' : 'none';
	if (page !== 'detail') {
		document.removeEventListener('keydown', handleDetailKeydown);
		_stopDetailPoll();
	}
	if (page !== 'login') saveNavState();
}

window.addEventListener('beforeunload', (e) => {
	if (kdDirty) {
		e.preventDefault();
		e.returnValue = '';
	}
});

let currentMainTab = 'results';
function switchMainTab(tab, e) {
	if (!document.getElementById('tab-' + tab)) tab = 'results';
	currentMainTab = tab;
	document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
	document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
	document.getElementById('tab-' + tab).style.display = 'block';
	const btn = e ? (e.target.closest('.tab-btn') || e.target) : null;
	if (btn) btn.classList.add('active');
	saveNavState();
}

let kdDirty = false;
function markKdDirty() { kdDirty = true; }

function saveNavState() {
	const state = { page: currentPage, tab: currentMainTab };
	if (currentPage === 'detail' && currentResultId) state.resultId = currentResultId;
	if (currentPage === 'key-detail' && currentKeyDetail) state.keyId = currentKeyDetail.id;
	sessionStorage.setItem('grading_nav', JSON.stringify(state));
}

async function restoreNavState() {
	const raw = sessionStorage.getItem('grading_nav');
	if (!raw) return;
	try {
		const state = JSON.parse(raw);
		if (state.tab) {
			currentMainTab = state.tab;
			const tabBtn = document.querySelector(`.tab-btn[onclick*="'${state.tab}'"]`);
			if (tabBtn) switchMainTab(state.tab, { target: tabBtn });
		}
		if (state.page === 'detail' && state.resultId) {
			await openDetail(state.resultId);
		} else if (state.page === 'key-detail' && state.keyId) {
			await openKeyDetail(state.keyId);
		}
	} catch(e) {}
}

function closeModal(id) {
	document.getElementById(id).classList.remove('show');
}

function showToast(msg, type = 'info') {
	const el = document.createElement('div');
	el.className = 'g-toast ' + type;
	el.textContent = msg;
	document.body.appendChild(el);
	setTimeout(() => el.remove(), 3000);
}

// ============================================================
// ë°ì´í„° ë¡œë“œ
// ============================================================
async function loadAllData() {
	await Promise.all([loadResults(), loadAssignments(), loadAnswerKeys(), loadStats(), loadStudentList()]);
	startProgressPolling();
}

// ============================================================
// ì‹¤ì‹œê°„ ì±„ì  ì§„í–‰ë¥  í´ë§
// ============================================================
let progressPollTimer = null;

function startProgressPolling() {
	stopProgressPolling();
	pollGradingProgress();
	progressPollTimer = setInterval(pollGradingProgress, 3000);
}

function stopProgressPolling() {
	if (progressPollTimer) {
		clearInterval(progressPollTimer);
		progressPollTimer = null;
	}
}

async function pollGradingProgress() {
	const container = document.getElementById('grading-progress-container');
	if (!container || !currentTeacher) return;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/grading-progress?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		if (!res.ok) return;
		const result = await res.json();
		const active = (result.data || []).filter(p => p.stage !== 'done' && p.stage !== 'failed' && p.stage !== 'unknown');

		if (active.length === 0) {
			container.style.display = 'none';
			container.innerHTML = '';
			return;
		}

		container.style.display = 'block';
		container.innerHTML = active.map(p => {
			const stageLabels = {
				preprocess: 'ì´ë¯¸ì§€ ì „ì²˜ë¦¬',
				ocr: 'AI ë‹µì•ˆ ì¸ì‹ (OCR)',
				cross_validate: 'í¬ë¡œìŠ¤ ê²€ì¦',
				matching: 'êµì¬ ë§¤ì¹­',
				grading: 'ì±„ì  ì§„í–‰',
				saving: 'ê²°ê³¼ ì €ì¥',
			};
			const stageLabel = stageLabels[p.stage] || p.stage;
			const pct = Math.min(100, Math.max(0, p.percent || 0));
			// ë‹¨ê³„ë³„ ì „ì²´ ì§„í–‰ë¥  ë³´ì •
			let totalPct = 0;
			if (p.stage === 'preprocess') totalPct = 5;
			else if (p.stage === 'ocr') totalPct = 15 + pct * 0.2;
			else if (p.stage === 'cross_validate') totalPct = 35 + pct * 0.1;
			else if (p.stage === 'matching') totalPct = 45;
			else if (p.stage === 'grading') totalPct = 50 + pct * 0.4;
			else if (p.stage === 'saving') totalPct = 95;
			totalPct = Math.round(Math.min(99, totalPct));

			return `<div class="progress-card">
				<div class="pc-header">
					<span class="pc-icon"><div class="spinner" style="width:18px;height:18px;margin:0;border-width:2px;"></div></span>
					<span class="pc-title">ì±„ì  ì§„í–‰ ì¤‘</span>
					<span class="pc-percent">${totalPct}%</span>
				</div>
				<div class="progress-track">
					<div class="progress-fill" style="width:${totalPct}%"></div>
				</div>
				<div class="pc-detail">${stageLabel}${p.detail ? ' Â· ' + p.detail : ''}</div>
			</div>`;
		}).join('');

		// ì±„ì  ì§„í–‰ ì¤‘ì´ë©´ ê²°ê³¼ ëª©ë¡ë„ ì£¼ê¸°ì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
		if (active.length > 0 && !container._reloadScheduled) {
			container._reloadScheduled = true;
			setTimeout(() => {
				loadResults();
				container._reloadScheduled = false;
			}, 10000);
		}
	} catch (e) {
		// í´ë§ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
	}
}

async function loadResults() {
	if (!currentTeacher) return;
	try {
		const params = new URLSearchParams({ teacher_id: currentTeacher.owner_user_id });
		const res = await fetch(`${GRADING_SERVER_URL}/api/results?${params}`);
		if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
		const result = await res.json();
		currentResults = result.data || [];
	} catch (e) {
		console.warn('ì±„ì  ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', e);
		showToast('ì±„ì  ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
		currentResults = [];
	}
	renderCalendar();
}

function filterResults(filter) {
	currentFilter = filter;
	document.querySelectorAll('.cal-side-filter button').forEach(b => b.classList.remove('active'));
	const btn = document.querySelector(`.cal-side-filter button[data-filter="${filter}"]`);
	if (btn) btn.classList.add('active');
	renderSidePanel();
}

// ============================================================
// ë‹¬ë ¥ ì½”ì–´
// ============================================================
function _dateStr(y, m, d) {
	return `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
}
function _toDateStr(dt) {
	if (!dt) return '';
	const d = new Date(dt);
	if (isNaN(d)) return '';
	return _dateStr(d.getFullYear(), d.getMonth(), d.getDate());
}
function _formatDateHeader(ds) {
	if (!ds) return 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”';
	const d = new Date(ds + 'T00:00:00');
	const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
	return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
}

function _getCalendarEvents() {
	const resultsByDate = {};
	const assignsByDate = {};
	for (const r of currentResults) {
		const ds = _toDateStr(r.created_at);
		if (!ds) continue;
		if (!resultsByDate[ds]) resultsByDate[ds] = [];
		resultsByDate[ds].push(r);
	}
	for (const a of currentAssignments) {
		const ds = a.due_date || '';
		if (!ds) continue;
		if (!assignsByDate[ds]) assignsByDate[ds] = [];
		assignsByDate[ds].push(a);
	}
	return { resultsByDate, assignsByDate };
}

function renderCalendar() {
	const grid = document.getElementById('cal-grid');
	const titleEl = document.getElementById('cal-title');
	if (!grid || !titleEl) return;

	titleEl.textContent = `${calYear}ë…„ ${calMonth + 1}ì›”`;

	const firstDay = new Date(calYear, calMonth, 1);
	const lastDay = new Date(calYear, calMonth + 1, 0);
	let startDow = firstDay.getDay();
	if (startDow === 0) startDow = 7;
	startDow--;

	const today = new Date();
	const todayStr = _dateStr(today.getFullYear(), today.getMonth(), today.getDate());

	const { resultsByDate, assignsByDate } = _getCalendarEvents();

	let html = '';

	const prevLast = new Date(calYear, calMonth, 0);
	for (let i = startDow - 1; i >= 0; i--) {
		const d = prevLast.getDate() - i;
		const ds = _dateStr(prevLast.getFullYear(), prevLast.getMonth(), d);
		html += _renderCell(d, ds, 'other', todayStr, resultsByDate, assignsByDate);
	}

	for (let d = 1; d <= lastDay.getDate(); d++) {
		const ds = _dateStr(calYear, calMonth, d);
		html += _renderCell(d, ds, '', todayStr, resultsByDate, assignsByDate);
	}

	const totalCells = startDow + lastDay.getDate();
	const remaining = (7 - (totalCells % 7)) % 7;
	for (let d = 1; d <= remaining; d++) {
		const nextMonth = calMonth + 1;
		const ny = nextMonth > 11 ? calYear + 1 : calYear;
		const nm = nextMonth > 11 ? 0 : nextMonth;
		const ds = _dateStr(ny, nm, d);
		html += _renderCell(d, ds, 'other', todayStr, resultsByDate, assignsByDate);
	}

	grid.innerHTML = html;
	renderSidePanel();
}

function _renderCell(d, ds, extraCls, todayStr, resultsByDate, assignsByDate) {
	const isToday = ds === todayStr;
	const isSelected = ds === calSelectedDate;
	const dow = new Date(ds + 'T00:00:00').getDay();
	const dowCls = dow === 0 ? 'cal-sun' : dow === 6 ? 'cal-sat' : '';
	let cls = `cal-cell ${dowCls}`;
	if (isToday) cls += ' cal-today';
	if (isSelected) cls += ' cal-selected';
	if (extraCls) cls += ` cal-${extraCls}`;

	let dots = '';
	const assigns = assignsByDate[ds];
	const results = resultsByDate[ds];
	if (assigns || results) {
		dots = '<div class="cal-dots">';
		if (assigns) dots += '<span class="cal-dot dot-assign"></span>';
		if (results) {
			const statuses = new Set(results.map(r => r.status));
			if (statuses.has('confirmed')) dots += '<span class="cal-dot dot-confirmed"></span>';
			if (statuses.has('review_needed')) dots += '<span class="cal-dot dot-review"></span>';
			if (statuses.has('failed')) dots += '<span class="cal-dot dot-failed"></span>';
			if (statuses.has('grading') || statuses.has('regrading')) dots += '<span class="cal-dot dot-grading"></span>';
		}
		dots += '</div>';
		const cnt = (assigns ? assigns.length : 0) + (results ? results.length : 0);
		if (cnt > 1) dots += `<span class="cal-count">${cnt}ê±´</span>`;
	}

	return `<div class="${cls}" onclick="selectDate('${ds}')">
		<span class="cal-date">${d}</span>${dots}</div>`;
}

function navigateMonth(delta) {
	calMonth += delta;
	if (calMonth > 11) { calMonth = 0; calYear++; }
	else if (calMonth < 0) { calMonth = 11; calYear--; }
	calSelectedDate = '';
	renderCalendar();
}

function goToday() {
	const t = new Date();
	calYear = t.getFullYear();
	calMonth = t.getMonth();
	calSelectedDate = _dateStr(t.getFullYear(), t.getMonth(), t.getDate());
	renderCalendar();
}

function selectDate(ds) {
	calSelectedDate = ds;
	renderCalendar();
}

function switchSideTab(tab, e) {
	calSideTab = tab;
	document.querySelectorAll('.cal-side-tab').forEach(b => b.classList.remove('active'));
	if (e) (e.target.closest('.cal-side-tab') || e.target).classList.add('active');
	else {
		const btn = document.getElementById('side-tab-' + tab);
		if (btn) btn.classList.add('active');
	}
	renderSidePanel();
}

function renderSidePanel() {
	const header = document.getElementById('cal-side-header');
	const content = document.getElementById('cal-side-content');
	if (!header || !content) return;

	header.textContent = _formatDateHeader(calSelectedDate);

	if (!calSelectedDate) {
		content.innerHTML = '<div class="empty-state" style="padding:30px 10px;"><i class="fas fa-calendar-day" style="font-size:32px;margin-bottom:8px;opacity:0.3;"></i><p style="font-size:13px;">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ì¼ì˜<br>ê³¼ì œì™€ ì±„ì  ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p></div>';
		return;
	}

	const { resultsByDate, assignsByDate } = _getCalendarEvents();

	if (calSideTab === 'assign') {
		const addBtn = `<button class="btn btn-primary btn-sm" style="width:100%;margin-bottom:10px;font-size:12px;" onclick="showAssignModal('${calSelectedDate}')"><i class="fas fa-plus" style="margin-right:4px;"></i>ê³¼ì œ ë°°ì •</button>`;
		const items = assignsByDate[calSelectedDate] || [];
		if (!items.length) {
			content.innerHTML = addBtn + '<div class="empty-state" style="padding:20px 10px;"><i class="fas fa-clipboard-list" style="font-size:28px;margin-bottom:8px;opacity:0.3;"></i><p style="font-size:12px;">ì´ ë‚ ì§œì— ë°°ì •ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
			return;
		}
		content.innerHTML = addBtn + items.map(a => {
			const key = a.answer_keys;
			const students = a.assigned_students || [];
			const stuTags = students.length ? `<div class="cal-assign-students">${students.slice(0, 5).map(sid => `<span class="cal-assign-tag">${sid}</span>`).join('')}${students.length > 5 ? `<span class="cal-assign-tag">+${students.length - 5}</span>` : ''}</div>` : '';
			return `<div class="cal-assign-item" style="cursor:pointer;" onclick="editAssignment(${a.id})">
				<div class="cal-assign-title">${escapeHtml(a.title)}</div>
				<div class="cal-assign-sub">${key ? escapeHtml(key.title) + (key.subject ? ' Â· ' + escapeHtml(key.subject) : '') : 'ìë™ ê²€ìƒ‰'}${a.page_range ? ' Â· p.' + escapeHtml(a.page_range) : ''}</div>
				${stuTags}
				<button class="cal-assign-del" onclick="event.stopPropagation();deleteAssignment(${a.id})" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
			</div>`;
		}).join('');
	} else {
		let results = resultsByDate[calSelectedDate] || [];
		const filterHtml = `<div class="cal-side-filter">
			<button data-filter="all" class="${currentFilter === 'all' ? 'active' : ''}" onclick="filterResults('all')">ì „ì²´</button>
			<button data-filter="review_needed" class="${currentFilter === 'review_needed' ? 'active' : ''}" onclick="filterResults('review_needed')">ê²€í†  í•„ìš”</button>
			<button data-filter="confirmed" class="${currentFilter === 'confirmed' ? 'active' : ''}" onclick="filterResults('confirmed')">í™•ì •</button>
		</div>`;

		if (currentFilter !== 'all') {
			results = results.filter(r => r.status === currentFilter);
		}

		if (!results.length) {
			content.innerHTML = filterHtml + '<div class="empty-state" style="padding:20px 10px;"><i class="fas fa-inbox" style="font-size:28px;margin-bottom:8px;opacity:0.3;"></i><p style="font-size:12px;">ì´ ë‚ ì§œì— ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
			return;
		}

		const statusMap = {
			confirmed: { cls:'badge-confirmed', text:'í™•ì •', bg:'rgba(34,197,94,0.15)', icon:'âœ…' },
			review_needed: { cls:'badge-review', text:'ê²€í†  í•„ìš”', bg:'rgba(234,179,8,0.15)', icon:'âš ï¸' },
			failed: { cls:'badge-failed', text:'ì±„ì  ì‹¤íŒ¨', bg:'rgba(239,68,68,0.15)', icon:'âŒ' },
			regrading: { cls:'badge-regrading', text:'ì¬ì±„ì  ì¤‘', bg:'rgba(129,140,248,0.15)', icon:'ğŸ”„' },
		};

		content.innerHTML = filterHtml + results.map(r => {
			const student = r.students || {};
			const sm = statusMap[r.status] || { cls:'badge-grading', text:'ì±„ì  ì¤‘', bg:'rgba(129,140,248,0.15)', icon:'â³' };
			const unanswered = r.unanswered_count || 0;
			const unansweredTag = unanswered > 0 ? ` Â· ë¯¸í’€ì´ ${unanswered}` : '';
			return `<div class="cal-result-item" onclick="openDetail(${r.id})">
				<div class="cal-result-icon" style="background:${sm.bg};">${sm.icon}</div>
				<div class="cal-result-info">
					<div class="cal-result-title">${escapeHtml(student.name || '?')} Â· ${r.total_score}/${r.max_score}ì </div>
					<div class="cal-result-sub">â­•${r.correct_count} âœ˜${r.wrong_count} â“${r.uncertain_count}${unansweredTag}</div>
				</div>
				<span class="cal-result-badge ${sm.cls}">${sm.text}</span>
				<button class="cal-result-del" onclick="event.stopPropagation();deleteResult(${r.id},'${escapeHtml(student.name || '?')}')" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
			</div>`;
		}).join('');
	}
}

// ============================================================
// ì±„ì  ìƒì„¸
// ============================================================
let _detailPollTimer = null;

function _stopDetailPoll() {
	if (_detailPollTimer) { clearInterval(_detailPollTimer); _detailPollTimer = null; }
}

function _renderDetailStatusBanner(result) {
	const banner = document.getElementById('detail-status-banner');
	if (!banner) return;
	const st = result.status;
	const errMsg = result.error_message || '';

	if (st === 'confirmed') {
		banner.style.display = 'none';
		return;
	}

	banner.style.display = 'flex';
	if (st === 'grading' || st === 'regrading') {
		const label = st === 'regrading' ? 'ì¬ì±„ì  ì¤‘' : 'ì±„ì  ì§„í–‰ ì¤‘';
		banner.className = 'detail-status-banner status-grading';
		banner.innerHTML = `<span class="status-icon status-pulse">â³</span>
			<div class="status-text"><strong>${label}...</strong>ì ì‹œ í›„ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.
			<div class="detail-progress-bar"><div class="detail-progress-fill" id="detail-progress-fill" style="width:0%"></div></div></div>`;
	} else if (st === 'failed') {
		banner.className = 'detail-status-banner status-failed';
		banner.innerHTML = `<span class="status-icon">âŒ</span>
			<div class="status-text"><strong>ì±„ì  ì‹¤íŒ¨</strong>${errMsg ? escapeHtml(errMsg) : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`;
	} else if (st === 'review_needed') {
		banner.className = 'detail-status-banner status-review';
		banner.innerHTML = `<span class="status-icon">âš ï¸</span>
			<div class="status-text"><strong>ê²€í†  í•„ìš”</strong>${errMsg ? escapeHtml(errMsg) : 'ì±„ì  ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}</div>`;
	} else {
		banner.style.display = 'none';
	}
}

async function _pollDetailResult() {
	if (!currentResultId) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/grading-progress?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		if (!res.ok) return;
		const progressData = await res.json();
		const myProgress = (progressData.data || []).find(p => p.result_id === currentResultId);
		if (myProgress) {
			const fill = document.getElementById('detail-progress-fill');
			if (fill) fill.style.width = (myProgress.percent || 0) + '%';
		}
	} catch(e) {}

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		if (!res.ok) return;
		const result = await res.json();
		const updated = (result.data || []).find(r => r.id === currentResultId);
		if (updated && updated.status !== 'grading' && updated.status !== 'regrading') {
			_stopDetailPoll();
			const idx = currentResults.findIndex(r => r.id === currentResultId);
			if (idx >= 0) currentResults[idx] = updated;
			await openDetail(currentResultId);
			showToast('ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
		}
	} catch(e) {}
}

async function openDetail(resultId) {
	currentResultId = resultId;
	_stopDetailPoll();

	const result = currentResults.find(r => r.id === resultId);
	if (!result) {
		showToast('ì±„ì  ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.', 'error');
		await loadResults();
		const retryResult = currentResults.find(r => r.id === resultId);
		if (!retryResult) {
			showToast('í•´ë‹¹ ì±„ì  ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
			showPage('main');
			return;
		}
		return openDetail(resultId);
	}

	const detailTitle = (result.students?.name || '?') + ' ì±„ì  ìƒì„¸';
	document.getElementById('detail-title').textContent = detailTitle;
	document.getElementById('detail-score').textContent = result.total_score + '/' + result.max_score;
	document.getElementById('detail-correct').textContent = result.correct_count;
	document.getElementById('detail-wrong').textContent = result.wrong_count;
	document.getElementById('detail-uncertain').textContent = result.uncertain_count;
	document.getElementById('detail-total').textContent = result.total_questions;
	const unansweredEl = document.getElementById('detail-unanswered');
	if (unansweredEl) unansweredEl.textContent = result.unanswered_count || 0;
	const pageInfoEl = document.getElementById('detail-page-info');
	if (pageInfoEl) {
		pageInfoEl.textContent = result.page_info || '';
		pageInfoEl.style.display = result.page_info ? 'block' : 'none';
	}
	document.getElementById('detail-memo').value = result.teacher_memo || '';
	document.getElementById('detail-confirm-btn').style.display = result.status === 'confirmed' ? 'none' : 'inline-flex';

	_renderDetailStatusBanner(result);

	if (result.status === 'grading' || result.status === 'regrading') {
		_detailPollTimer = setInterval(_pollDetailResult, 3000);
	}

	// êµì¬ ë“œë¡­ë‹¤ìš´ êµ¬ì„±
	const keySelect = document.getElementById('detail-key-select');
	keySelect.innerHTML = '<option value="">êµì¬ ì—†ìŒ</option>';
	try {
		const keysRes = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		if (!keysRes.ok) throw new Error(`HTTP ${keysRes.status}`);
		const keysData = await keysRes.json();
		const keys = keysData.data || [];
		for (const k of keys) {
			const opt = document.createElement('option');
			opt.value = k.id;
			opt.textContent = `${k.title}${k.subject ? ' (' + k.subject + ')' : ''}`;
			keySelect.appendChild(opt);
		}
	} catch(e) { console.warn('êµì¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e); }
	if (result.answer_key_id) keySelect.value = String(result.answer_key_id);

	// ì±„ì  ì´ë¯¸ì§€ (ì¤‘ì•™ ë“œë¼ì´ë¸Œ ìš°ì„ )
	currentImageUrls = result.central_graded_image_urls || result.teacher_graded_image_urls || [];
	currentImageIdx = 0;
	loadCurrentImage();

	// ë¬¸í•­ë³„ ë¡œë“œ
	try {
		const itemsRes = await fetch(`${GRADING_SERVER_URL}/api/results/${resultId}/items`);
		if (!itemsRes.ok) throw new Error(`HTTP ${itemsRes.status}`);
		const itemsResult = await itemsRes.json();
		currentItems = itemsResult.data || [];
	} catch (e) {
		console.warn('ë¬¸í•­ ë¡œë“œ ì‹¤íŒ¨:', e);
		showToast('ë¬¸í•­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
		currentItems = [];
	}
	// Split View ì´ˆê¸°í™”
	selectedItemIdx = -1;
	imageZoom = 1;
	renderQuestionGrid();
	renderAnswerPanel();

	// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í™œì„±í™”
	document.addEventListener('keydown', handleDetailKeydown);

	showPage('detail');
}

function renderQuestionGrid() {
	const grid = document.getElementById('detail-grid');
	grid.innerHTML = currentItems.map((item, idx) => {
		const isUnanswered = item.student_answer === '(ë¯¸í’€ì´)' || item.ai_feedback === 'í•™ìƒì´ í’€ì§€ ì•Šì€ ë¬¸ì œ';
		let cls, titleText;
		if (isUnanswered) {
			cls = 'q-unanswered';
			titleText = `ë¬¸ì œ ${item.question_number} (ë¯¸í’€ì´)`;
		} else if (item.is_correct === true) {
			cls = 'q-correct';
			titleText = `ë¬¸ì œ ${item.question_number}`;
		} else if (item.is_correct === false) {
			cls = 'q-wrong';
			titleText = `ë¬¸ì œ ${item.question_number}`;
		} else {
			cls = 'q-uncertain';
			titleText = `ë¬¸ì œ ${item.question_number} (í™•ì¸í•„ìš”)`;
		}
		const selCls = idx === selectedItemIdx ? ' q-selected' : '';
		return `<div class="q-cell ${cls}${selCls}" onclick="selectItem(${idx})" title="${titleText}">${item.question_number}</div>`;
	}).join('');
	renderAnswerPanel();
}

function openItemEdit(itemId) {
	const item = currentItems.find(i => i.id === itemId);
	if (!item) return;

	document.getElementById('item-modal-title').textContent = `${item.question_number}ë²ˆ ë¬¸í•­`;
	document.getElementById('item-student-answer').textContent = item.student_answer || '(ì¸ì‹ ì‹¤íŒ¨)';
	document.getElementById('item-correct-answer').textContent = item.correct_answer || '-';
	document.getElementById('item-teacher-score').value = item.teacher_score ?? item.ai_score ?? '';
	document.getElementById('item-teacher-feedback').value = item.teacher_feedback || '';

	const aiSection = document.getElementById('item-ai-section');
	if (item.question_type === 'essay' && item.ai_feedback) {
		aiSection.style.display = 'block';
		document.getElementById('item-ai-feedback').textContent = item.ai_feedback;
	} else {
		aiSection.style.display = 'none';
	}

	document.getElementById('item-modal').dataset.itemId = itemId;
	document.getElementById('item-modal').classList.add('show');
}

async function saveItemEdit() {
	const itemId = parseInt(document.getElementById('item-modal').dataset.itemId);
	const score = document.getElementById('item-teacher-score').value;
	const feedback = document.getElementById('item-teacher-feedback').value;

	const updates = {};
	if (score !== '') updates.teacher_score = parseFloat(score);
	if (feedback) updates.teacher_feedback = feedback;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/items/${itemId}`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(updates),
		});
		if (!res.ok) return showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}

	showToast('ì €ì¥ ì™„ë£Œ', 'success');
	closeModal('item-modal');

	// ìƒˆë¡œê³ ì¹¨
	try {
		const itemsRes = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/items`);
		const itemsResult = await itemsRes.json();
		currentItems = itemsResult.data || [];
	} catch (e) {
		currentItems = [];
	}
	renderQuestionGrid();
}

async function confirmResult() {
	if (!currentResultId) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/confirm`, { method: 'PUT' });
		const result = await res.json();
		if (!result.data) return showToast('í™•ì • ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast('ì±„ì  ê²°ê³¼ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
	document.getElementById('detail-confirm-btn').style.display = 'none';
	loadResults();
}

async function regradeWithKey() {
	if (!currentResultId) return;
	const keySelect = document.getElementById('detail-key-select');
	const selectedKeyId = keySelect.value;

	if (!selectedKeyId) {
		showToast('êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
		return;
	}

	const result = currentResults.find(r => r.id === currentResultId);
	const changed = result && String(result.answer_key_id) !== selectedKeyId;
	const msg = changed
		? 'ì„ íƒí•œ êµì¬ë¡œ ë³€ê²½í•˜ê³  ì¬ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
		: 'í˜„ì¬ êµì¬ë¡œ ì¬ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì •ë‹µì„ ìˆ˜ì •í•œ ê²½ìš° ìµœì‹  ì •ë‹µì´ ë°˜ì˜ë©ë‹ˆë‹¤)';
	if (!confirm(msg)) return;

	const btn = document.getElementById('detail-regrade-btn');
	btn.disabled = true;
	btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:4px;"></i>ì¬ì±„ì  ì¤‘...';

	try {
		const body = changed ? { answer_key_id: parseInt(selectedKeyId) } : {};
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/regrade`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(body),
		});
		const data = await res.json();
		if (!res.ok) throw new Error(data.detail || 'ì¬ì±„ì  ì‹¤íŒ¨');

		showToast(`ì¬ì±„ì  ì™„ë£Œ: ${data.correct_count}ë§ / ${data.wrong_count}í‹€ / ${data.uncertain_count}í™•ì¸í•„ìš”`, 'success');
		await loadResults();
		await openDetail(currentResultId);
	} catch (e) {
		showToast('ì¬ì±„ì  ì‹¤íŒ¨: ' + e.message, 'error');
	} finally {
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-sync-alt" style="margin-right:4px;"></i>ì¬ì±„ì ';
	}
}

async function deleteResult(resultId, studentName) {
	if (!confirm(`"${studentName}" ì±„ì  ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${resultId}`, { method: 'DELETE' });
		const result = await res.json();
		if (result.success) {
			showToast('ì±„ì  ê²°ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
			loadResults();
		} else {
			showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.message || ''), 'error');
		}
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// í•™ìƒ ëª©ë¡ & êµì¬ ì§€ì • (ë“œë˜ê·¸ ì•¤ ë“œë¡­)
// ============================================================
let stuAllStudents = [];
let stuAllBooks = [];
let stuBookMap = {};
let _stuDragKeyId = null;

async function loadStudentList() {
	if (!currentTeacher) return;
	try {
		const { data: d1 } = await db.from('students').select('id, name, grade, school').eq('owner_user_id', currentTeacher.owner_user_id).order('name');
		const { data: d2 } = await db.from('students').select('id, name, grade, school').eq('teacher_id', currentTeacher.id).order('name');
		const merged = new Map();
		[...(d1 || []), ...(d2 || [])].forEach(s => merged.set(s.id, s));
		stuAllStudents = [...merged.values()].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
	} catch (e) { stuAllStudents = []; }

	try {
		const keysRes = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		stuAllBooks = (await keysRes.json()).data || [];
	} catch (e) { stuAllBooks = []; }

	try {
		const booksRes = await fetch(`${GRADING_SERVER_URL}/api/student-books?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const allLinks = (await booksRes.json()).data || [];
		stuBookMap = {};
		allLinks.forEach(link => {
			const sid = link.student_id;
			if (!stuBookMap[sid]) stuBookMap[sid] = [];
			stuBookMap[sid].push(link);
		});
	} catch (e) { stuBookMap = {}; }

	renderStuSidebar();
	renderStudentList();
}

function renderStuSidebar() {
	const el = document.getElementById('stu-book-drag-list');
	if (!el) return;
	if (!stuAllBooks.length) {
		el.innerHTML = '<div style="font-size:11px;color:var(--text-sec);text-align:center;padding:16px 0;">ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤<br><span style="font-size:10px;">êµì¬ ê´€ë¦¬ íƒ­ì—ì„œ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</span></div>';
		return;
	}
	el.innerHTML = stuAllBooks.map(k =>
		`<div class="stu-drag-item" draggable="true" data-key-id="${k.id}" title="${escapeHtml(k.title)}">
			<span class="stu-drag-icon"><i class="fas fa-grip-vertical"></i></span>
			<span class="stu-drag-title">${escapeHtml(k.title)}</span>
			${k.subject ? `<span class="stu-drag-sub">${escapeHtml(k.subject)}</span>` : ''}
		</div>`
	).join('');

	el.querySelectorAll('.stu-drag-item').forEach(item => {
		item.addEventListener('dragstart', e => {
			_stuDragKeyId = item.dataset.keyId;
			e.dataTransfer.effectAllowed = 'copy';
			e.dataTransfer.setData('text/plain', item.dataset.keyId);
			item.classList.add('dragging');
		});
		item.addEventListener('dragend', () => {
			_stuDragKeyId = null;
			item.classList.remove('dragging');
			document.querySelectorAll('.stu-card.drop-over').forEach(c => c.classList.remove('drop-over'));
		});
	});
}

function filterStudentList() { renderStudentList(); }

function renderStudentList() {
	const container = document.getElementById('stu-list-container');
	if (!container) return;
	const q = (document.getElementById('stu-tab-search')?.value || '').trim().toLowerCase();
	let list = stuAllStudents;
	if (q) list = list.filter(s => (s.name || '').toLowerCase().includes(q) || (s.school || '').toLowerCase().includes(q));

	if (!list.length) {
		container.innerHTML = '<div class="empty-state" style="padding:40px 10px;"><i class="fas fa-user-graduate" style="font-size:32px;margin-bottom:8px;opacity:0.3;"></i><p style="font-size:13px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}

	const grouped = {};
	list.forEach(s => {
		const g = s.grade ? s.grade + 'í•™ë…„' : 'ë¯¸ì§€ì •';
		if (!grouped[g]) grouped[g] = [];
		grouped[g].push(s);
	});

	const _gradeRank = g => {
		if (g === 'ë¯¸ì§€ì •') return 9999;
		const m = g.match(/(ì´ˆ|ì¤‘|ê³ )(\d+)/);
		if (!m) return 9000;
		const level = { 'ì´ˆ': 0, 'ì¤‘': 100, 'ê³ ': 200 }[m[1]] || 0;
		return level + parseInt(m[2]);
	};
	const gradeOrder = Object.keys(grouped).sort((a, b) => _gradeRank(a) - _gradeRank(b));

	let html = '';
	gradeOrder.forEach(grade => {
		const students = grouped[grade];
		html += `<div class="stu-grade-group">
			<div class="stu-grade-header"><i class="fas fa-users" style="font-size:12px;"></i> ${escapeHtml(grade)} <span class="stu-grade-count">(${students.length}ëª…)</span></div>`;
		students.forEach(s => {
			const books = stuBookMap[s.id] || [];
			const initial = (s.name || '?')[0];
			const bookTags = books.slice(0, 3).map(b => {
				const ak = b.answer_keys || {};
				return `<span class="stu-book-tag">${escapeHtml(ak.title || '?')}</span>`;
			}).join('') + (books.length > 3 ? `<span class="stu-book-tag">+${books.length - 3}</span>` : '');

			const bookListHtml = books.length
				? books.map(b => {
					const ak = b.answer_keys || {};
					return `<div class="stu-book-item">
						<span class="stu-book-title">${escapeHtml(ak.title || '?')}</span>
						<span class="stu-book-subject">${escapeHtml(ak.subject || '')}</span>
						<button class="stu-book-del" onclick="event.stopPropagation();removeStudentBook(${b.id},${s.id})" title="ì œê±°"><i class="fas fa-times"></i></button>
					</div>`;
				}).join('')
				: '<div class="stu-empty-books"><i class="fas fa-arrow-left" style="margin-right:4px;opacity:0.4;"></i>ì™¼ìª½ì—ì„œ êµì¬ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</div>';

			html += `<div class="stu-card" id="stu-card-${s.id}" data-student-id="${s.id}">
				<div class="stu-card-header" onclick="toggleStudentCard(${s.id})">
					<div class="stu-card-avatar">${escapeHtml(initial)}</div>
					<div class="stu-card-info">
						<div class="stu-card-name">${escapeHtml(s.name || 'ì´ë¦„ ì—†ìŒ')}</div>
						<div class="stu-card-meta">${s.school ? escapeHtml(s.school) : ''}</div>
					</div>
					<div class="stu-card-books-preview">${bookTags}</div>
					<span class="stu-card-toggle"><i class="fas fa-chevron-down"></i></span>
				</div>
				<div class="stu-card-body">
					<div class="stu-book-list">${bookListHtml}</div>
				</div>
			</div>`;
		});
		html += '</div>';
	});

	container.innerHTML = html;

	container.querySelectorAll('.stu-card').forEach(card => {
		const sid = parseInt(card.dataset.studentId);
		card.addEventListener('dragover', e => {
			e.preventDefault();
			e.dataTransfer.dropEffect = 'copy';
			card.classList.add('drop-over');
		});
		card.addEventListener('dragleave', e => {
			if (!card.contains(e.relatedTarget)) card.classList.remove('drop-over');
		});
		card.addEventListener('drop', async e => {
			e.preventDefault();
			card.classList.remove('drop-over');
			const keyId = e.dataTransfer.getData('text/plain') || _stuDragKeyId;
			if (!keyId || !sid) return;
			const existing = (stuBookMap[sid] || []).some(b => String(b.answer_key_id) === String(keyId));
			if (existing) return showToast('ì´ë¯¸ ë°°ì •ëœ êµì¬ì…ë‹ˆë‹¤', 'error');
			await addStudentBookDrop(sid, parseInt(keyId));
		});
	});
}

function toggleStudentCard(studentId) {
	const card = document.getElementById('stu-card-' + studentId);
	if (card) card.classList.toggle('open');
}

async function addStudentBookDrop(studentId, answerKeyId) {
	try {
		const formData = new FormData();
		formData.append('student_id', studentId);
		formData.append('answer_key_id', answerKeyId);
		formData.append('teacher_id', currentTeacher.owner_user_id);
		const res = await fetch(`${GRADING_SERVER_URL}/api/student-books`, { method: 'POST', body: formData });
		if (!res.ok) throw new Error('ì¶”ê°€ ì‹¤íŒ¨');
		const book = stuAllBooks.find(k => k.id === answerKeyId);
		showToast(`${book ? book.title : 'êµì¬'}ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
		await loadStudentList();
		const card = document.getElementById('stu-card-' + studentId);
		if (card) card.classList.add('open');
	} catch (e) {
		showToast('êµì¬ ë°°ì • ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

async function removeStudentBook(bookId, studentId) {
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/student-books/${bookId}`, { method: 'DELETE' });
		if (!res.ok) throw new Error('ì œê±° ì‹¤íŒ¨');
		showToast('êµì¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
		await loadStudentList();
		const card = document.getElementById('stu-card-' + studentId);
		if (card) card.classList.add('open');
	} catch (e) {
		showToast('êµì¬ ì œê±° ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// ê³¼ì œ ë°°ì •
// ============================================================
async function loadAssignments() {
	if (!currentTeacher) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/assignments?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		currentAssignments = result.data || [];
	} catch (e) {
		console.warn('ê³¼ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
		currentAssignments = [];
	}
	renderCalendar();
}

let assignStudentList = [];
let assignSelectedStudents = [];
let editingAssignmentId = null;

async function showAssignModal(prefillDate) {
	editingAssignmentId = null;
	let keys = [];
	assignSelectedStudents = [];
	try {
		const keysRes = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		keys = (await keysRes.json()).data || [];
	} catch (e) {}

	try {
		// owner_user_id ë˜ëŠ” teacher_idë¡œ ì—°ê²°ëœ í•™ìƒ ëª¨ë‘ ì¡°íšŒ
		const { data: d1 } = await db.from('students').select('id, name, grade, school').eq('owner_user_id', currentTeacher.owner_user_id).order('name');
		const { data: d2 } = await db.from('students').select('id, name, grade, school').eq('teacher_id', currentTeacher.id).order('name');
		const merged = new Map();
		[...(d1 || []), ...(d2 || [])].forEach(s => merged.set(s.id, s));
		assignStudentList = [...merged.values()].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
	} catch (e) {
		console.warn('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
	}

	const sel = document.getElementById('assign-key');
	sel.innerHTML = '<option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>' + keys.map(k => `<option value="${k.id}">${k.title} (${k.subject || ''})</option>`).join('');
	document.getElementById('assign-student-search').value = '';
	document.getElementById('assign-title').value = '';
	document.getElementById('assign-pages').value = '';
	renderSelectedStudents();
	document.getElementById('assign-student-dropdown').style.display = 'none';

	const dueInput = document.getElementById('assign-due');
	dueInput.value = prefillDate || '';

	document.getElementById('assign-modal-title').textContent = editingAssignmentId ? 'ê³¼ì œ ìˆ˜ì •' : 'ê³¼ì œ ë°°ì •';
	document.getElementById('assign-modal-btn').textContent = editingAssignmentId ? 'ìˆ˜ì •' : 'ë°°ì •';
	document.getElementById('assign-modal').classList.add('show');
}

function showStudentDropdown() {
	filterStudentDropdown();
}

function filterStudentDropdown() {
	const query = document.getElementById('assign-student-search').value.trim().toLowerCase();
	const dropdown = document.getElementById('assign-student-dropdown');
	const selectedIds = assignSelectedStudents.map(s => s.id);
	const filtered = assignStudentList.filter(s =>
		!selectedIds.includes(s.id) && (
			!query || s.name.toLowerCase().includes(query) ||
			(s.grade && s.grade.toLowerCase().includes(query))
		)
	);

	if (!filtered.length) {
		dropdown.innerHTML = '<div style="padding:10px 14px;font-size:12px;color:var(--text-sec);">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
	} else {
		dropdown.innerHTML = filtered.map(s =>
			`<div class="stu-drop-item" onmousedown="addStudent(${s.id})">${escapeHtml(s.name)}<span class="stu-grade">${s.grade || ''}</span></div>`
		).join('');
	}
	dropdown.style.display = 'block';
}

function addStudent(id) {
	const stu = assignStudentList.find(s => s.id === id);
	if (!stu || assignSelectedStudents.find(s => s.id === id)) return;
	assignSelectedStudents.push(stu);
	document.getElementById('assign-student-search').value = '';
	document.getElementById('assign-student-dropdown').style.display = 'none';
	renderSelectedStudents();
}

function removeStudent(id) {
	assignSelectedStudents = assignSelectedStudents.filter(s => s.id !== id);
	renderSelectedStudents();
}

function renderSelectedStudents() {
	const el = document.getElementById('assign-selected-students');
	if (!assignSelectedStudents.length) {
		el.innerHTML = '<span style="font-size:11px;color:var(--text-sec);">ì„ íƒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</span>';
		return;
	}
	el.innerHTML = assignSelectedStudents.map(s =>
		`<span class="stu-tag">${escapeHtml(s.name)}<button onclick="removeStudent(${s.id})">&times;</button></span>`
	).join('');
}

async function editAssignment(assignId) {
	const a = currentAssignments.find(x => x.id === assignId);
	if (!a) return;
	editingAssignmentId = assignId;

	let keys = [];
	assignSelectedStudents = [];
	try {
		const keysRes = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		keys = (await keysRes.json()).data || [];
	} catch (e) {}
	try {
		const { data: d1 } = await db.from('students').select('id, name, grade, school').eq('owner_user_id', currentTeacher.owner_user_id).order('name');
		const { data: d2 } = await db.from('students').select('id, name, grade, school').eq('teacher_id', currentTeacher.id).order('name');
		const merged = new Map();
		[...(d1 || []), ...(d2 || [])].forEach(s => merged.set(s.id, s));
		assignStudentList = [...merged.values()].sort((x, y) => (x.name || '').localeCompare(y.name || ''));
	} catch (e) {}

	const sel = document.getElementById('assign-key');
	sel.innerHTML = '<option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>' + keys.map(k => `<option value="${k.id}">${k.title} (${k.subject || ''})</option>`).join('');

	document.getElementById('assign-title').value = a.title || '';
	sel.value = a.answer_key_id || '';
	document.getElementById('assign-pages').value = a.page_range || '';
	document.getElementById('assign-due').value = a.due_date || '';

	const stuIds = a.assigned_students || [];
	assignSelectedStudents = stuIds.map(sid => assignStudentList.find(s => s.id === sid)).filter(Boolean);
	renderSelectedStudents();

	document.getElementById('assign-student-search').value = '';
	document.getElementById('assign-student-dropdown').style.display = 'none';
	document.getElementById('assign-modal-title').textContent = 'ê³¼ì œ ìˆ˜ì •';
	document.getElementById('assign-modal-btn').textContent = 'ìˆ˜ì •';
	document.getElementById('assign-modal').classList.add('show');
}

async function createAssignment() {
	const title = document.getElementById('assign-title').value.trim();
	if (!title) return showToast('ê³¼ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

	const keyId = document.getElementById('assign-key').value;
	if (!keyId) return showToast('êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');

	const selectedStudents = assignSelectedStudents.map(s => s.id);
	if (!selectedStudents.length) return showToast('í•™ìƒì„ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');

	try {
		const formData = new FormData();
		formData.append('title', title);
		formData.append('answer_key_id', keyId);
		formData.append('page_range', document.getElementById('assign-pages').value);
		formData.append('assigned_students', JSON.stringify(selectedStudents));
		const due = document.getElementById('assign-due').value;
		if (due) formData.append('due_date', due);

		let res;
		if (editingAssignmentId) {
			res = await fetch(`${GRADING_SERVER_URL}/api/assignments/${editingAssignmentId}`, { method: 'PUT', body: formData });
		} else {
			formData.append('teacher_id', currentTeacher.owner_user_id);
			formData.append('mode', 'assigned');
			res = await fetch(`${GRADING_SERVER_URL}/api/assignments`, { method: 'POST', body: formData });
		}
		if (!res.ok) return showToast(editingAssignmentId ? 'ìˆ˜ì • ì‹¤íŒ¨' : 'ë°°ì • ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast(editingAssignmentId ? 'ê³¼ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê³¼ì œê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
	editingAssignmentId = null;
	closeModal('assign-modal');
	loadAssignments();
}

async function deleteAssignment(id) {
	if (!confirm('ì´ ê³¼ì œ ë°°ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/assignments/${id}`, { method: 'DELETE' });
		if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
		showToast('ê³¼ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
		loadAssignments();
	} catch (e) {
		showToast('ê³¼ì œ ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// êµì¬ ê´€ë¦¬
// ============================================================
async function loadAnswerKeys() {
	if (!currentTeacher) return;
	let data = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		data = result.data || [];
	} catch (e) {
		console.warn('êµì¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
	}
	const el = document.getElementById('keys-list');
	if (!data?.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><p>ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}
	el.innerHTML = data.map(k => `<div class="list-item" style="position:relative;">
		<div style="display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;" onclick="openKeyDetail(${k.id})">
			<div class="list-item-icon" style="background:rgba(20,184,166,0.15);">ğŸ“š</div>
			<div class="list-item-info" style="flex:1;">
				<div class="list-item-title">${escapeHtml(k.title)}</div>
				<div class="list-item-sub">${k.subject || 'ê³¼ëª© ë¯¸ì •'} Â· ${k.total_questions}ë¬¸ì œ Â· ${k.parsed ? 'âœ… íŒŒì‹±ì™„ë£Œ' : 'â³ íŒŒì‹±ì¤‘'}</div>
			</div>
		</div>
		<button onclick="event.stopPropagation();deleteAnswerKey(${k.id}, '${escapeHtml(k.title)}')" title="ì‚­ì œ"
			style="background:none;border:none;color:var(--red,#ef4444);cursor:pointer;padding:8px;font-size:16px;opacity:0.6;transition:opacity 0.2s;"
			onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
			<i class="fas fa-trash-alt"></i>
		</button>
	</div>`).join('');

	// ê³¼ì œ ë°°ì •ìš© ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
	const sel = document.getElementById('assign-key');
	if (sel) {
		sel.innerHTML = '<option value="">êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>' + data.map(k => `<option value="${k.id}">${k.title} (${k.subject || ''})</option>`).join('');
	}
}

async function deleteAnswerKey(id, title) {
	if (!confirm(`"${title}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì •ë‹µ ë°ì´í„° ë° ë“œë¼ì´ë¸Œ í˜ì´ì§€ ì´ë¯¸ì§€ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys/${id}?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`, {
			method: 'DELETE',
		});
		const result = await res.json();
		if (result.success) {
			showToast('êµì¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
			loadAnswerKeys();
		} else {
			showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.message || ''), 'error');
		}
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

let selectedKeyType = 'print';

function selectKeyType(type) {
	selectedKeyType = type;
	const printBtn = document.getElementById('key-type-print');
	const bookBtn = document.getElementById('key-type-book');
	const printInfo = document.getElementById('key-print-info');
	const bookInfo = document.getElementById('key-book-info');

	if (type === 'print') {
		printBtn.style.background = 'var(--primary)';
		printBtn.style.color = '#fff';
		printBtn.style.borderColor = 'var(--primary)';
		bookBtn.style.background = 'var(--card)';
		bookBtn.style.color = 'var(--text)';
		bookBtn.style.borderColor = 'var(--border)';
		printInfo.style.display = '';
		bookInfo.style.display = 'none';
	} else {
		bookBtn.style.background = 'var(--primary)';
		bookBtn.style.color = '#fff';
		bookBtn.style.borderColor = 'var(--primary)';
		printBtn.style.background = 'var(--card)';
		printBtn.style.color = 'var(--text)';
		printBtn.style.borderColor = 'var(--border)';
		printInfo.style.display = 'none';
		bookInfo.style.display = '';
	}
}

function showAddKeyModal() {
	selectedKeyType = 'print';
	selectKeyType('print');
	document.getElementById('key-title').value = '';
	document.getElementById('key-subject').value = '';
	document.getElementById('key-pdf').value = '';
	document.getElementById('key-total-hint').value = '';
	const ps = document.getElementById('key-page-start');
	const pe = document.getElementById('key-page-end');
	if (ps) ps.value = '';
	if (pe) pe.value = '';
	resetFileDropZone();
	document.getElementById('key-modal').classList.add('show');
}

function onKeyFileSelected(input) {
	if (input.files.length > 0) showFileInDropZone(input.files[0]);
}

function showFileInDropZone(file) {
	const zone = document.getElementById('key-file-drop');
	const content = document.getElementById('key-file-drop-content');
	const ext = file.name.split('.').pop().toUpperCase();
	const icon = ext === 'PDF' ? 'fa-file-pdf' : 'fa-file-alt';
	const size = file.size < 1024*1024
		? (file.size / 1024).toFixed(1) + ' KB'
		: (file.size / (1024*1024)).toFixed(1) + ' MB';
	content.innerHTML = `
		<i class="fas ${icon}" style="font-size:24px;color:var(--primary);margin-bottom:6px;"></i>
		<p style="margin:0;font-size:13px;font-weight:600;word-break:break-all;">${escapeHtml(file.name)}</p>
		<p style="margin:3px 0 0;font-size:11px;color:var(--text-sec);">${ext} Â· ${size}</p>
		<p style="margin:6px 0 0;font-size:10px;color:var(--primary);cursor:pointer;" onclick="event.stopPropagation();resetFileDropZone();"><i class="fas fa-times"></i> íŒŒì¼ ì œê±°</p>
	`;
	zone.classList.add('has-file');
}

function resetFileDropZone() {
	const zone = document.getElementById('key-file-drop');
	const content = document.getElementById('key-file-drop-content');
	const input = document.getElementById('key-pdf');
	if (input) input.value = '';
	if (zone) zone.classList.remove('has-file');
	if (content) content.innerHTML = `
		<i class="fas fa-cloud-upload-alt" style="font-size:28px;color:var(--primary);margin-bottom:8px;"></i>
		<p style="margin:0;font-size:13px;font-weight:600;">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
		<p style="margin:4px 0 0;font-size:11px;color:var(--text-sec);">PDF ë˜ëŠ” í•œê¸€(HML) íŒŒì¼ ì§€ì›</p>
	`;
}

(function initFileDrop() {
	document.addEventListener('DOMContentLoaded', () => {
		const zone = document.getElementById('key-file-drop');
		if (!zone) return;
		['dragenter','dragover'].forEach(ev =>
			zone.addEventListener(ev, (e) => { e.preventDefault(); zone.classList.add('drag-over'); })
		);
		['dragleave','drop'].forEach(ev =>
			zone.addEventListener(ev, () => zone.classList.remove('drag-over'))
		);
		zone.addEventListener('drop', (e) => {
			e.preventDefault();
			const files = e.dataTransfer.files;
			if (!files.length) return;
			const file = files[0];
			const ext = file.name.split('.').pop().toLowerCase();
			if (ext !== 'pdf' && ext !== 'hml') {
				showToast('PDF ë˜ëŠ” HML íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
				return;
			}
			const input = document.getElementById('key-pdf');
			const dt = new DataTransfer();
			dt.items.add(file);
			input.files = dt.files;
			showFileInDropZone(file);
		});
	});
})();

let isRegistering = false;
async function registerAnswerKey() {
	if (isRegistering) return;
	const title = document.getElementById('key-title').value.trim();
	const subject = document.getElementById('key-subject').value.trim();
	const pdfInput = document.getElementById('key-pdf');
	const totalHint = document.getElementById('key-total-hint').value.trim();

	// ì‹œì¤‘ êµì¬: í˜ì´ì§€ ë²”ìœ„ ì¡°í•©
	let pageRange = '';
	if (selectedKeyType === 'book') {
		const ps = document.getElementById('key-page-start').value.trim();
		const pe = document.getElementById('key-page-end').value.trim();
		if (ps && pe) {
			pageRange = `${ps}-${pe}`;
		} else if (ps) {
			pageRange = ps;
		}
	}

	if (!title) return showToast('êµì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

	if (pdfInput.files.length > 0) {
		const formData = new FormData();
		formData.append('teacher_id', currentTeacher.owner_user_id);
		formData.append('title', title);
		formData.append('subject', subject);
		formData.append('pdf_file', pdfInput.files[0]);
		if (pageRange) formData.append('answer_page_range', pageRange);
		if (totalHint) formData.append('total_hint', totalHint);

		isRegistering = true;
		const isHml = pdfInput.files[0].name.toLowerCase().endsWith('.hml');
		showToast(isHml ? 'í•œê¸€ íŒŒì¼ì—ì„œ ì •ë‹µ ì¶”ì¶œ ì¤‘...' : 'ì •ë‹µ ì¶”ì¶œ ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)', 'info');

		try {
			const res = await fetch(GRADING_SERVER_URL + '/api/answer-keys/parse', {
				method: 'POST',
				body: formData,
			});
			const result = await res.json();

			if (result.data) {
				const cnt = result.parsed_result?.total || 0;
				if (isHml) {
					showToast(`êµì¬ ë“±ë¡ ì™„ë£Œ! ${cnt}ë¬¸ì œ ì¶”ì¶œ (HMLì€ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸° ë¯¸ì§€ì›)`, 'success');
				} else {
					showToast(`êµì¬ ë“±ë¡ ì™„ë£Œ! ${cnt}ë¬¸ì œ ì¶”ì¶œ â€” í˜ì´ì§€ ì´ë¯¸ì§€ ë°±ê·¸ë¼ìš´ë“œ ì—…ë¡œë“œ ì¤‘`, 'success');
				}
				closeModal('key-modal');
				loadAnswerKeys();
			} else {
				showToast('ë“±ë¡ ì‹¤íŒ¨', 'error');
			}
		} catch (e) {
			showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
		} finally {
			isRegistering = false;
		}
	} else {
		// PDF ì—†ì´ ìˆ˜ë™ ë“±ë¡ (ì„œë²„ API)
		try {
			const formData = new FormData();
			formData.append('teacher_id', currentTeacher.owner_user_id);
			formData.append('title', title);
			formData.append('subject', subject);
			const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys/parse`, { method: 'POST', body: formData });
			if (!res.ok) return showToast('ë“±ë¡ ì‹¤íŒ¨', 'error');
		} catch (e) {
			return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
		}
		showToast('êµì¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ (ì •ë‹µì€ ë‚˜ì¤‘ì— ì¶”ê°€)', 'success');
		closeModal('key-modal');
		loadAnswerKeys();
	}
}

async function scanDrivePDFs() {
	showToast('ì¤‘ì•™ ë“œë¼ì´ë¸Œì—ì„œ ìŠ¤ìº” ì¤‘...', 'info');
	try {
		const res = await fetch(GRADING_SERVER_URL + '/api/answer-keys/drive-pdfs');
		const result = await res.json();
		const pdfs = result.data || [];
		showToast(`ìˆ™ì œ ì±„ì  ìë£Œ í´ë”ì—ì„œ ${pdfs.length}ê°œ PDF ë°œê²¬`, pdfs.length > 0 ? 'success' : 'info');
	} catch (e) {
		showToast('ìŠ¤ìº” ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// êµì¬ ìƒì„¸ í¸ì§‘
// ============================================================
let currentKeyDetail = null;
let kdQuestions = [];
let kdPageImages = [];
let kdCurrentPage = 0;
let kdBookmarks = [];
let kdZoomLevel = 1;
let kdPanX = 0, kdPanY = 0;

function kdZoom(delta) {
	const oldZoom = kdZoomLevel;
	kdZoomLevel = Math.max(0.2, Math.min(5, kdZoomLevel + delta));
	const wrap = document.getElementById('kd-pages-wrap');
	if (wrap) {
		const cx = wrap.clientWidth / 2, cy = wrap.clientHeight / 2;
		kdPanX = cx - (cx - kdPanX) * (kdZoomLevel / oldZoom);
		kdPanY = cy - (cy - kdPanY) * (kdZoomLevel / oldZoom);
	}
	applyKdZoom();
}
function kdZoomReset() {
	kdZoomLevel = 1; kdPanX = 0; kdPanY = 0;
	applyKdZoom();
}
function applyKdZoom() {
	const img = document.querySelector('#kd-pages-container .kd-page-img');
	if (img) img.style.transform = `translate(${kdPanX}px,${kdPanY}px) scale(${kdZoomLevel})`;
	const label = document.getElementById('kd-zoom-label');
	if (label) label.textContent = `${Math.round(kdZoomLevel * 100)}%`;
}

(function initKdZoom() {
	document.addEventListener('DOMContentLoaded', () => {
		const wrap = document.getElementById('kd-pages-wrap');
		if (!wrap) return;

		wrap.addEventListener('wheel', (e) => {
			if (!e.ctrlKey && !e.metaKey) return;
			e.preventDefault();
			const rect = wrap.getBoundingClientRect();
			const mx = e.clientX - rect.left, my = e.clientY - rect.top;
			const oldZoom = kdZoomLevel;
			const delta = e.deltaY > 0 ? -0.08 : 0.08;
			kdZoomLevel = Math.max(0.2, Math.min(5, kdZoomLevel + delta));
			kdPanX = mx - (mx - kdPanX) * (kdZoomLevel / oldZoom);
			kdPanY = my - (my - kdPanY) * (kdZoomLevel / oldZoom);
			applyKdZoom();
		}, { passive: false });

		let drag = null;
		wrap.addEventListener('mousedown', (e) => {
			if (e.button !== 0) return;
			drag = { sx: e.clientX - kdPanX, sy: e.clientY - kdPanY };
			wrap.style.cursor = 'grabbing';
			e.preventDefault();
		});
		window.addEventListener('mousemove', (e) => {
			if (!drag) return;
			kdPanX = e.clientX - drag.sx;
			kdPanY = e.clientY - drag.sy;
			applyKdZoom();
		});
		window.addEventListener('mouseup', () => {
			if (drag) { drag = null; const w = document.getElementById('kd-pages-wrap'); if(w) w.style.cursor = 'grab'; }
		});

		let lastTouchDist = 0;
		wrap.addEventListener('touchstart', (e) => {
			if (e.touches.length === 2) {
				lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
			} else if (e.touches.length === 1) {
				drag = { sx: e.touches[0].clientX - kdPanX, sy: e.touches[0].clientY - kdPanY };
			}
		}, { passive: true });
		wrap.addEventListener('touchmove', (e) => {
			if (e.touches.length === 2) {
				e.preventDefault();
				const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
				const scale = dist / lastTouchDist;
				kdZoomLevel = Math.max(0.2, Math.min(5, kdZoomLevel * scale));
				lastTouchDist = dist;
				applyKdZoom();
			} else if (e.touches.length === 1 && drag) {
				kdPanX = e.touches[0].clientX - drag.sx;
				kdPanY = e.touches[0].clientY - drag.sy;
				applyKdZoom();
			}
		}, { passive: false });
		wrap.addEventListener('touchend', () => { drag = null; lastTouchDist = 0; });
	});
})();

async function openKeyDetail(keyId) {
	let allKeys = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		allKeys = result.data || [];
	} catch (e) {
		showToast('êµì¬ ë¡œë“œ ì‹¤íŒ¨', 'error');
		return;
	}

	currentKeyDetail = allKeys.find(k => k.id === keyId);
	if (!currentKeyDetail) { showToast('êµì¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

	document.getElementById('key-detail-title').textContent = currentKeyDetail.title || 'êµì¬ ìƒì„¸';
	document.getElementById('kd-title').value = currentKeyDetail.title || '';
	document.getElementById('kd-subject').value = currentKeyDetail.subject || '';

	// í˜ì´ì§€ ì´ë¯¸ì§€ + ë¶ë§ˆí¬
	kdPageImages = currentKeyDetail.page_images_json || [];
	kdBookmarks = currentKeyDetail.bookmarks_json || [];
	kdCurrentPage = 0;
	renderKdPageImages();
	renderKdBookmarks();

	// ë¬¸ì œ ëª©ë¡ êµ¬ì„±
	const answers = currentKeyDetail.answers_json || {};
	const types = currentKeyDetail.question_types_json || {};
	kdQuestions = Object.keys(answers).map(qnum => ({
		number: qnum,
		answer: answers[qnum] || '',
		type: types[qnum] || 'mc',
	}));

	// ìˆ«ì ê¸°ì¤€ ì •ë ¬ (1, 2, 3, ..., 4(1), 4(2), ...)
	kdQuestions.sort((a, b) => {
		const na = parseFloat(a.number) || 0;
		const nb = parseFloat(b.number) || 0;
		return na - nb || a.number.localeCompare(b.number);
	});

	renderKeyQuestions();
	kdDirty = false;
	showPage('key-detail');
}

function renderKdPageImages(keepScroll) {
	const container = document.getElementById('kd-pages-container');
	const nav = document.getElementById('kd-page-nav');
	const hint = document.getElementById('kd-pages-hint');
	const section = document.getElementById('kd-pages-section');

	if (!kdPageImages.length) {
		container.style.minHeight = '';
		container.innerHTML = '<div class="empty-state" style="padding:20px;"><i class="fas fa-file-image"></i><p>íŒŒì‹±ëœ í˜ì´ì§€ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		nav.style.display = 'none';
		if (hint) {
			hint.style.display = 'block';
			hint.textContent = 'HML íŒŒì¼ì€ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. PDF íŒŒì¼ë¡œ ë“±ë¡í•˜ë©´ í˜ì´ì§€ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
		}
		return;
	}

	if (hint) hint.style.display = 'none';

	// ì´ë¯¸ì§€ êµì²´ ì¤‘ ë†’ì´ ìœ ì§€ â†’ ìŠ¤í¬ë¡¤ ì í”„ ë°©ì§€
	const prevH = container.offsetHeight;
	if (prevH > 0) container.style.minHeight = prevH + 'px';

	const img = kdPageImages[kdCurrentPage];
	const imgUrl = fixDriveUrl(img.url);
	container.innerHTML = `<img class="kd-page-img" src="${imgUrl}" alt="í˜ì´ì§€ ${img.page || kdCurrentPage + 1}"
		style="transform:translate(${kdPanX}px,${kdPanY}px) scale(${kdZoomLevel})"
		onload="this.parentElement.style.minHeight=''"
		onerror="this.onerror=null;this.parentElement.style.minHeight='';this.parentElement.innerHTML='<div class=\\'empty-state\\' style=\\'padding:20px;\\'><i class=\\'fas fa-exclamation-triangle\\'></i><p>ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ â€” PDFë¥¼ ë‹¤ì‹œ ë“±ë¡í•´ì£¼ì„¸ìš”</p></div>';">`;

	if (kdPageImages.length > 1) {
		nav.style.display = 'flex';
		document.getElementById('kd-page-indicator').textContent = `${kdCurrentPage + 1} / ${kdPageImages.length}`;
		document.getElementById('kd-btn-prev').disabled = kdCurrentPage === 0;
		document.getElementById('kd-btn-next').disabled = kdCurrentPage >= kdPageImages.length - 1;
	} else {
		nav.style.display = 'none';
	}

	if (keepScroll && section) {
		requestAnimationFrame(() => section.scrollIntoView({ block: 'nearest', behavior: 'instant' }));
	}
}

async function refreshKeyPageImages() {
	if (!currentKeyDetail) return;
	const keyId = currentKeyDetail.id;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		const keys = result.data || [];
		const updated = keys.find(k => k.id === keyId);
		if (updated) {
			currentKeyDetail.page_images_json = updated.page_images_json || [];
			kdPageImages = currentKeyDetail.page_images_json;
			kdCurrentPage = 0;
			renderKdPageImages();
			if (kdPageImages.length) showToast(`${kdPageImages.length}í˜ì´ì§€ ì´ë¯¸ì§€ ë¡œë“œë¨`, 'success');
			else showToast('ì•„ì§ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'info');
		}
	} catch (e) {
		showToast('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨', 'error');
	}
}

function kdPrevPage() { if (kdCurrentPage > 0) { kdCurrentPage--; renderKdPageImages(true); renderKdBookmarks(); } }
function kdNextPage() { if (kdCurrentPage < kdPageImages.length - 1) { kdCurrentPage++; renderKdPageImages(true); renderKdBookmarks(); } }

function kdGoToPage(pageIdx) {
	if (pageIdx < 0) pageIdx = 0;
	if (pageIdx >= kdPageImages.length) pageIdx = kdPageImages.length - 1;
	kdCurrentPage = pageIdx;
	renderKdPageImages(true);
	renderKdBookmarks();
}

function kdStartPageJump() {
	const el = document.getElementById('kd-page-indicator');
	const total = kdPageImages.length;
	const cur = kdCurrentPage + 1;
	el.innerHTML = `<input type="text" class="page-jump-input" value="${cur}" id="kd-page-jump">
		<span style="font-size:11px;color:var(--text-sec);margin-left:2px;">/ ${total}</span>`;
	const input = document.getElementById('kd-page-jump');
	input.focus();
	input.select();
	input.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			const val = parseInt(input.value);
			if (val >= 1 && val <= total) kdGoToPage(val - 1);
			else showToast(`1~${total} ì‚¬ì´ í˜ì´ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”`, 'error');
		}
		if (e.key === 'Escape') renderKdPageImages(true);
	});
	input.addEventListener('blur', () => {
		const val = parseInt(input.value);
		if (val >= 1 && val <= total && val !== cur) kdGoToPage(val - 1);
		else renderKdPageImages(true);
	});
}

// â”€â”€ ë¶ë§ˆí¬ â”€â”€
function renderKdBookmarks() {
	const container = document.getElementById('kd-bookmarks');
	if (!kdPageImages.length) { container.innerHTML = ''; return; }

	let html = kdBookmarks.map((bm, i) => {
		const isActive = kdCurrentPage === bm.page - 1;
		return `<button class="kd-bookmark-btn${isActive ? ' active' : ''}" onclick="kdGoToPage(${bm.page - 1})" title="${bm.label} (${bm.page}p)">
			<i class="fas fa-bookmark"></i> ${escapeHtml(bm.label)} <span style="opacity:0.7;">${bm.page}p</span>
		</button>`;
	}).join('');

	html += `<button class="kd-bookmark-btn kd-bookmark-add" onclick="kdAddBookmark()" title="í˜„ì¬ í˜ì´ì§€ë¥¼ ë¶ë§ˆí¬ì— ì¶”ê°€">
		<i class="fas fa-plus"></i> ë¶ë§ˆí¬ ì¶”ê°€
	</button>`;
	container.innerHTML = html;
}

function kdAddBookmark() {
	const pageNum = kdCurrentPage + 1;
	const existing = kdBookmarks.find(b => b.page === pageNum);
	if (existing) {
		if (confirm(`${pageNum}pì— ì´ë¯¸ "${existing.label}" ë¶ë§ˆí¬ê°€ ìˆìŠµë‹ˆë‹¤.\nì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
			kdBookmarks = kdBookmarks.filter(b => b.page !== pageNum);
			markKdDirty();
			renderKdBookmarks();
			saveKdBookmarks();
		}
		return;
	}
	const label = prompt(`${pageNum}í˜ì´ì§€ ë¶ë§ˆí¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, `ì •ë‹µ ${pageNum}p`);
	if (!label || !label.trim()) return;
	kdBookmarks.push({ page: pageNum, label: label.trim() });
	kdBookmarks.sort((a, b) => a.page - b.page);
	markKdDirty();
	renderKdBookmarks();
	saveKdBookmarks();
}

async function saveKdBookmarks() {
	if (!currentKeyDetail || !currentTeacher) return;
	const payload = { bookmarks_json: kdBookmarks };
	try {
		const url = `${GRADING_SERVER_URL}/api/answer-keys/${currentKeyDetail.id}`;
		console.log('[ë¶ë§ˆí¬ ì €ì¥]', url, payload);
		const res = await fetch(url, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(payload),
		});
		const result = await res.json();
		console.log('[ë¶ë§ˆí¬ ì‘ë‹µ]', res.status, result);
		if (!res.ok) throw new Error(result.detail || result.message || 'ì €ì¥ ì‹¤íŒ¨');
		if (currentKeyDetail) currentKeyDetail.bookmarks_json = [...kdBookmarks];
		showToast('ë¶ë§ˆí¬ ì €ì¥ë¨', 'success');
	} catch (e) {
		console.error('[ë¶ë§ˆí¬ ì €ì¥ ì‹¤íŒ¨]', e);
		showToast('ë¶ë§ˆí¬ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

function formatAnswerHtml(answer, isEssay) {
	if (!answer) {
		if (isEssay) return '<span style="opacity:0.4">ì„œìˆ í˜• (í’€ì´ í‰ê°€)</span>';
		return '<span style="opacity:0.4">ì •ë‹µ ì…ë ¥ (í´ë¦­)</span>';
	}
	if (_circledNums.includes(answer)) {
		return `<span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:var(--primary);color:#fff;font-weight:800;font-size:15px;">${_fromCircled(answer)}</span>`;
	}
	if (mathLiveReady && (answer.includes('\\') || answer.includes('^{') || answer.includes('_{'))) {
		return `<math-field read-only class="kd-math-ro">${escapeHtml(answer)}</math-field>`;
	}
	return escapeHtml(answer);
}

const TYPE_CYCLE = ['mc', 'short', 'essay'];
const TYPE_LABELS = { mc: 'ê°ê´€', short: 'ë‹¨ë‹µ', essay: 'ì„œìˆ ' };

function renderKeyQuestions() {
	const list = document.getElementById('kd-questions-list');
	document.getElementById('kd-question-count').textContent = `${kdQuestions.length}ë¬¸ì œ`;

	if (!kdQuestions.length) {
		list.innerHTML = '<div style="text-align:center;color:var(--text-sec);font-size:13px;padding:16px;">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>';
		return;
	}

	list.innerHTML = kdQuestions.map((q, idx) => {
		const t = q.type || 'mc';
		const rowCls = t !== 'mc' ? ` kd-type-${t}` : '';
		return `<div class="kd-row${rowCls}" id="kd-row-${idx}">
			<input type="text" class="kd-num-input" value="${escapeHtml(q.number)}" onchange="updateQuestion(${idx},'number',this.value)" placeholder="#">
			<div style="display:flex;align-items:center;justify-content:center;">
				<span class="kd-type-badge type-${t}" onclick="cycleType(${idx})" title="í´ë¦­í•˜ì—¬ ìœ í˜• ë³€ê²½">${TYPE_LABELS[t]}</span>
			</div>
			<div class="kd-answer-input kd-answer-display" onclick="openMathEditor(${idx})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì‹ í¸ì§‘ê¸° ì—´ê¸°">
				${formatAnswerHtml(q.answer, t === 'essay')}
			</div>
			<button class="kd-del-btn" onclick="removeQuestion(${idx})" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
		</div>`;
	}).join('');
}

function updateQuestion(idx, field, value) {
	if (idx < 0 || idx >= kdQuestions.length) return;
	kdQuestions[idx][field] = value;
	markKdDirty();
}

// â”€â”€ ìˆ˜ì‹ í¸ì§‘ê¸° (MathLive) â”€â”€
let mathEditorIdx = -1;
let mathLiveReady = false;

customElements.whenDefined('math-field').then(() => {
	mathLiveReady = true;
	if (kdQuestions.length) renderKeyQuestions();
});

function openMathEditor(idx) {
	mathEditorIdx = idx;
	const q = kdQuestions[idx];
	const overlay = document.getElementById('math-editor-overlay');
	const mf = document.getElementById('math-editor-field');
	const rawCheck = document.getElementById('math-editor-raw');
	const rawInput = document.getElementById('math-editor-raw-input');

	document.getElementById('math-editor-qnum').textContent = `${q.number}ë²ˆ`;
	rawCheck.checked = false;
	rawInput.style.display = 'none';
	mf.style.display = '';

	let editVal = q.answer || '';
	if ((q.type || 'mc') === 'mc') editVal = _fromCircled(editVal);
	mf.value = editVal;

	overlay.style.display = 'flex';
	requestAnimationFrame(() => {
		overlay.classList.add('show');
		if (window.mathVirtualKeyboard) {
			window.mathVirtualKeyboard.container = document.body;
		}
		mf.focus();
	});
}

const _circledNums = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©'];
function _toCircled(val) {
	const s = (val || '').trim();
	const n = parseInt(s);
	if (s === String(n) && n >= 1 && n <= 10) return _circledNums[n - 1];
	return s;
}
function _fromCircled(val) {
	const idx = _circledNums.indexOf((val || '').trim());
	return idx >= 0 ? String(idx + 1) : (val || '').trim();
}

function closeMathEditor(save) {
	const overlay = document.getElementById('math-editor-overlay');
	overlay.classList.remove('show');
	setTimeout(() => { overlay.style.display = 'none'; }, 150);

	if (save && mathEditorIdx >= 0 && mathEditorIdx < kdQuestions.length) {
		const rawCheck = document.getElementById('math-editor-raw');
		let val;
		if (rawCheck.checked) {
			val = document.getElementById('math-editor-raw-input').value.trim();
		} else {
			val = document.getElementById('math-editor-field').value;
		}
		const qType = kdQuestions[mathEditorIdx].type || 'mc';
		if (qType === 'mc') val = _toCircled(val);
		kdQuestions[mathEditorIdx].answer = val;
		markKdDirty();
		const row = document.getElementById(`kd-row-${mathEditorIdx}`);
		if (row) {
			const display = row.querySelector('.kd-answer-display');
			if (display) display.innerHTML = formatAnswerHtml(val, qType === 'essay');
		}
	}
	mathEditorIdx = -1;
}

function mathCmd(cmd) {
	const mf = document.getElementById('math-editor-field');
	if (!mf) return;
	mf.executeCommand(cmd);
	mf.focus();
}

function toggleMathRaw() {
	const rawCheck = document.getElementById('math-editor-raw');
	const mf = document.getElementById('math-editor-field');
	const rawInput = document.getElementById('math-editor-raw-input');
	if (rawCheck.checked) {
		rawInput.value = mf.value;
		mf.style.display = 'none';
		rawInput.style.display = 'block';
		rawInput.focus();
	} else {
		mf.value = rawInput.value;
		rawInput.style.display = 'none';
		mf.style.display = '';
		mf.focus();
	}
}

function cycleType(idx) {
	if (idx < 0 || idx >= kdQuestions.length) return;
	const cur = kdQuestions[idx].type || 'mc';
	const next = TYPE_CYCLE[(TYPE_CYCLE.indexOf(cur) + 1) % TYPE_CYCLE.length];
	kdQuestions[idx].type = next;
	markKdDirty();
	const row = document.getElementById(`kd-row-${idx}`);
	if (row) {
		row.className = 'kd-row' + (next !== 'mc' ? ` kd-type-${next}` : '');
		const badge = row.querySelector('.kd-type-badge');
		if (badge) {
			badge.className = `kd-type-badge type-${next}`;
			badge.textContent = TYPE_LABELS[next];
		}
		const display = row.querySelector('.kd-answer-display');
		if (display) display.innerHTML = formatAnswerHtml(kdQuestions[idx].answer, next === 'essay');
	}
}

function addQuestion() {
	const lastNum = kdQuestions.length > 0 ? kdQuestions[kdQuestions.length - 1].number : '0';
	let nextNum = String((parseInt(lastNum) || 0) + 1);
	kdQuestions.push({ number: nextNum, answer: '', type: 'mc' });
	markKdDirty();
	renderKeyQuestions();
	// ìƒˆ í–‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤ + í¬ì»¤ìŠ¤
	setTimeout(() => {
		const rows = document.querySelectorAll('.kd-row');
		const last = rows[rows.length - 1];
		if (last) {
			last.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
			const numInput = last.querySelector('.kd-num-input');
			if (numInput) numInput.focus();
		}
	}, 50);
}

function removeQuestion(idx) {
	if (idx < 0 || idx >= kdQuestions.length) return;
	const q = kdQuestions[idx];
	if (!confirm(`${q.number}ë²ˆ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
	kdQuestions.splice(idx, 1);
	markKdDirty();
	renderKeyQuestions();
}

async function saveKeyDetail() {
	if (!currentKeyDetail) return;

	// answers_json + question_types_json ì¬êµ¬ì„±
	const answersJson = {};
	const typesJson = {};
	for (const q of kdQuestions) {
		const num = q.number.trim();
		if (!num) continue;
		answersJson[num] = q.answer;
		typesJson[num] = q.type || 'mc';
	}

	const title = document.getElementById('kd-title').value.trim();
	const subject = document.getElementById('kd-subject').value.trim();

	if (!title) { showToast('êµì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys/${currentKeyDetail.id}`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
				teacher_id: currentTeacher.owner_user_id,
				title,
				subject,
				answers_json: answersJson,
				question_types_json: typesJson,
				total_questions: Object.keys(answersJson).length,
				bookmarks_json: kdBookmarks,
			}),
		});
		if (!res.ok) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); return; }
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
		return;
	}

	kdDirty = false;
	showToast('êµì¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
	document.getElementById('key-detail-title').textContent = title;
	loadAnswerKeys();
}

// ============================================================
// í†µê³„
// ============================================================
async function loadStats() {
	if (!currentTeacher) return;
	const el = document.getElementById('stats-content');
	let results = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/stats?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		results = result.data || [];
	} catch (e) {
		console.warn('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', e);
	}

	if (!results?.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>í™•ì •ëœ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}

	const avgScore = results.reduce((sum, r) => sum + (r.total_score || 0), 0) / results.length;
	const totalGraded = results.length;

	// í•™ìƒë³„ í‰ê· 
	const studentMap = {};
	results.forEach(r => {
		const name = r.students?.name || '?';
		if (!studentMap[name]) studentMap[name] = [];
		studentMap[name].push(r.total_score || 0);
	});

	const studentStats = Object.entries(studentMap).map(([name, scores]) => ({
		name, avg: Math.round(scores.reduce((a, b) => a + b, 0) / scores.length * 10) / 10, count: scores.length
	})).sort((a, b) => b.avg - a.avg);

	el.innerHTML = `
		<div class="card">
			<div class="card-title"><i class="fas fa-chart-pie"></i> ì „ì²´ í†µê³„</div>
			<div class="stat-row">
				<div class="stat-item"><div class="stat-num" style="color:var(--primary);">${avgScore.toFixed(1)}</div><div class="stat-label">í‰ê·  ì ìˆ˜</div></div>
				<div class="stat-item"><div class="stat-num" style="color:var(--green);">${totalGraded}</div><div class="stat-label">ì±„ì  ì™„ë£Œ</div></div>
			</div>
		</div>
		<div class="card">
			<div class="card-title"><i class="fas fa-ranking-star"></i> í•™ìƒë³„ í‰ê· </div>
			${studentStats.map((s, i) => `<div class="list-item">
				<div class="list-item-icon" style="background:rgba(129,140,248,0.15);font-size:14px;font-weight:700;">${i + 1}</div>
				<div class="list-item-info">
					<div class="list-item-title">${escapeHtml(s.name)}</div>
					<div class="list-item-sub">${s.count}íšŒ ì±„ì </div>
				</div>
				<span style="font-size:16px;font-weight:700;color:var(--primary);">${s.avg}ì </span>
			</div>`).join('')}
		</div>
	`;
}

// ============================================================
// Split View: ë¬¸í•­ ì„ íƒ + ì •ë‹µ íŒ¨ë„ + í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ + ì¤Œ
// ============================================================

function selectItem(idx) {
	if (idx < 0 || idx >= currentItems.length) return;
	selectedItemIdx = idx;
	// ê·¸ë¦¬ë“œ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
	document.querySelectorAll('#detail-grid .q-cell').forEach((el, i) => {
		el.classList.toggle('q-selected', i === idx);
	});
	renderAnswerPanel();
	scrollImageToQuestion(idx);
}

function renderAnswerPanel() {
	const panel = document.getElementById('answer-panel-list');
	if (!currentItems.length) {
		panel.innerHTML = '<div style="text-align:center;color:var(--text-sec);font-size:13px;padding:20px;">ë¬¸í•­ ë°ì´í„° ì—†ìŒ</div>';
		return;
	}
	panel.innerHTML = currentItems.map((item, idx) => {
		const sel = idx === selectedItemIdx ? ' ap-selected' : '';
		const isUnanswered = item.student_answer === '(ë¯¸í’€ì´)' || item.ai_feedback === 'í•™ìƒì´ í’€ì§€ ì•Šì€ ë¬¸ì œ';
		let statusIcon = 'â“';
		if (isUnanswered) statusIcon = 'ğŸ“';
		else if (item.is_correct === true) statusIcon = 'â­•';
		else if (item.is_correct === false) statusIcon = 'âœ˜';

		const typeLabel = item.question_type === 'essay' ? 'ì„œìˆ ' : item.question_type === 'short_answer' ? 'ë‹¨ë‹µ' : 'ê°ê´€';
		const conf = item.confidence || 0;
		const confColor = conf >= 85 ? 'var(--green)' : conf >= 60 ? 'var(--yellow)' : 'var(--red)';

		let quickBtns = '';
		if (idx === selectedItemIdx) {
			const isC = item.is_correct === true;
			const isW = item.is_correct === false;
			const isU = item.is_correct === null;
			quickBtns = `<div class="quick-grade">
				<button class="qg-correct${isC ? ' active' : ''}" onclick="event.stopPropagation();quickGrade(${idx},'correct')">â­• ì •ë‹µ<kbd style="font-size:9px;margin-left:2px;opacity:0.6">1</kbd></button>
				<button class="qg-wrong${isW ? ' active' : ''}" onclick="event.stopPropagation();quickGrade(${idx},'wrong')">âœ˜ ì˜¤ë‹µ<kbd style="font-size:9px;margin-left:2px;opacity:0.6">2</kbd></button>
				<button class="qg-uncertain${isU ? ' active' : ''}" onclick="event.stopPropagation();quickGrade(${idx},'uncertain')">â“ í™•ì¸<kbd style="font-size:9px;margin-left:2px;opacity:0.6">3</kbd></button>
			</div>`;
		}

		return `<div class="ap-item${sel}" onclick="selectItem(${idx})" id="ap-item-${idx}">
			<div style="display:flex;align-items:center;gap:6px;">
				<span class="ap-num">${statusIcon} ${item.question_label || item.question_number}ë²ˆ</span>
				<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg);color:var(--text-sec);">${typeLabel}</span>
				<span style="font-size:10px;color:${confColor};margin-left:auto;">${conf}%</span>
			</div>
			<div class="ap-row"><span class="ap-label">í•™ìƒ ë‹µ</span><span class="ap-val" style="color:var(--text);">${escapeHtml(item.student_answer || '(ì—†ìŒ)')}</span></div>
			<div class="ap-row"><span class="ap-label">ì •ë‹µ</span><span class="ap-val" style="color:var(--green);">${escapeHtml(item.correct_answer || '-')}</span></div>
			${item.ai_feedback ? `<div style="font-size:11px;color:var(--text-sec);margin-top:4px;"><i class="fas fa-robot" style="margin-right:3px;"></i>${escapeHtml(item.ai_feedback)}</div>` : ''}
			${quickBtns}
		</div>`;
	}).join('');

	// ì„ íƒëœ í•­ëª©ìœ¼ë¡œ íŒ¨ë„ ìŠ¤í¬ë¡¤
	if (selectedItemIdx >= 0) {
		const selEl = document.getElementById(`ap-item-${selectedItemIdx}`);
		if (selEl) selEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
	}
}

async function quickGrade(idx, grade) {
	const item = currentItems[idx];
	if (!item) return;

	let updates = {};
	if (grade === 'correct') {
		updates.teacher_score = 1;
		updates.teacher_feedback = 'ì„ ìƒë‹˜ í™•ì¸: ì •ë‹µ';
	} else if (grade === 'wrong') {
		updates.teacher_score = 0;
		updates.teacher_feedback = 'ì„ ìƒë‹˜ í™•ì¸: ì˜¤ë‹µ';
	} else {
		updates.teacher_score = -1;  // -1 = í™•ì¸í•„ìš” ìƒíƒœ ìœ ì§€
		updates.teacher_feedback = 'ì„ ìƒë‹˜ í™•ì¸ í•„ìš”';
	}

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/items/${item.id}`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(updates),
		});
		if (!res.ok) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); return; }
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error'); return;
	}

	// ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜ (ì„œë²„ ì¬ìš”ì²­ ì—†ì´ ë¹ ë¥¸ UX)
	if (grade === 'correct') item.is_correct = true;
	else if (grade === 'wrong') item.is_correct = false;
	else item.is_correct = null;

	renderQuestionGrid();
	showToast(`${item.question_number}ë²ˆ: ${grade === 'correct' ? 'ì •ë‹µ' : grade === 'wrong' ? 'ì˜¤ë‹µ' : 'í™•ì¸í•„ìš”'}`, 'success');
}

function handleDetailKeydown(e) {
	// ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
	const tag = e.target.tagName;
	if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
	// ëª¨ë‹¬ì´ ì—´ë ¤ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
	if (document.querySelector('.modal-overlay.show')) return;

	switch (e.key) {
		case 'w': case 'W': case 'ArrowUp':
			e.preventDefault();
			selectItem(Math.max(0, selectedItemIdx - 1));
			break;
		case 's': case 'S': case 'ArrowDown':
			e.preventDefault();
			if (selectedItemIdx < 0) selectItem(0);
			else selectItem(Math.min(currentItems.length - 1, selectedItemIdx + 1));
			break;
		case 'ArrowLeft':
			if (currentImageUrls.length > 1) { e.preventDefault(); prevImage(); }
			break;
		case 'ArrowRight':
			if (currentImageUrls.length > 1) { e.preventDefault(); nextImage(); }
			break;
		case '1':
			e.preventDefault();
			if (selectedItemIdx >= 0) quickGrade(selectedItemIdx, 'correct');
			break;
		case '2':
			e.preventDefault();
			if (selectedItemIdx >= 0) quickGrade(selectedItemIdx, 'wrong');
			break;
		case '3':
			e.preventDefault();
			if (selectedItemIdx >= 0) quickGrade(selectedItemIdx, 'uncertain');
			break;
		case 'Enter':
			e.preventDefault();
			if (selectedItemIdx >= 0) openItemEdit(currentItems[selectedItemIdx].id);
			break;
		case 'Escape':
			if (document.querySelector('.modal-overlay.show')) {
				closeModal('item-modal');
			}
			break;
		case '+': case '=':
			e.preventDefault();
			zoomImage(0.25);
			break;
		case '-': case '_':
			e.preventDefault();
			zoomImage(-0.25);
			break;
		case '0':
			e.preventDefault();
			zoomImage(0, true);
			break;
	}
}

// ì´ë¯¸ì§€ ë¡œë“œ/ë„¤ë¹„ê²Œì´ì…˜
function loadCurrentImage() {
	const img = document.getElementById('graded-image');
	const emptyState = document.getElementById('image-empty-state');
	const nav = document.getElementById('image-nav');

	if (!currentImageUrls.length) {
		img.style.display = 'none';
		emptyState.style.display = 'flex';
		nav.style.display = 'none';
		return;
	}

	emptyState.style.display = 'none';
	img.style.display = 'block';
	let imgUrl = currentImageUrls[currentImageIdx];
	const ucMatch = imgUrl && imgUrl.match(/drive\.google\.com\/uc\?id=([^&]+)/);
	if (ucMatch) imgUrl = 'https://lh3.googleusercontent.com/d/' + ucMatch[1];
	img.src = imgUrl;

	if (currentImageUrls.length > 1) {
		nav.style.display = 'flex';
		document.getElementById('image-page-indicator').textContent = `${currentImageIdx + 1} / ${currentImageUrls.length}`;
		document.getElementById('btn-prev-img').disabled = currentImageIdx === 0;
		document.getElementById('btn-next-img').disabled = currentImageIdx >= currentImageUrls.length - 1;
	} else {
		nav.style.display = 'none';
	}
}

function prevImage() {
	if (currentImageIdx > 0) {
		currentImageIdx--;
		loadCurrentImage();
	}
}

function nextImage() {
	if (currentImageIdx < currentImageUrls.length - 1) {
		currentImageIdx++;
		loadCurrentImage();
	}
}

// ì´ë¯¸ì§€ ì¤Œ
function zoomImage(delta, reset = false) {
	if (reset) {
		imageZoom = 1;
	} else {
		imageZoom = Math.max(0.5, Math.min(4, imageZoom + delta));
	}
	const img = document.getElementById('graded-image');
	const canvas = document.getElementById('annotation-canvas');
	if (img) {
		img.style.width = (imageZoom * 100) + '%';
	}
	if (canvas) {
		canvas.style.width = (imageZoom * 100) + '%';
		canvas.style.height = 'auto';
	}
	const label = document.getElementById('zoom-level');
	if (label) label.textContent = Math.round(imageZoom * 100) + '%';
}

// ì´ë¯¸ì§€ ë·°ì–´ì— ë§ˆìš°ìŠ¤ íœ  ì¤Œ ì—°ê²°
document.addEventListener('DOMContentLoaded', () => {
	document.addEventListener('wheel', (e) => {
		const viewer = document.getElementById('image-viewer');
		if (!viewer || !viewer.contains(e.target)) return;
		if (document.getElementById('page-detail').style.display === 'none') return;
		e.preventDefault();
		const delta = e.deltaY < 0 ? 0.15 : -0.15;
		zoomImage(delta);
	}, { passive: false });
});

// ë¬¸í•­ ì„ íƒ ì‹œ ì´ë¯¸ì§€ ìë™ ìŠ¤í¬ë¡¤ (Smart Scroll)
function scrollImageToQuestion(idx) {
	const viewer = document.getElementById('image-viewer');
	const img = document.getElementById('graded-image');
	if (!viewer || !img || !currentItems.length) return;

	// ë¬¸í•­ ìˆœì„œ ë¹„ìœ¨ë¡œ ì´ë¯¸ì§€ ë‚´ ëŒ€ëµì  ìœ„ì¹˜ ì¶”ì •
	const ratio = idx / currentItems.length;
	const scrollTarget = img.naturalHeight * imageZoom * ratio * (img.clientWidth / img.naturalWidth);
	viewer.scrollTo({ top: Math.max(0, scrollTarget - viewer.clientHeight / 3), behavior: 'smooth' });
}

// ============================================================
// ìº”ë²„ìŠ¤ (í•„ê¸° ë„êµ¬)
// ============================================================
function initCanvas() {
	const img = document.getElementById('graded-image');
	const canvas = document.getElementById('annotation-canvas');
	canvas.width = img.naturalWidth;
	canvas.height = img.naturalHeight;

	const ctx = canvas.getContext('2d');
	canvasHistory = [];
	canvasRedoStack = [];

	canvas.addEventListener('pointerdown', startDraw);
	canvas.addEventListener('pointermove', draw);
	canvas.addEventListener('pointerup', endDraw);
	canvas.addEventListener('pointerleave', endDraw);
}

function startDraw(e) {
	isDrawing = true;
	const { x, y } = getCanvasPos(e);

	if (canvasTool === 'text') {
		const text = prompt('í…ìŠ¤íŠ¸ ì…ë ¥:');
		if (text) {
			const ctx = e.target.getContext('2d');
			ctx.font = `${canvasPenSize * 6}px Pretendard, sans-serif`;
			ctx.fillStyle = canvasColor;
			ctx.fillText(text, x, y);
			saveCanvasState();
		}
		isDrawing = false;
		return;
	}

	if (canvasTool === 'circle') {
		const ctx = e.target.getContext('2d');
		ctx.beginPath();
		ctx.arc(x, y, canvasPenSize * 8, 0, Math.PI * 2);
		ctx.strokeStyle = canvasColor;
		ctx.lineWidth = canvasPenSize;
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	if (canvasTool === 'check') {
		const ctx = e.target.getContext('2d');
		const s = canvasPenSize * 6;
		ctx.strokeStyle = '#22c55e';
		ctx.lineWidth = canvasPenSize + 1;
		ctx.beginPath();
		ctx.moveTo(x - s, y); ctx.lineTo(x - s/3, y + s); ctx.lineTo(x + s, y - s);
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	if (canvasTool === 'xmark') {
		const ctx = e.target.getContext('2d');
		const s = canvasPenSize * 6;
		ctx.strokeStyle = '#ef4444';
		ctx.lineWidth = canvasPenSize + 1;
		ctx.beginPath();
		ctx.moveTo(x - s, y - s); ctx.lineTo(x + s, y + s);
		ctx.moveTo(x + s, y - s); ctx.lineTo(x - s, y + s);
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	const ctx = e.target.getContext('2d');
	ctx.beginPath();
	ctx.moveTo(x, y);
}

function draw(e) {
	if (!isDrawing) return;
	const { x, y } = getCanvasPos(e);
	const ctx = e.target.getContext('2d');

	if (canvasTool === 'eraser') {
		ctx.globalCompositeOperation = 'destination-out';
		ctx.lineWidth = canvasPenSize * 5;
	} else if (canvasTool === 'highlighter') {
		ctx.globalCompositeOperation = 'source-over';
		ctx.strokeStyle = canvasColor + '40';
		ctx.lineWidth = canvasPenSize * 5;
	} else {
		ctx.globalCompositeOperation = 'source-over';
		ctx.strokeStyle = canvasColor;
		ctx.lineWidth = canvasPenSize;
	}

	ctx.lineCap = 'round';
	ctx.lineJoin = 'round';
	ctx.lineTo(x, y);
	ctx.stroke();
}

function endDraw(e) {
	if (isDrawing) {
		isDrawing = false;
		saveCanvasState();
	}
}

function getCanvasPos(e) {
	const canvas = e.target;
	const rect = canvas.getBoundingClientRect();
	return {
		x: (e.clientX - rect.left) * (canvas.width / rect.width),
		y: (e.clientY - rect.top) * (canvas.height / rect.height),
	};
}

function saveCanvasState() {
	const canvas = document.getElementById('annotation-canvas');
	canvasHistory.push(canvas.toDataURL());
	canvasRedoStack = [];
}

function undoCanvas() {
	if (!canvasHistory.length) return;
	const canvas = document.getElementById('annotation-canvas');
	const ctx = canvas.getContext('2d');
	canvasRedoStack.push(canvasHistory.pop());
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	if (canvasHistory.length > 0) {
		const img = new Image();
		img.onload = () => ctx.drawImage(img, 0, 0);
		img.src = canvasHistory[canvasHistory.length - 1];
	}
}

function redoCanvas() {
	if (!canvasRedoStack.length) return;
	const canvas = document.getElementById('annotation-canvas');
	const ctx = canvas.getContext('2d');
	const state = canvasRedoStack.pop();
	canvasHistory.push(state);
	const img = new Image();
	img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
	img.src = state;
}

function setTool(tool) {
	canvasTool = tool;
	document.querySelectorAll('.tool-btn[data-tool]').forEach(el => el.classList.toggle('active', el.dataset.tool === tool));
}

function setColor(color) {
	canvasColor = color;
	document.querySelectorAll('.color-dot').forEach(el => el.classList.toggle('active', el.style.background === color));
}

function setPenSize(size) { canvasPenSize = parseInt(size); }

async function saveAnnotations() {
	if (!currentResultId) return;
	const canvas = document.getElementById('annotation-canvas');
	const annotationData = canvas.toDataURL();
	const memo = document.getElementById('detail-memo').value;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/annotations`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
				teacher_annotations: [{ type: 'canvas', data: annotationData }],
				teacher_memo: memo,
				updated_at: new Date().toISOString(),
			}),
		});
		if (!res.ok) return showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast('í•„ê¸° ë° ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ============================================================
// ìœ í‹¸ë¦¬í‹°
// ============================================================
function escapeHtml(str) {
	if (typeof str !== 'string') return str;
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function fixDriveUrl(url) {
	if (!url) return '';
	if (url.startsWith('data:')) return url;
	const m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
	if (m) return `https://lh3.googleusercontent.com/d/${m[1]}=w1000`;
	const m2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
	if (m2) return `https://lh3.googleusercontent.com/d/${m2[1]}=w1000`;
	return url;
}

// ============================================================
// ì´ˆê¸°í™”
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
	const saved = sessionStorage.getItem('grading_teacher');
	const hasSession = !!saved;

	if (!hasSession) {
		document.getElementById('page-login').style.display = 'flex';
	}

	await loadTeacherList();

	if (hasSession) {
		try {
			const teacher = JSON.parse(saved);
			const match = teacherList.find(t => t.id === teacher.id);
			if (match) {
				currentTeacher = match;
				showPage('main');
				await loadAllData();
				await restoreNavState();
			} else {
				sessionStorage.removeItem('grading_teacher');
				document.getElementById('page-login').style.display = 'flex';
			}
		} catch(e) {
			sessionStorage.removeItem('grading_teacher');
			document.getElementById('page-login').style.display = 'flex';
		}
	}

	document.addEventListener('click', (e) => {
		const dropdown = document.getElementById('assign-student-dropdown');
		const search = document.getElementById('assign-student-search');
		if (dropdown && search && !search.contains(e.target) && !dropdown.contains(e.target)) {
			dropdown.style.display = 'none';
		}
	});
});
</script>
</body>
</html>
