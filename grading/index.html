<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>ì±„ì  ê´€ë¦¬</title>
	<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		:root {
			--bg: #0f172a; --bg-card: #1e293b; --bg-elevated: #334155;
			--text: #f1f5f9; --text-sec: #94a3b8; --gray: #64748b;
			--primary: #818cf8; --green: #22c55e; --red: #ef4444;
			--yellow: #eab308; --teal: #14b8a6; --border: #334155;
			--radius: 14px;
		}
		* { margin:0; padding:0; box-sizing:border-box; }
		body { font-family:'Pretendard',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
		
		/* í—¤ë” */
		.top-bar { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:var(--bg-card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
		.top-bar h1 { font-size:17px; font-weight:700; }
		.top-bar-btn { background:none; border:none; color:var(--text-sec); font-size:18px; cursor:pointer; padding:6px; }

		/* íƒ­ */
		.tabs { display:flex; padding:8px 12px; gap:6px; background:var(--bg-card); border-bottom:1px solid var(--border); overflow-x:auto; }
		.tab-btn { padding:8px 16px; border:none; border-radius:20px; background:transparent; color:var(--text-sec); font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
		.tab-btn.active { background:var(--primary); color:#fff; }

		/* ì¹´ë“œ */
		.card { background:var(--bg-card); border-radius:var(--radius); padding:16px; margin:8px 12px; border:1px solid var(--border); }
		.card-title { font-size:14px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
		.card-title i { color:var(--primary); }

		/* ë²„íŠ¼ */
		.btn { padding:10px 20px; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; }
		.btn-primary { background:var(--primary); color:#fff; }
		.btn-primary:hover { opacity:0.9; }
		.btn-danger { background:var(--red); color:#fff; }
		.btn-sm { padding:6px 12px; font-size:12px; }
		.btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-sec); }

		/* ì…ë ¥ */
		.input { width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:var(--bg-elevated); color:var(--text); font-size:14px; outline:none; }
		.input:focus { border-color:var(--primary); }
		.form-label { font-size:12px; font-weight:600; color:var(--text-sec); margin-bottom:6px; display:block; }
		.form-group { margin-bottom:14px; }

		/* ë¦¬ìŠ¤íŠ¸ */
		.list-item { display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-elevated); border-radius:var(--radius); margin-bottom:8px; cursor:pointer; transition:all 0.2s; border:1px solid transparent; }
		.list-item:hover { border-color:var(--primary); }
		.list-item-icon { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
		.list-item-info { flex:1; min-width:0; }
		.list-item-title { font-size:14px; font-weight:600; }
		.list-item-sub { font-size:12px; color:var(--text-sec); margin-top:2px; }
		.list-item-badge { padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700; }

		/* ìƒíƒœ ë±ƒì§€ */
		.badge-confirmed { background:rgba(34,197,94,0.15); color:var(--green); }
		.badge-review { background:rgba(234,179,8,0.15); color:var(--yellow); }
		.badge-grading { background:rgba(129,140,248,0.15); color:var(--primary); }

		/* ì ìˆ˜ ì¹´ë“œ */
		.score-card { text-align:center; padding:20px; background:var(--bg-elevated); border-radius:var(--radius); }
		.score-big { font-size:36px; font-weight:800; color:var(--primary); }
		.score-sub { font-size:13px; color:var(--text-sec); margin-top:4px; }

		/* ë¬¸í•­ ê·¸ë¦¬ë“œ */
		.question-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(50px,1fr)); gap:6px; }
		.q-cell { width:100%; aspect-ratio:1; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; cursor:pointer; transition:all 0.2s; }
		.q-correct { background:rgba(34,197,94,0.2); color:var(--green); border:2px solid var(--green); }
		.q-wrong { background:rgba(239,68,68,0.2); color:var(--red); border:2px solid var(--red); }
		.q-uncertain { background:rgba(234,179,8,0.2); color:var(--yellow); border:2px solid var(--yellow); }
		.q-unanswered { background:rgba(100,116,139,0.15); color:var(--gray); border:2px dashed var(--gray); }

		/* ìº”ë²„ìŠ¤ ë„êµ¬ ë°” */
		.canvas-toolbar { display:flex; flex-wrap:wrap; gap:6px; padding:10px 12px; background:var(--bg-card); border-top:1px solid var(--border); position:sticky; bottom:0; z-index:50; }
		.tool-btn { width:38px; height:38px; border-radius:10px; border:1px solid var(--border); background:var(--bg-elevated); color:var(--text-sec); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:14px; }
		.tool-btn.active { border-color:var(--primary); color:var(--primary); background:rgba(129,140,248,0.15); }
		.color-dot { width:20px; height:20px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
		.color-dot.active { border-color:#fff; box-shadow:0 0 0 2px var(--primary); }
		.size-slider { width:80px; accent-color:var(--primary); }

		/* ëª¨ë‹¬ */
		.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; display:none; align-items:center; justify-content:center; }
		.modal-overlay.show { display:flex; }
		.modal-box { background:var(--bg-card); border-radius:var(--radius); padding:20px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; }
		.modal-title { font-size:16px; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; }

		/* í†µê³„ */
		.stat-row { display:flex; gap:8px; margin-bottom:8px; }
		.stat-item { flex:1; text-align:center; padding:12px; background:var(--bg-elevated); border-radius:var(--radius); }
		.stat-num { font-size:20px; font-weight:800; }
		.stat-label { font-size:11px; color:var(--text-sec); margin-top:4px; }

		/* ë¡œë”© */
		.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; margin:20px auto; }
		@keyframes spin { to { transform:rotate(360deg); } }

		/* ë¹ˆ ìƒíƒœ */
		.empty-state { text-align:center; padding:40px 20px; color:var(--text-sec); }
		.empty-state i { font-size:40px; margin-bottom:12px; opacity:0.4; }
		.empty-state p { font-size:14px; }

		/* ë°˜ì‘í˜• */
		@media (max-width: 480px) {
			.tabs { padding:6px 8px; }
			.tab-btn { padding:6px 12px; font-size:12px; }
			.card { margin:6px 8px; padding:12px; }
		}

		/* í† ìŠ¤íŠ¸ */
		.g-toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:12px 24px; border-radius:12px; font-size:14px; font-weight:600; z-index:9999; animation:fadeSlide 0.3s ease; }
		.g-toast.success { background:var(--green); color:#fff; }
		.g-toast.error { background:var(--red); color:#fff; }
		.g-toast.info { background:var(--primary); color:#fff; }
		@keyframes fadeSlide { from { opacity:0; transform:translateX(-50%) translateY(-10px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }

		/* ì´ë¯¸ì§€ ë·°ì–´ */
		.image-viewer { position:relative; width:100%; overflow:auto; background:#000; border-radius:var(--radius); min-height:300px; }
		.image-viewer img { width:100%; display:block; }
		.image-viewer canvas { position:absolute; top:0; left:0; width:100%; height:100%; cursor:crosshair; }
	</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
<div id="page-login" style="display:flex; min-height:100vh; align-items:center; justify-content:center; padding:20px;">
	<div style="max-width:380px; width:100%; text-align:center;">
		<div style="font-size:48px; margin-bottom:16px;">ğŸ“</div>
		<h1 style="font-size:22px; font-weight:800; margin-bottom:4px;">ì±„ì  ê´€ë¦¬</h1>
		<p style="color:var(--text-sec); font-size:13px; margin-bottom:28px;">ì„ ìƒë‹˜ì„ ì„ íƒí•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
		<div style="text-align:left;">
			<div class="form-group">
				<label class="form-label">ì„ ìƒë‹˜ ì„ íƒ</label>
				<select class="input" id="login-teacher-select" onchange="onLoginTeacherSelected()">
					<option value="">ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
				</select>
			</div>
			<div class="form-group" id="login-password-section" style="display:none;">
				<label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
				<input class="input" id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter') handleLogin()">
			</div>
			<button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;margin-top:4px;" onclick="handleLogin()">
				<i class="fas fa-sign-in-alt" style="margin-right:6px;"></i> ì…ì¥
			</button>
		</div>
		<p id="login-error" style="color:var(--red);font-size:12px;margin-top:12px;display:none;"></p>
	</div>
</div>

<!-- ë©”ì¸ í˜ì´ì§€ -->
<div id="page-main" style="display:none;">
	<div class="top-bar">
		<h1><i class="fas fa-pen-to-square" style="color:var(--primary);margin-right:6px;"></i>ì±„ì  ê´€ë¦¬</h1>
		<div style="display:flex;gap:8px;">
			<button class="top-bar-btn" onclick="showPage('main')" title="í™ˆ"><i class="fas fa-home"></i></button>
			<button class="top-bar-btn" onclick="handleLogout()" title="ë¡œê·¸ì•„ì›ƒ"><i class="fas fa-sign-out-alt"></i></button>
		</div>
	</div>

	<div class="tabs" id="main-tabs">
		<button class="tab-btn active" onclick="switchMainTab('results', event)">ğŸ“Š ì±„ì  ê²°ê³¼</button>
		<button class="tab-btn" onclick="switchMainTab('keys', event)">ğŸ“š êµì¬ ê´€ë¦¬</button>
		<button class="tab-btn" onclick="switchMainTab('stats', event)">ğŸ“ˆ í†µê³„</button>
		<button class="tab-btn" onclick="switchMainTab('assign', event)">ğŸ“‹ ê³¼ì œ ë°°ì •</button>
	</div>

	<!-- ì±„ì  ê²°ê³¼ íƒ­ -->
	<div id="tab-results" class="tab-content">
		<div style="padding:8px 12px;display:flex;gap:6px;">
			<button class="btn btn-sm btn-outline" onclick="filterResults('all')" id="filter-all">ì „ì²´</button>
			<button class="btn btn-sm btn-outline" onclick="filterResults('review_needed')" id="filter-review">âš ï¸ ê²€í†  í•„ìš”</button>
			<button class="btn btn-sm btn-outline" onclick="filterResults('confirmed')" id="filter-confirmed">âœ… í™•ì •</button>
		</div>
		<div id="results-list"></div>
	</div>

	<!-- ê³¼ì œ ë°°ì • íƒ­ -->
	<div id="tab-assign" class="tab-content" style="display:none;">
		<div style="padding:8px 12px;">
			<div style="background:#f0fdf4;border-radius:10px;padding:10px 12px;margin-bottom:8px;">
				<p style="font-size:12px;color:#166534;margin:0;">
					<i class="fas fa-magic" style="margin-right:4px;"></i>
					<b>ìë™ ì±„ì  ëª¨ë“œ</b>: êµì¬ë§Œ ë“±ë¡í•˜ë©´ í•™ìƒì´ ì˜¬ë¦° ìˆ™ì œë¥¼ AIê°€ ìë™ìœ¼ë¡œ êµì¬ë¥¼ ë§¤ì¹­í•˜ê³  ì±„ì í•©ë‹ˆë‹¤.<br>
					<span style="font-size:11px;color:#64748b;">ì•„ë˜ ê³¼ì œ ë°°ì •ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤. íŠ¹ì • í•™ìƒì—ê²Œ ê³¼ì œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ê³  ì‹¶ì„ ë•Œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</span>
				</p>
			</div>
			<button class="btn btn-primary btn-sm" onclick="showAssignModal()"><i class="fas fa-plus"></i> ê³¼ì œ ë°°ì • (ì„ íƒ)</button>
		</div>
		<div id="assignments-list"></div>
	</div>

	<!-- êµì¬ ê´€ë¦¬ íƒ­ -->
	<div id="tab-keys" class="tab-content" style="display:none;">
		<div style="padding:8px 12px;display:flex;gap:6px;">
			<button class="btn btn-primary btn-sm" onclick="showAddKeyModal()"><i class="fas fa-plus"></i> êµì¬ ë“±ë¡</button>
			<button class="btn btn-sm btn-outline" onclick="scanDrivePDFs()"><i class="fas fa-cloud"></i> ë“œë¼ì´ë¸Œ ìŠ¤ìº”</button>
		</div>
		<div id="keys-list"></div>
	</div>

	<!-- í†µê³„ íƒ­ -->
	<div id="tab-stats" class="tab-content" style="display:none;">
		<div id="stats-content"></div>
	</div>
</div>

<!-- ì±„ì  ìƒì„¸ í˜ì´ì§€ -->
<div id="page-detail" style="display:none;">
	<div class="top-bar">
		<button class="top-bar-btn" onclick="showPage('main')"><i class="fas fa-arrow-left"></i></button>
		<h1 id="detail-title">ì±„ì  ìƒì„¸</h1>
		<div style="display:flex;gap:8px;">
			<button class="btn btn-sm btn-primary" id="detail-confirm-btn" onclick="confirmResult()">âœ… í™•ì •</button>
		</div>
	</div>

	<div style="padding:0 0 120px;">
		<!-- ì ìˆ˜ ìš”ì•½ -->
		<div class="card">
			<div style="display:flex;gap:12px;">
				<div class="score-card" style="flex:1;">
					<div class="score-big" id="detail-score">-</div>
					<div class="score-sub">ì´ì </div>
				</div>
				<div style="flex:1;">
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--green);" id="detail-correct">0</div><div class="stat-label">ì •ë‹µ</div></div>
						<div class="stat-item"><div class="stat-num" style="color:var(--red);" id="detail-wrong">0</div><div class="stat-label">ì˜¤ë‹µ</div></div>
					</div>
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--yellow);" id="detail-uncertain">0</div><div class="stat-label">í™•ì¸í•„ìš”</div></div>
						<div class="stat-item"><div class="stat-num" style="color:var(--text-sec);" id="detail-total">0</div><div class="stat-label">ì´ë¬¸í•­</div></div>
					</div>
					<div class="stat-row">
						<div class="stat-item"><div class="stat-num" style="color:var(--gray);" id="detail-unanswered">0</div><div class="stat-label">ë¯¸í’€ì´</div></div>
						<div class="stat-item"></div>
					</div>
				</div>
			</div>
			<div id="detail-page-info" style="display:none;font-size:12px;color:var(--teal);margin-top:8px;padding:8px 12px;background:rgba(20,184,166,0.08);border-radius:8px;">
			</div>
		</div>

		<!-- ë¬¸í•­ ê·¸ë¦¬ë“œ -->
		<div class="card">
			<div class="card-title"><i class="fas fa-th"></i> ë¬¸í•­ë³„ ê²°ê³¼</div>
			<div class="question-grid" id="detail-grid"></div>
		</div>

		<!-- ì±„ì  ì´ë¯¸ì§€ + í•„ê¸° -->
		<div class="card">
			<div class="card-title"><i class="fas fa-image"></i> ì±„ì  ì´ë¯¸ì§€</div>
			<div class="image-viewer" id="image-viewer">
				<img id="graded-image" src="" alt="ì±„ì  ì´ë¯¸ì§€" onload="initCanvas()">
				<canvas id="annotation-canvas"></canvas>
			</div>
		</div>

		<!-- ì„ ìƒë‹˜ ë©”ëª¨ -->
		<div class="card">
			<div class="card-title"><i class="fas fa-comment"></i> ë©”ëª¨</div>
			<textarea class="input" id="detail-memo" rows="3" placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  ë©”ëª¨..."></textarea>
		</div>
	</div>

	<!-- í•„ê¸° ë„êµ¬ ë°” -->
	<div class="canvas-toolbar" id="canvas-toolbar">
		<button class="tool-btn active" data-tool="pen" onclick="setTool('pen')"><i class="fas fa-pen"></i></button>
		<button class="tool-btn" data-tool="highlighter" onclick="setTool('highlighter')"><i class="fas fa-highlighter"></i></button>
		<button class="tool-btn" data-tool="text" onclick="setTool('text')"><i class="fas fa-font"></i></button>
		<button class="tool-btn" data-tool="circle" onclick="setTool('circle')"><i class="fas fa-circle" style="font-size:11px;"></i></button>
		<button class="tool-btn" data-tool="check" onclick="setTool('check')"><i class="fas fa-check"></i></button>
		<button class="tool-btn" data-tool="xmark" onclick="setTool('xmark')"><i class="fas fa-xmark"></i></button>
		<button class="tool-btn" data-tool="eraser" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
		<div style="display:flex;gap:4px;align-items:center;margin-left:4px;">
			<div class="color-dot active" style="background:#ef4444;" onclick="setColor('#ef4444')"></div>
			<div class="color-dot" style="background:#3b82f6;" onclick="setColor('#3b82f6')"></div>
			<div class="color-dot" style="background:#22c55e;" onclick="setColor('#22c55e')"></div>
			<div class="color-dot" style="background:#1e293b;" onclick="setColor('#1e293b')"></div>
		</div>
		<input type="range" class="size-slider" min="1" max="20" value="3" oninput="setPenSize(this.value)">
		<button class="tool-btn" onclick="undoCanvas()"><i class="fas fa-undo"></i></button>
		<button class="tool-btn" onclick="redoCanvas()"><i class="fas fa-redo"></i></button>
		<button class="tool-btn" onclick="saveAnnotations()" style="color:var(--green);"><i class="fas fa-save"></i></button>
	</div>
</div>

<!-- ë¬¸í•­ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="item-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-edit" style="color:var(--primary);"></i> <span id="item-modal-title">ë¬¸í•­ ìˆ˜ì •</span></div>
		<div class="form-group">
			<label class="form-label">í•™ìƒ ë‹µ</label>
			<div class="input" id="item-student-answer" style="background:var(--bg);"></div>
		</div>
		<div class="form-group">
			<label class="form-label">ì •ë‹µ</label>
			<div class="input" id="item-correct-answer" style="background:var(--bg);"></div>
		</div>
		<div class="form-group" id="item-ai-section" style="display:none;">
			<label class="form-label">AI í”¼ë“œë°±</label>
			<div class="input" id="item-ai-feedback" style="background:var(--bg);font-size:13px;"></div>
		</div>
		<div class="form-group">
			<label class="form-label">ì ìˆ˜ ìˆ˜ì •</label>
			<input class="input" id="item-teacher-score" type="number" step="0.5" placeholder="ìˆ˜ì •í•  ì ìˆ˜">
		</div>
		<div class="form-group">
			<label class="form-label">í”¼ë“œë°±</label>
			<input class="input" id="item-teacher-feedback" type="text" placeholder="í”¼ë“œë°± ì…ë ¥">
		</div>
		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="saveItemEdit()">ì €ì¥</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('item-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<!-- ê³¼ì œ ë°°ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="assign-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-clipboard-list" style="color:var(--primary);"></i> ê³¼ì œ ë°°ì •</div>
		<div class="form-group">
			<label class="form-label">ê³¼ì œ ì œëª©</label>
			<input class="input" id="assign-title" placeholder="ì˜ˆ: ìˆ˜í•™ 42~45ìª½">
		</div>
		<div class="form-group">
			<label class="form-label">êµì¬ ì„ íƒ</label>
			<select class="input" id="assign-key">
				<option value="">ìë™ ê²€ìƒ‰ ëª¨ë“œ</option>
			</select>
		</div>
		<div class="form-group">
			<label class="form-label">í˜ì´ì§€ ë²”ìœ„</label>
			<input class="input" id="assign-pages" placeholder="ì˜ˆ: 42-45">
		</div>
		<div class="form-group">
			<label class="form-label">ë§ˆê°ì¼</label>
			<input class="input" id="assign-due" type="date">
		</div>
		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="createAssignment()">ë°°ì •</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('assign-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<!-- êµì¬ ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal-overlay" id="key-modal">
	<div class="modal-box">
		<div class="modal-title"><i class="fas fa-book" style="color:var(--primary);"></i> êµì¬ ë“±ë¡</div>

		<!-- êµì¬ ìœ í˜• ì„ íƒ -->
		<div class="form-group">
			<label class="form-label">êµì¬ ìœ í˜•</label>
			<div style="display:flex;gap:8px;">
				<button class="btn btn-sm" id="key-type-print" onclick="selectKeyType('print')"
					style="flex:1;padding:10px;border:2px solid var(--primary);background:var(--primary);color:#fff;border-radius:10px;font-size:13px;">
					<i class="fas fa-print"></i> í”„ë¦°íŠ¸ ê³¼ì œ
				</button>
				<button class="btn btn-sm" id="key-type-book" onclick="selectKeyType('book')"
					style="flex:1;padding:10px;border:2px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;font-size:13px;">
					<i class="fas fa-book-open"></i> ì‹œì¤‘ êµì¬
				</button>
			</div>
		</div>

		<div class="form-group">
			<label class="form-label">êµì¬ëª…</label>
			<input class="input" id="key-title" placeholder="ì˜ˆ: ìˆ˜í•™ ë¬¸ì œì§‘ A">
		</div>
		<div class="form-group">
			<label class="form-label">ê³¼ëª©</label>
			<input class="input" id="key-subject" placeholder="ì˜ˆ: ìˆ˜í•™">
		</div>
		<div class="form-group">
			<label class="form-label">êµì¬ PDF</label>
			<input class="input" id="key-pdf" type="file" accept=".pdf">
		</div>

		<!-- í”„ë¦°íŠ¸ ì•ˆë‚´ (ê¸°ë³¸ í‘œì‹œ) -->
		<div id="key-print-info" style="background:#f0f9ff;border-radius:10px;padding:12px;margin-bottom:12px;">
			<p style="font-size:12px;color:#0369a1;margin:0;">
				<i class="fas fa-magic" style="margin-right:4px;"></i>
				<b>í”„ë¦°íŠ¸ ê³¼ì œ</b>ëŠ” PDFë¥¼ ì˜¬ë¦¬ë©´ ìë™ìœ¼ë¡œ ì •ë‹µì„ ì°¾ìŠµë‹ˆë‹¤.<br>
				<span style="font-size:11px;color:#64748b;">êµ¬ì¡°: ë¬¸ì œ â†’ ë¹ ë¥¸ì •ë‹µ â†’ í•´ì„¤</span>
			</p>
		</div>

		<!-- ì‹œì¤‘ êµì¬ ì„¤ì • (ìˆ¨ê¹€) -->
		<div id="key-book-info" style="display:none;">
			<div style="background:#fefce8;border-radius:10px;padding:12px;margin-bottom:12px;">
				<p style="font-size:12px;color:#854d0e;margin:0 0 8px 0;">
					<i class="fas fa-lightbulb" style="margin-right:4px;"></i>
					<b>ì‹œì¤‘ êµì¬</b>ëŠ” ì •ë‹µ/í•´ì„¤ í˜ì´ì§€ë¥¼ ì§€ì •í•˜ë©´ ë¹ ë¥´ê³  ì •í™•í•©ë‹ˆë‹¤.<br>
					<span style="font-size:11px;color:#64748b;">ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ì •ë‹µ í˜ì´ì§€ë¥¼ ì°¾ìŠµë‹ˆë‹¤.</span>
				</p>
			</div>
			<div class="form-group">
				<label class="form-label">ì •ë‹µ/í•´ì„¤ ì‹œì‘ í˜ì´ì§€ <span style="color:var(--text-sec);font-weight:400;">(ì„ íƒ)</span></label>
				<div style="display:flex;gap:8px;align-items:center;">
					<input class="input" id="key-page-start" type="number" placeholder="ì˜ˆ: 180" style="flex:1;">
					<span style="color:var(--text-sec);">~</span>
					<input class="input" id="key-page-end" type="number" placeholder="ì˜ˆ: 210" style="flex:1;">
					<span style="font-size:12px;color:var(--text-sec);">í˜ì´ì§€</span>
				</div>
			</div>
		</div>

		<div class="form-group">
			<label class="form-label">ì˜ˆìƒ ë¬¸ì œ ìˆ˜ <span style="color:var(--text-sec);font-weight:400;">(ì„ íƒ)</span></label>
			<input class="input" id="key-total-hint" type="number" placeholder="ì˜ˆ: 30">
		</div>

		<div style="display:flex;gap:8px;margin-top:16px;">
			<button class="btn btn-primary" style="flex:1;" onclick="registerAnswerKey()">
				<i class="fas fa-upload" style="margin-right:4px;"></i> ë“±ë¡ ë° ì •ë‹µ ì¶”ì¶œ
			</button>
			<button class="btn btn-outline" style="flex:1;" onclick="closeModal('key-modal')">ì·¨ì†Œ</button>
		</div>
	</div>
</div>

<script>
// ============================================================
// ì„¤ì •
// ============================================================
const SUPABASE_URL = 'https://jzcrpdeomjmytfekcgqu.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_6X3mtsIpdMkLWgo9aUbZTg_ihtAA3cu';
const GRADING_SERVER_URL = localStorage.getItem('grading_server_url') || 'https://academymanager-production.up.railway.app';

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentTeacher = null;
let teacherList = [];
let currentResults = [];
let currentItems = [];
let currentResultId = null;
let currentFilter = 'all';

// ìº”ë²„ìŠ¤ ê´€ë ¨
let canvasTool = 'pen';
let canvasColor = '#ef4444';
let canvasPenSize = 3;
let canvasHistory = [];
let canvasRedoStack = [];
let isDrawing = false;

// ============================================================
// ì¸ì¦ (ì„ ìƒë‹˜ ì„ íƒ + ë¹„ë°€ë²ˆí˜¸)
// ============================================================
async function hashPin(pin) {
	const enc = new TextEncoder().encode(pin);
	const hash = await crypto.subtle.digest('SHA-256', enc);
	return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function loadTeacherList() {
	// 1ì°¨: ì±„ì  ì„œë²„ì—ì„œ ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ
	try {
		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 5000);
		const res = await fetch(`${GRADING_SERVER_URL}/api/teachers`, { signal: controller.signal });
		clearTimeout(timeoutId);
		if (res.ok) {
			const result = await res.json();
			teacherList = result.data || [];
			console.log('[ì±„ì ê´€ë¦¬] ì±„ì  ì„œë²„ì—ì„œ ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', teacherList.length, 'ëª…');
		}
	} catch (e) {
		console.warn('[ì±„ì ê´€ë¦¬] ì±„ì  ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', e.message);
	}

	// 2ì°¨ fallback: Supabase JS í´ë¼ì´ì–¸íŠ¸ë¡œ ì¡°íšŒ
	if (!teacherList || teacherList.length === 0) {
		try {
			const { data, error } = await db.from('teachers').select('*').order('created_at');
			if (!error && data && data.length > 0) {
				teacherList = data;
				console.log('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„ ìƒë‹˜ ë¡œë“œ ì„±ê³µ:', data.length, 'ëª…');
			} else {
				console.warn('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨ (RLS ê°€ëŠ¥ì„±):', error?.message);
			}
		} catch (e2) {
			console.warn('[ì±„ì ê´€ë¦¬] Supabase í´ë¼ì´ì–¸íŠ¸ ì‹¤íŒ¨:', e2.message);
		}
	}

	// 3ì°¨ fallback: Supabase REST API ì§ì ‘ í˜¸ì¶œ (RLS ìš°íšŒ ì‹œë„)
	if (!teacherList || teacherList.length === 0) {
		try {
			const res = await fetch(`${SUPABASE_URL}/rest/v1/teachers?select=*&order=created_at.asc`, {
				headers: {
					'apikey': SUPABASE_ANON_KEY,
					'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
					'Content-Type': 'application/json',
				}
			});
			if (res.ok) {
				const data = await res.json();
				if (data && data.length > 0) {
					teacherList = data;
					console.log('[ì±„ì ê´€ë¦¬] Supabase REST APIì—ì„œ ì„ ìƒë‹˜ ë¡œë“œ ì„±ê³µ:', data.length, 'ëª…');
				}
			}
		} catch (e3) {
			console.warn('[ì±„ì ê´€ë¦¬] Supabase REST API ì‹¤íŒ¨:', e3.message);
		}
	}

	// ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
	if (!teacherList || teacherList.length === 0) {
		console.error('[ì±„ì ê´€ë¦¬] ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ - ì±„ì  ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”');
		console.error('[ì±„ì ê´€ë¦¬] ë¡œì»¬ ì‹¤í–‰: localStorage.setItem("grading_server_url", "http://localhost:8000")');
	}

	const sel = document.getElementById('login-teacher-select');
	sel.innerHTML = '<option value="">ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
		teacherList.map(t => `<option value="${t.id}">${escapeHtml(t.name)}${t.phone ? ' (' + t.phone.slice(-4) + ')' : ''}</option>`).join('');
}

function onLoginTeacherSelected() {
	const tid = document.getElementById('login-teacher-select').value;
	document.getElementById('login-password-section').style.display = tid ? 'block' : 'none';
	document.getElementById('login-error').style.display = 'none';
	if (tid) document.getElementById('login-password').value = '';
}

async function handleLogin() {
	const tid = document.getElementById('login-teacher-select').value;
	if (!tid) { showToast('ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error'); return; }

	const teacher = teacherList.find(t => String(t.id) === String(tid));
	if (!teacher) { showToast('ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

	const password = document.getElementById('login-password').value.trim();
	if (!password) { showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

	const inputHash = await hashPin(password);
	if (inputHash !== teacher.pin_hash) {
		const errEl = document.getElementById('login-error');
		errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
		errEl.style.display = 'block';
		return;
	}

	currentTeacher = teacher;
	document.getElementById('login-error').style.display = 'none';
	showPage('main');
	loadAllData();
}

function handleLogout() {
	currentTeacher = null;
	currentResults = [];
	currentItems = [];
	currentResultId = null;
	showPage('login');
}

// ============================================================
// í˜ì´ì§€/íƒ­ ì „í™˜
// ============================================================
function showPage(page) {
	document.getElementById('page-login').style.display = page === 'login' ? 'flex' : 'none';
	document.getElementById('page-main').style.display = page === 'main' ? 'block' : 'none';
	document.getElementById('page-detail').style.display = page === 'detail' ? 'block' : 'none';
}

function switchMainTab(tab, e) {
	document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
	document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
	document.getElementById('tab-' + tab).style.display = 'block';
	const btn = e ? (e.target.closest('.tab-btn') || e.target) : null;
	if (btn) btn.classList.add('active');
}

function closeModal(id) {
	document.getElementById(id).classList.remove('show');
}

function showToast(msg, type = 'info') {
	const el = document.createElement('div');
	el.className = 'g-toast ' + type;
	el.textContent = msg;
	document.body.appendChild(el);
	setTimeout(() => el.remove(), 3000);
}

// ============================================================
// ë°ì´í„° ë¡œë“œ
// ============================================================
async function loadAllData() {
	await Promise.all([loadResults(), loadAssignments(), loadAnswerKeys(), loadStats()]);
}

async function loadResults() {
	if (!currentTeacher) return;
	try {
		const params = new URLSearchParams({ teacher_id: currentTeacher.owner_user_id });
		if (currentFilter !== 'all') params.append('status', currentFilter);
		const res = await fetch(`${GRADING_SERVER_URL}/api/results?${params}`);
		const result = await res.json();
		currentResults = result.data || [];
	} catch (e) {
		console.warn('ì±„ì  ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', e);
		currentResults = [];
	}
	renderResults();
}

function filterResults(filter) {
	currentFilter = filter;
	document.querySelectorAll('[id^="filter-"]').forEach(el => el.classList.remove('btn-primary'));
	document.getElementById('filter-' + (filter === 'all' ? 'all' : filter === 'review_needed' ? 'review' : 'confirmed')).classList.add('btn-primary');
	loadResults();
}

function renderResults() {
	const el = document.getElementById('results-list');
	if (!currentResults.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}
	el.innerHTML = currentResults.map(r => {
		const student = r.students || {};
		const statusCls = r.status === 'confirmed' ? 'badge-confirmed' : r.status === 'review_needed' ? 'badge-review' : 'badge-grading';
		const statusText = r.status === 'confirmed' ? 'í™•ì •' : r.status === 'review_needed' ? 'ê²€í†  í•„ìš”' : 'ì±„ì  ì¤‘';
		const iconBg = r.status === 'confirmed' ? 'rgba(34,197,94,0.15)' : r.status === 'review_needed' ? 'rgba(234,179,8,0.15)' : 'rgba(129,140,248,0.15)';
		const icon = r.status === 'confirmed' ? 'âœ…' : r.status === 'review_needed' ? 'âš ï¸' : 'â³';
		const date = new Date(r.created_at).toLocaleDateString('ko-KR');
		const unanswered = r.unanswered_count || 0;
		const unansweredTag = unanswered > 0 ? ` ğŸ“${unanswered}` : '';
		const pageInfo = r.page_info ? `<div style="font-size:11px;color:var(--teal);margin-top:2px;">${escapeHtml(r.page_info)}</div>` : '';
		return `<div class="list-item" style="position:relative;">
			<div style="display:flex;align-items:center;gap:12px;flex:1;cursor:pointer;" onclick="openDetail(${r.id})">
				<div class="list-item-icon" style="background:${iconBg};">${icon}</div>
				<div class="list-item-info">
					<div class="list-item-title">${escapeHtml(student.name || '?')} - ${r.total_score}/${r.max_score}ì </div>
					<div class="list-item-sub">â­•${r.correct_count} âœ˜${r.wrong_count} â“${r.uncertain_count}${unansweredTag} Â· ${date}</div>
					${pageInfo}
				</div>
				<span class="list-item-badge ${statusCls}">${statusText}</span>
			</div>
			<button onclick="event.stopPropagation();deleteResult(${r.id},'${escapeHtml(student.name || '?')}')" title="ì‚­ì œ"
				style="background:none;border:none;color:var(--red,#ef4444);cursor:pointer;padding:8px;font-size:14px;opacity:0.4;transition:opacity 0.2s;margin-left:4px;"
				onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.4'">
				<i class="fas fa-trash-alt"></i>
			</button>
		</div>`;
	}).join('');
}

// ============================================================
// ì±„ì  ìƒì„¸
// ============================================================
async function openDetail(resultId) {
	currentResultId = resultId;
	const result = currentResults.find(r => r.id === resultId);
	if (!result) return;

	const detailTitle = (result.students?.name || '?') + ' ì±„ì  ìƒì„¸';
	const pageLabel = result.page_info ? ` (${result.page_info})` : '';
	document.getElementById('detail-title').textContent = detailTitle;
	document.getElementById('detail-score').textContent = result.total_score + '/' + result.max_score;
	document.getElementById('detail-correct').textContent = result.correct_count;
	document.getElementById('detail-wrong').textContent = result.wrong_count;
	document.getElementById('detail-uncertain').textContent = result.uncertain_count;
	document.getElementById('detail-total').textContent = result.total_questions;
	// ë¯¸í’€ì´ í‘œì‹œ
	const unansweredEl = document.getElementById('detail-unanswered');
	if (unansweredEl) unansweredEl.textContent = result.unanswered_count || 0;
	// í˜ì´ì§€ ì •ë³´ í‘œì‹œ
	const pageInfoEl = document.getElementById('detail-page-info');
	if (pageInfoEl) {
		pageInfoEl.textContent = result.page_info || '';
		pageInfoEl.style.display = result.page_info ? 'block' : 'none';
	}
	document.getElementById('detail-memo').value = result.teacher_memo || '';
	document.getElementById('detail-confirm-btn').style.display = result.status === 'confirmed' ? 'none' : 'inline-flex';

	// ì±„ì  ì´ë¯¸ì§€
	const imgUrls = result.teacher_graded_image_urls || result.central_graded_image_urls || [];
	if (imgUrls.length > 0) {
		document.getElementById('graded-image').src = imgUrls[0];
	}

	// ë¬¸í•­ë³„ ë¡œë“œ
	try {
		const itemsRes = await fetch(`${GRADING_SERVER_URL}/api/results/${resultId}/items`);
		const itemsResult = await itemsRes.json();
		currentItems = itemsResult.data || [];
	} catch (e) {
		console.warn('ë¬¸í•­ ë¡œë“œ ì‹¤íŒ¨:', e);
		currentItems = [];
	}
	renderQuestionGrid();

	showPage('detail');
}

function renderQuestionGrid() {
	const grid = document.getElementById('detail-grid');
	grid.innerHTML = currentItems.map(item => {
		const isUnanswered = item.student_answer === '(ë¯¸í’€ì´)' || item.ai_feedback === 'í•™ìƒì´ í’€ì§€ ì•Šì€ ë¬¸ì œ';
		let cls, titleText;
		if (isUnanswered) {
			cls = 'q-unanswered';
			titleText = `ë¬¸ì œ ${item.question_number} (ë¯¸í’€ì´)`;
		} else if (item.is_correct === true) {
			cls = 'q-correct';
			titleText = `ë¬¸ì œ ${item.question_number}`;
		} else if (item.is_correct === false) {
			cls = 'q-wrong';
			titleText = `ë¬¸ì œ ${item.question_number}`;
		} else {
			cls = 'q-uncertain';
			titleText = `ë¬¸ì œ ${item.question_number} (í™•ì¸í•„ìš”)`;
		}
		return `<div class="q-cell ${cls}" onclick="openItemEdit(${item.id})" title="${titleText}">${item.question_number}</div>`;
	}).join('');
}

function openItemEdit(itemId) {
	const item = currentItems.find(i => i.id === itemId);
	if (!item) return;

	document.getElementById('item-modal-title').textContent = `${item.question_number}ë²ˆ ë¬¸í•­`;
	document.getElementById('item-student-answer').textContent = item.student_answer || '(ì¸ì‹ ì‹¤íŒ¨)';
	document.getElementById('item-correct-answer').textContent = item.correct_answer || '-';
	document.getElementById('item-teacher-score').value = item.teacher_score ?? item.ai_score ?? '';
	document.getElementById('item-teacher-feedback').value = item.teacher_feedback || '';

	const aiSection = document.getElementById('item-ai-section');
	if (item.question_type === 'essay' && item.ai_feedback) {
		aiSection.style.display = 'block';
		document.getElementById('item-ai-feedback').textContent = item.ai_feedback;
	} else {
		aiSection.style.display = 'none';
	}

	document.getElementById('item-modal').dataset.itemId = itemId;
	document.getElementById('item-modal').classList.add('show');
}

async function saveItemEdit() {
	const itemId = parseInt(document.getElementById('item-modal').dataset.itemId);
	const score = document.getElementById('item-teacher-score').value;
	const feedback = document.getElementById('item-teacher-feedback').value;

	const updates = {};
	if (score !== '') updates.teacher_score = parseFloat(score);
	if (feedback) updates.teacher_feedback = feedback;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/items/${itemId}`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(updates),
		});
		if (!res.ok) return showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}

	showToast('ì €ì¥ ì™„ë£Œ', 'success');
	closeModal('item-modal');

	// ìƒˆë¡œê³ ì¹¨
	try {
		const itemsRes = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/items`);
		const itemsResult = await itemsRes.json();
		currentItems = itemsResult.data || [];
	} catch (e) {
		currentItems = [];
	}
	renderQuestionGrid();
}

async function confirmResult() {
	if (!currentResultId) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/confirm`, { method: 'PUT' });
		const result = await res.json();
		if (!result.data) return showToast('í™•ì • ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast('ì±„ì  ê²°ê³¼ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
	document.getElementById('detail-confirm-btn').style.display = 'none';
	loadResults();
}

async function deleteResult(resultId, studentName) {
	if (!confirm(`"${studentName}" ì±„ì  ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${resultId}`, { method: 'DELETE' });
		const result = await res.json();
		if (result.success) {
			showToast('ì±„ì  ê²°ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
			loadResults();
		} else {
			showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.message || ''), 'error');
		}
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// ê³¼ì œ ë°°ì •
// ============================================================
async function loadAssignments() {
	if (!currentTeacher) return;
	let data = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/assignments?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		data = result.data || [];
	} catch (e) {
		console.warn('ê³¼ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
	}
	const el = document.getElementById('assignments-list');
	if (!data?.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>ë°°ì •ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}
	el.innerHTML = data.map(a => {
		const key = a.answer_keys;
		return `<div class="list-item">
			<div class="list-item-icon" style="background:rgba(129,140,248,0.15);">ğŸ“‹</div>
			<div class="list-item-info">
				<div class="list-item-title">${escapeHtml(a.title)}</div>
				<div class="list-item-sub">${key ? key.title + ' Â· ' + (key.subject || '') : 'ìë™ ê²€ìƒ‰'} Â· ${a.page_range || ''}</div>
			</div>
			<span style="font-size:12px;color:var(--text-sec);">${a.due_date || ''}</span>
		</div>`;
	}).join('');
}

async function showAssignModal() {
	// êµì¬ ëª©ë¡ ë¡œë“œ (ì„œë²„ API)
	let keys = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		keys = result.data || [];
	} catch (e) {}
	const sel = document.getElementById('assign-key');
	sel.innerHTML = '<option value="">ìë™ ê²€ìƒ‰ ëª¨ë“œ</option>' + keys.map(k => `<option value="${k.id}">${k.title} (${k.subject || ''})</option>`).join('');
	document.getElementById('assign-modal').classList.add('show');
}

async function createAssignment() {
	const title = document.getElementById('assign-title').value.trim();
	if (!title) return showToast('ê³¼ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

	const keyId = document.getElementById('assign-key').value;
	try {
		const formData = new FormData();
		formData.append('teacher_id', currentTeacher.owner_user_id);
		formData.append('title', title);
		if (keyId) formData.append('answer_key_id', keyId);
		formData.append('page_range', document.getElementById('assign-pages').value);
		const due = document.getElementById('assign-due').value;
		if (due) formData.append('due_date', due);
		formData.append('mode', keyId ? 'assigned' : 'auto_search');
		const res = await fetch(`${GRADING_SERVER_URL}/api/assignments`, { method: 'POST', body: formData });
		if (!res.ok) return showToast('ë°°ì • ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast('ê³¼ì œê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
	closeModal('assign-modal');
	loadAssignments();
}

// ============================================================
// êµì¬ ê´€ë¦¬
// ============================================================
async function loadAnswerKeys() {
	if (!currentTeacher) return;
	let data = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		data = result.data || [];
	} catch (e) {
		console.warn('êµì¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
	}
	const el = document.getElementById('keys-list');
	if (!data?.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><p>ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}
	el.innerHTML = data.map(k => `<div class="list-item" style="position:relative;">
		<div class="list-item-icon" style="background:rgba(20,184,166,0.15);">ğŸ“š</div>
		<div class="list-item-info" style="flex:1;">
			<div class="list-item-title">${escapeHtml(k.title)}</div>
			<div class="list-item-sub">${k.subject || 'ê³¼ëª© ë¯¸ì •'} Â· ${k.total_questions}ë¬¸ì œ Â· ${k.parsed ? 'âœ… íŒŒì‹±ì™„ë£Œ' : 'â³ íŒŒì‹±ì¤‘'}</div>
		</div>
		<button onclick="deleteAnswerKey(${k.id}, '${escapeHtml(k.title)}')" title="ì‚­ì œ"
			style="background:none;border:none;color:var(--red,#ef4444);cursor:pointer;padding:8px;font-size:16px;opacity:0.6;transition:opacity 0.2s;"
			onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
			<i class="fas fa-trash-alt"></i>
		</button>
	</div>`).join('');

	// ê³¼ì œ ë°°ì •ìš© ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
	const sel = document.getElementById('assign-key');
	if (sel) {
		sel.innerHTML = '<option value="">ìë™ ê²€ìƒ‰ ëª¨ë“œ</option>' + data.map(k => `<option value="${k.id}">${k.title} (${k.subject || ''})</option>`).join('');
	}
}

async function deleteAnswerKey(id, title) {
	if (!confirm(`"${title}" êµì¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ êµì¬ì˜ ì •ë‹µ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys/${id}?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`, {
			method: 'DELETE',
		});
		const result = await res.json();
		if (result.success) {
			showToast('êµì¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
			loadAnswerKeys();
		} else {
			showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.message || ''), 'error');
		}
	} catch (e) {
		showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

let selectedKeyType = 'print';

function selectKeyType(type) {
	selectedKeyType = type;
	const printBtn = document.getElementById('key-type-print');
	const bookBtn = document.getElementById('key-type-book');
	const printInfo = document.getElementById('key-print-info');
	const bookInfo = document.getElementById('key-book-info');

	if (type === 'print') {
		printBtn.style.background = 'var(--primary)';
		printBtn.style.color = '#fff';
		printBtn.style.borderColor = 'var(--primary)';
		bookBtn.style.background = 'var(--card)';
		bookBtn.style.color = 'var(--text)';
		bookBtn.style.borderColor = 'var(--border)';
		printInfo.style.display = '';
		bookInfo.style.display = 'none';
	} else {
		bookBtn.style.background = 'var(--primary)';
		bookBtn.style.color = '#fff';
		bookBtn.style.borderColor = 'var(--primary)';
		printBtn.style.background = 'var(--card)';
		printBtn.style.color = 'var(--text)';
		printBtn.style.borderColor = 'var(--border)';
		printInfo.style.display = 'none';
		bookInfo.style.display = '';
	}
}

function showAddKeyModal() {
	selectedKeyType = 'print';
	selectKeyType('print');
	document.getElementById('key-title').value = '';
	document.getElementById('key-subject').value = '';
	document.getElementById('key-pdf').value = '';
	document.getElementById('key-total-hint').value = '';
	const ps = document.getElementById('key-page-start');
	const pe = document.getElementById('key-page-end');
	if (ps) ps.value = '';
	if (pe) pe.value = '';
	document.getElementById('key-modal').classList.add('show');
}

let isRegistering = false;
async function registerAnswerKey() {
	if (isRegistering) return;
	const title = document.getElementById('key-title').value.trim();
	const subject = document.getElementById('key-subject').value.trim();
	const pdfInput = document.getElementById('key-pdf');
	const totalHint = document.getElementById('key-total-hint').value.trim();

	// ì‹œì¤‘ êµì¬: í˜ì´ì§€ ë²”ìœ„ ì¡°í•©
	let pageRange = '';
	if (selectedKeyType === 'book') {
		const ps = document.getElementById('key-page-start').value.trim();
		const pe = document.getElementById('key-page-end').value.trim();
		if (ps && pe) {
			pageRange = `${ps}-${pe}`;
		} else if (ps) {
			pageRange = ps;
		}
	}

	if (!title) return showToast('êµì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

	if (pdfInput.files.length > 0) {
		const formData = new FormData();
		formData.append('teacher_id', currentTeacher.owner_user_id);
		formData.append('title', title);
		formData.append('subject', subject);
		formData.append('pdf_file', pdfInput.files[0]);
		if (pageRange) formData.append('answer_page_range', pageRange);
		if (totalHint) formData.append('total_hint', totalHint);

		isRegistering = true;
		showToast('ì •ë‹µ ì¶”ì¶œ ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)', 'info');

		try {
			const res = await fetch(GRADING_SERVER_URL + '/api/answer-keys/parse', {
				method: 'POST',
				body: formData,
			});
			const result = await res.json();

			if (result.data) {
				showToast(`êµì¬ ë“±ë¡ ì™„ë£Œ! ${result.parsed_result?.total || 0}ë¬¸ì œ ì¶”ì¶œ`, 'success');
				closeModal('key-modal');
				loadAnswerKeys();
			} else {
				showToast('ë“±ë¡ ì‹¤íŒ¨', 'error');
			}
		} catch (e) {
			showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
		} finally {
			isRegistering = false;
		}
	} else {
		// PDF ì—†ì´ ìˆ˜ë™ ë“±ë¡ (ì„œë²„ API)
		try {
			const formData = new FormData();
			formData.append('teacher_id', currentTeacher.owner_user_id);
			formData.append('title', title);
			formData.append('subject', subject);
			const res = await fetch(`${GRADING_SERVER_URL}/api/answer-keys/parse`, { method: 'POST', body: formData });
			if (!res.ok) return showToast('ë“±ë¡ ì‹¤íŒ¨', 'error');
		} catch (e) {
			return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
		}
		showToast('êµì¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ (ì •ë‹µì€ ë‚˜ì¤‘ì— ì¶”ê°€)', 'success');
		closeModal('key-modal');
		loadAnswerKeys();
	}
}

async function scanDrivePDFs() {
	showToast('ì¤‘ì•™ ë“œë¼ì´ë¸Œì—ì„œ ìŠ¤ìº” ì¤‘...', 'info');
	try {
		const res = await fetch(GRADING_SERVER_URL + '/api/answer-keys/drive-pdfs');
		const result = await res.json();
		const pdfs = result.data || [];
		showToast(`ìˆ™ì œ ì±„ì  ìë£Œ í´ë”ì—ì„œ ${pdfs.length}ê°œ PDF ë°œê²¬`, pdfs.length > 0 ? 'success' : 'info');
	} catch (e) {
		showToast('ìŠ¤ìº” ì‹¤íŒ¨: ' + e.message, 'error');
	}
}

// ============================================================
// í†µê³„
// ============================================================
async function loadStats() {
	if (!currentTeacher) return;
	const el = document.getElementById('stats-content');
	let results = [];
	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/stats?teacher_id=${encodeURIComponent(currentTeacher.owner_user_id)}`);
		const result = await res.json();
		results = result.data || [];
	} catch (e) {
		console.warn('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', e);
	}

	if (!results?.length) {
		el.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>í™•ì •ëœ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
		return;
	}

	const avgScore = results.reduce((sum, r) => sum + (r.total_score || 0), 0) / results.length;
	const totalGraded = results.length;

	// í•™ìƒë³„ í‰ê· 
	const studentMap = {};
	results.forEach(r => {
		const name = r.students?.name || '?';
		if (!studentMap[name]) studentMap[name] = [];
		studentMap[name].push(r.total_score || 0);
	});

	const studentStats = Object.entries(studentMap).map(([name, scores]) => ({
		name, avg: Math.round(scores.reduce((a, b) => a + b, 0) / scores.length * 10) / 10, count: scores.length
	})).sort((a, b) => b.avg - a.avg);

	el.innerHTML = `
		<div class="card">
			<div class="card-title"><i class="fas fa-chart-pie"></i> ì „ì²´ í†µê³„</div>
			<div class="stat-row">
				<div class="stat-item"><div class="stat-num" style="color:var(--primary);">${avgScore.toFixed(1)}</div><div class="stat-label">í‰ê·  ì ìˆ˜</div></div>
				<div class="stat-item"><div class="stat-num" style="color:var(--green);">${totalGraded}</div><div class="stat-label">ì±„ì  ì™„ë£Œ</div></div>
			</div>
		</div>
		<div class="card">
			<div class="card-title"><i class="fas fa-ranking-star"></i> í•™ìƒë³„ í‰ê· </div>
			${studentStats.map((s, i) => `<div class="list-item">
				<div class="list-item-icon" style="background:rgba(129,140,248,0.15);font-size:14px;font-weight:700;">${i + 1}</div>
				<div class="list-item-info">
					<div class="list-item-title">${escapeHtml(s.name)}</div>
					<div class="list-item-sub">${s.count}íšŒ ì±„ì </div>
				</div>
				<span style="font-size:16px;font-weight:700;color:var(--primary);">${s.avg}ì </span>
			</div>`).join('')}
		</div>
	`;
}

// ============================================================
// ìº”ë²„ìŠ¤ (í•„ê¸° ë„êµ¬)
// ============================================================
function initCanvas() {
	const img = document.getElementById('graded-image');
	const canvas = document.getElementById('annotation-canvas');
	canvas.width = img.naturalWidth;
	canvas.height = img.naturalHeight;

	const ctx = canvas.getContext('2d');
	canvasHistory = [];
	canvasRedoStack = [];

	canvas.addEventListener('pointerdown', startDraw);
	canvas.addEventListener('pointermove', draw);
	canvas.addEventListener('pointerup', endDraw);
	canvas.addEventListener('pointerleave', endDraw);
}

function startDraw(e) {
	isDrawing = true;
	const { x, y } = getCanvasPos(e);

	if (canvasTool === 'text') {
		const text = prompt('í…ìŠ¤íŠ¸ ì…ë ¥:');
		if (text) {
			const ctx = e.target.getContext('2d');
			ctx.font = `${canvasPenSize * 6}px Pretendard, sans-serif`;
			ctx.fillStyle = canvasColor;
			ctx.fillText(text, x, y);
			saveCanvasState();
		}
		isDrawing = false;
		return;
	}

	if (canvasTool === 'circle') {
		const ctx = e.target.getContext('2d');
		ctx.beginPath();
		ctx.arc(x, y, canvasPenSize * 8, 0, Math.PI * 2);
		ctx.strokeStyle = canvasColor;
		ctx.lineWidth = canvasPenSize;
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	if (canvasTool === 'check') {
		const ctx = e.target.getContext('2d');
		const s = canvasPenSize * 6;
		ctx.strokeStyle = '#22c55e';
		ctx.lineWidth = canvasPenSize + 1;
		ctx.beginPath();
		ctx.moveTo(x - s, y); ctx.lineTo(x - s/3, y + s); ctx.lineTo(x + s, y - s);
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	if (canvasTool === 'xmark') {
		const ctx = e.target.getContext('2d');
		const s = canvasPenSize * 6;
		ctx.strokeStyle = '#ef4444';
		ctx.lineWidth = canvasPenSize + 1;
		ctx.beginPath();
		ctx.moveTo(x - s, y - s); ctx.lineTo(x + s, y + s);
		ctx.moveTo(x + s, y - s); ctx.lineTo(x - s, y + s);
		ctx.stroke();
		saveCanvasState();
		isDrawing = false;
		return;
	}

	const ctx = e.target.getContext('2d');
	ctx.beginPath();
	ctx.moveTo(x, y);
}

function draw(e) {
	if (!isDrawing) return;
	const { x, y } = getCanvasPos(e);
	const ctx = e.target.getContext('2d');

	if (canvasTool === 'eraser') {
		ctx.globalCompositeOperation = 'destination-out';
		ctx.lineWidth = canvasPenSize * 5;
	} else if (canvasTool === 'highlighter') {
		ctx.globalCompositeOperation = 'source-over';
		ctx.strokeStyle = canvasColor + '40';
		ctx.lineWidth = canvasPenSize * 5;
	} else {
		ctx.globalCompositeOperation = 'source-over';
		ctx.strokeStyle = canvasColor;
		ctx.lineWidth = canvasPenSize;
	}

	ctx.lineCap = 'round';
	ctx.lineJoin = 'round';
	ctx.lineTo(x, y);
	ctx.stroke();
}

function endDraw(e) {
	if (isDrawing) {
		isDrawing = false;
		saveCanvasState();
	}
}

function getCanvasPos(e) {
	const canvas = e.target;
	const rect = canvas.getBoundingClientRect();
	return {
		x: (e.clientX - rect.left) * (canvas.width / rect.width),
		y: (e.clientY - rect.top) * (canvas.height / rect.height),
	};
}

function saveCanvasState() {
	const canvas = document.getElementById('annotation-canvas');
	canvasHistory.push(canvas.toDataURL());
	canvasRedoStack = [];
}

function undoCanvas() {
	if (!canvasHistory.length) return;
	const canvas = document.getElementById('annotation-canvas');
	const ctx = canvas.getContext('2d');
	canvasRedoStack.push(canvasHistory.pop());
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	if (canvasHistory.length > 0) {
		const img = new Image();
		img.onload = () => ctx.drawImage(img, 0, 0);
		img.src = canvasHistory[canvasHistory.length - 1];
	}
}

function redoCanvas() {
	if (!canvasRedoStack.length) return;
	const canvas = document.getElementById('annotation-canvas');
	const ctx = canvas.getContext('2d');
	const state = canvasRedoStack.pop();
	canvasHistory.push(state);
	const img = new Image();
	img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
	img.src = state;
}

function setTool(tool) {
	canvasTool = tool;
	document.querySelectorAll('.tool-btn[data-tool]').forEach(el => el.classList.toggle('active', el.dataset.tool === tool));
}

function setColor(color) {
	canvasColor = color;
	document.querySelectorAll('.color-dot').forEach(el => el.classList.toggle('active', el.style.background === color));
}

function setPenSize(size) { canvasPenSize = parseInt(size); }

async function saveAnnotations() {
	if (!currentResultId) return;
	const canvas = document.getElementById('annotation-canvas');
	const annotationData = canvas.toDataURL();
	const memo = document.getElementById('detail-memo').value;

	try {
		const res = await fetch(`${GRADING_SERVER_URL}/api/results/${currentResultId}/annotations`, {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
				teacher_annotations: [{ type: 'canvas', data: annotationData }],
				teacher_memo: memo,
				updated_at: new Date().toISOString(),
			}),
		});
		if (!res.ok) return showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
	} catch (e) {
		return showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
	}
	showToast('í•„ê¸° ë° ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ============================================================
// ìœ í‹¸ë¦¬í‹°
// ============================================================
function escapeHtml(str) {
	if (typeof str !== 'string') return str;
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ============================================================
// ì´ˆê¸°í™”
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
	await loadTeacherList();
});
</script>
</body>
</html>
